<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hoja de Personaje RPG - Avanzada y Responsive</title>
  <style>
    /* Global Styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      background: #f0f2f5;
      font-family: 'Segoe UI', Roboto, Arial, sans-serif;
      color: #2c3e50;
      line-height: 1.6;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    h1, h2, h3 {
      text-align: center;
      margin-bottom: 15px;
    }
    /* Card Component */
    .card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      text-align: center;
      margin: 20px auto;
      max-width: 900px;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }
    /* Form Elements */
    label {
      font-weight: bold;
      margin-bottom: 5px;
      display: block;
      text-align: center;
    }
    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 90%;
      max-width: 300px;
      padding: 10px;
      margin: 0 auto 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      display: block;
    }
    /* Grid Layout */
    .grid {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }
    .half {
      flex: 1 1 45%;
      min-width: 280px;
    }
    .stats-grid {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      gap: 20px;
      margin-top: 15px;
    }
    .stat {
      background: #f7f9fc;
      border-radius: 8px;
      padding: 15px 20px;
      min-width: 150px;
      text-align: center;
      font-size: 1.1em;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    td[data-element] {
      height: 50px;
      width: 80px;
      color: white;
      font-weight: bold;
      position: relative;
      text-align: center;
      border-radius: 6px;
      cursor: pointer;
      transition: opacity 0.3s;
    }
    td[data-element].active {
      opacity: 1;
    }
    td[data-element]:not(.active) {
      opacity: 0.5;
    }
    td[data-element="fire"]     { background: linear-gradient(145deg, #ff4d4d, #cc0000); }
    td[data-element="air"]      { background: linear-gradient(145deg, #e6e6e6, #cccccc); }
    td[data-element="water"]    { background: linear-gradient(145deg, #4d94ff, #0052cc); }
    td[data-element="electric"] { background: linear-gradient(145deg, #ffff4d, #cccc00); }
    td[data-element="earth"]    { background: linear-gradient(145deg, #994d00, #663300); }
    td[data-element="light"]    { background: linear-gradient(145deg, #ffff99, #ffcc00); }
    td[data-element="dark"]     { background: linear-gradient(145deg, #4d4d4d, #1a1a1a); }
    small {
      display: block;
      text-align: center;
      color: #777;
    }
    /* Buttons */
    .btn {
      background: #2196F3;
      color: #fff;
      border: none;
      padding: 10px 18px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
      font-size: 0.95em;
      transition: background 0.3s;
    }
    .btn:hover {
      background: #1976D2;
    }
    /* Item List */
    .item-list {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 15px;
      background: #f9f9f9;
      min-height: 80px;
      max-width: 800px;
      margin: 0 auto;
    }
    .item {
      margin-bottom: 10px;
      padding: 15px;
      border-radius: 8px;
      transition: transform 0.2s;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .item-header {
      text-align: center;
      font-size: 1.2em;
      font-weight: bold;
    }
    .item-stats {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 5px 0;
    }
    .item-stat {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .item-description {
      text-align: justify;
      margin: 5px 0;
      padding: 0 10px;
    }
    .item-formula {
      text-align: center;
      font-family: monospace;
      padding: 5px;
      background: rgba(0,0,0,0.1);
      border-radius: 4px;
      cursor: pointer;
    }
    .item-formula:hover {
      background: rgba(0,0,0,0.15);
    }
    .item-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 5px;
    }
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: white;
      border-radius: 8px;
      padding: 20px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      cursor: pointer;
    }
    /* Fórmula Buttons */
    .formula-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 15px 0;
      justify-content: center;
    }
    .formula-btn {
      background: #2196F3;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.3s ease;
    }
    .formula-btn:hover {
      background: #1976D2;
      transform: translateY(-2px);
    }
    /* Stats Input */
    .stats-input {
      text-align: center;
      margin: 15px 0;
    }
    /* Responsive Media Queries */
    @media (max-width: 600px) {
      input[type="text"],
      input[type="number"],
      select,
      textarea {
        max-width: 90%;
      }
      .grid {
        flex-direction: column;
        align-items: center;
      }
      .half {
        width: 100%;
      }
      .stats-grid {
        flex-direction: column;
        align-items: center;
      }
      .stat {
        width: 90%;
        margin-bottom: 10px;
      }
    }
    /* Custom Popup Styles */
    .custom-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      z-index: 10000;
      min-width: 300px;
      text-align: center;
      animation: popupFadeIn 0.3s;
    }
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
    }
    @keyframes popupFadeIn {
      from {
        opacity: 0;
        transform: translate(-50%, -60%);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%);
      }
    }
    .popup-content {
      margin: 20px 0;
    }
    .popup-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    .formula-card {
      background: #f5f5f5;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }
    .formula-card h4 {
      color: #2196F3;
      margin: 0 0 10px 0;
    }
    .formula-result {
      font-family: monospace;
      background: #fff;
      padding: 10px;
      border-radius: 4px;
      border-left: 4px solid #2196F3;
    }
    .modal-form {
      padding: 20px;
    }
    .stat-edit-group {
      margin-bottom: 20px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 8px;
    }
    .stat-edit-group label {
      display: block;
      font-weight: bold;
      color: #34495e;
      margin-bottom: 8px;
    }
    .stat-input-pair {
      display: flex;
      gap: 10px;
      margin-top: 5px;
    }
    .stat-input-pair input {
      width: 45%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .stat-edit-group input[type="number"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .formula-section {
      margin-top: 15px;
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 8px;
      background: #f9f9f9;
    }
    .formula-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      justify-content: flex-start;
    }
    .formula-btn {
      background: #2196F3;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.2s;
    }
    .formula-btn:hover {
      background: #1976D2;
      transform: translateY(-2px);
    }
    /* Añadir estos estilos */
    .combat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 20px 0;
      padding: 15px;
    }

    .combat-section {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .combat-section h3 {
      color: #34495e;
      margin-bottom: 10px;
    }

    .combat-section input {
      width: 80%;
      margin-bottom: 10px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .equipment-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .equipment-slot {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .equipment-slot.empty {
      background: #eee;
      border: 2px dashed #ccc;
    }

    .stat-edit-group {
      margin-bottom: 20px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 8px;
    }

    .stat-edit-group label {
      display: block;
      font-weight: bold;
      color: #34495e;
      margin-bottom: 8px;
    }

    .stat-input-pair {
      display: flex;
      gap: 10px;
      margin-top: 5px;
    }

    .stat-input-pair input {
      width: 45%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .stat-edit-group input[type="number"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .actions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 15px;
      padding: 10px;
    }
    .action-btn {
      background: #34495e;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .action-btn:hover:not(:disabled) {
      background: #2c3e50;
      transform: translateY(-2px);
    }
    .action-btn:disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }
    /* Responsive Styles */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .card {
        padding: 15px;
        margin: 10px auto;
      }
      
      .grid {
        gap: 10px;
      }
      
      .stats-grid {
        gap: 10px;
      }
      
      .stat {
        min-width: unset;
        width: 100%;
        font-size: 0.95em;
      }
      
      table {
        font-size: 0.9em;
      }
      
      td[data-element] {
        height: 40px;
        width: 60px;
      }
      
      .combat-grid {
        grid-template-columns: 1fr;
      }
      
      .actions-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .item {
        padding: 10px;
      }
      
      .item-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        justify-content: center;
      }
      
      .btn {
        padding: 8px 12px;
        font-size: 0.9em;
      }
      
      .modal-content {
        width: 95%;
        padding: 15px;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.5em;
      }
      
      h2 {
        font-size: 1.3em;
      }
      
      .actions-grid {
        grid-template-columns: 1fr;
      }
      
      .combat-section input {
        width: 100%;
      }
      
      .item-buttons {
        flex-direction: column;
      }
      
      table {
        font-size: 0.8em;
      }
      
      td[data-element] {
        height: 35px;
        width: 50px;
      }
    }

    /* Estilos para rarezas */
    .item[data-rarity="intrinseca"] {
        background: linear-gradient(145deg, #808080, #696969);
        border: 1px solid #404040;
        color: #000000;
    }

    .item[data-rarity="comun"] {
        background: linear-gradient(145deg, #4CAF50, #45a049);
        border: 1px solid #2e7d32;
        color: #000000;
    }

    .item[data-rarity="epica"] {
        background: linear-gradient(145deg, #673AB7, #5E35B1);
        border: 1px solid #4A148C;
        color: #000000;
    }

    .item[data-rarity="legendario"] {
        background: linear-gradient(145deg, #FFD700, #FFC400);
        border: 2px solid #B8860B;
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        color: #000000;
    }

    .item[data-rarity="mitico"] {
        background: linear-gradient(145deg, #FF0000, #CC0000);
        border: 2px solid #000000;
        box-shadow: 0 0 15px rgba(255, 0, 0, 0.3);
        color: #FFD700;
        text-shadow: 1px 1px 1px #000000;
    }

    .item[data-rarity="genesis"] {
        background: linear-gradient(45deg, #00BCD4, #4CAF50);
        border: 2px solid #000000;
        box-shadow: 0 0 20px rgba(0, 188, 212, 0.4);
        color: #FFD700;
        text-shadow: 1px 1px 1px #000000;
    }

    /* Asegurarse que los encabezados mantengan el color correcto */
    .item[data-rarity="intrinseca"] .item-header,
    .item[data-rarity="comun"] .item-header,
    .item[data-rarity="epica"] .item-header {
        color: #000000;
    }

    .item[data-rarity="mitico"] .item-header,
    .item[data-rarity="genesis"] .item-header {
        color: #FFD700;
        text-shadow: 1px 1px 1px #000000;
    }

    .item[data-rarity="legendario"] .item-header {
        color: #000000;
    }

    .formula-input {
        width: 100%;
        padding: 8px;
        margin: 10px 0;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-family: monospace;
    }

    .formula-categories {
        margin-top: 15px;
        padding: 10px;
        background: #f5f5f5;
        border-radius: 8px;
    }

    .formula-category {
        margin-bottom: 15px;
    }

    .formula-category h4 {
        color: #2196F3;
        margin-bottom: 8px;
    }

    .formula-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
    }

    .custom-popup .popup-content {
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Datos del Personaje -->
    <div class="card">
      <h1>Hoja de Personaje RPG</h1>
      <div class="grid">
        <div class="half">
          <label for="charName">Nombre</label>
          <input type="text" id="charName" placeholder="Nombre del personaje">
          <label for="charRace">Raza</label>
          <input type="text" id="charRace" placeholder="Raza del personaje">
          <label for="charLang">Idiomas</label>
          <input type="text" id="charLang" placeholder="Ej: Español, Inglés">
          <label for="charPerso">Personalidad</label>
          <input type="text" id="charPerso" placeholder="Personalidad">
        </div>
        <div class="half">
          <label>Imagen</label>
          <div id="imgContainer" style="width:90%; height:220px; border:2px dashed #ccc; display:flex; align-items:center; justify-content:center; cursor:pointer; margin: auto;">
            <span>Click para cargar imagen</span>
          </div>
          <input type="file" id="imgUpload" style="display:none;">
        </div>
      </div>
    </div>

    <!-- Elementos -->
    <div class="card">
      <h2 style="font-size:1.8em; color:#34495e; margin-bottom:20px;">Elementos</h2>
      <table>
        <tr>
          <th>Fuego</th>
          <th>Aire</th>
          <th>Agua</th>
          <th>Eléctrico</th>
          <th>Tierra</th>
          <th>Luz</th>
          <th>Oscuridad</th>
        </tr>
        <tr>
          <td data-element="fire"><input type="number" id="elemFire" value="10" min="10" max="100"></td>
          <td data-element="air"><input type="number" id="elemAir" value="10" min="10" max="100"></td>
          <td data-element="water"><input type="number" id="elemWater" value="10" min="10" max="100"></td>
          <td data-element="electric"><input type="number" id="elemElectro" value="10" min="10" max="100"></td>
          <td data-element="earth"><input type="number" id="elemEarth" value="10" min="10" max="100"></td>
          <td data-element="light"><input type="number" id="elemLight" value="10" min="10" max="100"></td>
          <td data-element="dark"><input type="number" id="elemDark" value="10" min="10" max="100"></td>
        </tr>
      </table>
    </div>

    <!-- Atributos -->
    <div class="card">
      <div class="grid">
        <div class="half">
          <h2>Atributos</h2>
          <table>
            <thead>
              <tr>
                <th>Fuerza</th>
                <th>Inteligencia</th>
                <th>Agilidad</th>
                <th>Metabolismo</th>
                <th>A.M</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <input type="number" id="attrFuerza" value="10" min="10">
                  <div id="modFuerza">0</div>
                </td>
                <td>
                  <input type="number" id="attrInt" value="10" min="10">
                  <div id="modInt">0</div>
                </td>
                <td>
                  <input type="number" id="attrAgil" value="10" min="10">
                  <div id="modAgil">0</div>
                </td>
                <td>
                  <input type="number" id="attrMetab" value="10" min="10">
                  <div id="modMetab">0</div>
                </td>
                <td>
                  <input type="number" id="attrAM" value="10" min="10">
                  <div id="modAM">0</div>
                </td>
              </tr>
            </tbody>
          </table>
          <small>Modificador = (Valor - 10) / 2</small>
        </div>
      </div>
    </div>

    <!-- Estadísticas -->
    <div class="card">
      <h2>Estadísticas</h2>
      <div class="stats-grid">
        <div class="stat">Vida: <span id="calcVida">0 / 0</span></div>
        <div class="stat">Armadura: <span id="calcArmor">10</span></div>
        <div class="stat">Místyculas: <span id="calcMistyculas">0 / 0</span></div>
        <div class="stat">XP: <span id="calcXP">0 / 0</span></div>
        <div class="stat">Nivel: <span id="calcNivel">1 / 20</span></div>
      </div>
      <div class="stats-input">
        <input type="number" id="inputXP" placeholder="Añadir XP" value="0" min="0" style="width:80px;">
        <button class="btn" onclick="agregarXP()">Añadir XP</button>
      </div>
      <div style="text-align:center;">
        <button class="btn" onclick="actualizarTodo()">Actualizar Estadísticas</button>
        <button class="btn" onclick="openStatsEditModal()">Editar Estadísticas</button>
      </div>
    </div>

    <!-- Fórmulas Avanzadas -->
    <div class="card" style="text-align:center;">
      <button class="btn" onclick="openModal('formulasModal')">Mostrar Fórmulas Avanzadas</button>
    </div>

    <!-- Acciones y Combate -->
    <div class="card">
        <h2 style="font-size:1.8em; color:#34495e; margin-bottom:20px;">Acciones y Combate</h2>
        
        <div class="stats-grid">
            <div class="stat">
                Acciones: <span id="currentActions">0</span>/<span id="maxActions">0</span>
            </div>
        </div>

        <div class="combat-grid">
            <div class="combat-section">
                <h3>Daño</h3>
                <input type="number" id="inputDamage" value="0" min="0">
                <button class="btn" onclick="aplicarDaño()">Aplicar Daño</button>
            </div>
            
            <div class="combat-section">
                <h3>Curación</h3>
                <input type="number" id="inputHeal" value="0" min="0">
                <button class="btn" onclick="aplicarCura()">Aplicar Cura</button>
            </div>
            
            <div class="combat-section">
                <h3>Místyculas</h3>
                <input type="number" id="inputMistyRegen" value="0" min="0">
                <button class="btn" onclick="regenerarMisty()">Recuperar</button>
            </div>
        </div>

        <div class="actions-grid">
            <button class="action-btn" onclick="useAction('hablar', 0)">
                Hablar (Sin coste)
            </button>
            <button class="action-btn" onclick="useAction('menor', 1)">
                Acción Menor (1 acción)
            </button>
            <button class="action-btn" onclick="useAction('objeto', 1)">
                Acción de Objeto (1 acción)
            </button>
            <button class="action-btn" onclick="useAction('compleja', 2)">
                Acción Compleja (2 acciones)
            </button>
            <button class="action-btn" onclick="useAction('reaccion', 3)">
                Reacción (3 acciones)
            </button>
            <button class="action-btn" onclick="useAction('bonus', 1)" id="bonusActionBtn">
                Acción Bonus (+1 acción)
            </button>
            <button class="action-btn" onclick="useAction('legendaria')" id="legendaryActionBtn">
                Acción Legendaria (10-20 acciones)
            </button>
        </div>
    </div>

    <!-- Secciones para Habilidades, Técnicas & Hechizos, Mascotas y Objetos -->
    <div class="card">
      <h2>Habilidades</h2>
      <div class="item-list" id="skillsList"></div>
      <div style="text-align:center;">
        <button class="btn" onclick="openModal('skillModal')">Agregar Habilidad</button>
      </div>
    </div>

    <div class="card">
      <h2>Técnicas & Hechizos</h2>
      <div class="spell-info">
        <div class="slots-counter">
          <span class="slots-text">Slots Disponibles:</span>
          <span class="slots-numbers" id="spellSlots">${character.spells.length}/${character.spellSystem.slots}</span>
        </div>
      </div>
      <div class="item-list" id="spellsList"></div>
      <div style="text-align:center;">
        <button class="btn" onclick="openModal('spellModal')">Agregar Técnica/Hechizo</button>
      </div>
    </div>

    <div class="card">
      <h2>Mascotas</h2>
      <div class="item-list" id="petsList"></div>
      <div style="text-align:center;">
        <button class="btn" onclick="openModal('petModal')">Agregar / Editar Mascota</button>
      </div>
    </div>
    <div class="card">
      <h2>Objetos</h2>
      <div class="item-list" id="itemsList"></div>
      <div style="text-align:center;">
        <button class="btn" onclick="openModal('itemModal')">Agregar / Editar Objeto</button>
      </div>
    </div>

    <!-- Gestión de Personaje -->
    <div class="card">
      <h2>Gestión de Personaje</h2>
      <div style="text-align:center;">
        <button class="btn" onclick="exportCharacter()">Exportar Personaje</button>
        <button class="btn" onclick="importCharacter()">Importar Personaje</button>
      </div>
    </div>
  </div>

  <!-- Modal Genérico -->
  <div id="modalOverlay" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal()">×</span>
      <div id="modalBody"></div>
      <button class="btn" id="modalSaveBtn">Guardar</button>
    </div>
  </div>

  <script>
    const RARITIES = {
        intrinseca: { name: "Intrínseca", color: "#808080", textColor: "black" },
        comun: { name: "Común", color: "#4CAF50", textColor: "black" },
        epica: { name: "Épica", color: "#9C27B0", textColor: "#FFD700" },
        legendario: { name: "Legendario", color: "#FFD700", textColor: "black" },
        mitico: { name: "Mítico", color: "#FF0000", textColor: "#FFD700", border: "2px solid black" },
        genesis: { name: "Génesis", color: "linear-gradient(45deg, #4CAF50, #2196F3)", textColor: "#FFD700", border: "2px solid black" }
    };

    let currentFormulaInput = null;
    const expTable = [
      { level: 1, exp: 0 }, { level: 2, exp: 1000 }, { level: 3, exp: 3000 },
      { level: 4, exp: 6000 }, { level: 5, exp: 10000 }, { level: 6, exp: 15000 },
      { level: 7, exp: 21000 }, { level: 8, exp: 28000 }, { level: 9, exp: 36000 },
      { level: 10, exp: 45000 }, { level: 11, exp: 55000 }, { level: 12, exp: 66000 },
      { level: 13, exp: 78000 }, { level: 14, exp: 91000 }, { level: 15, exp: 105000 },
      { level: 16, exp: 120000 }, { level: 17, exp: 136000 }, { level: 18, exp: 153000 },
      { level: 19, exp: 171000 }, { level: 20, exp: 190000 }
    ];
    let character = {
      name: "", race: "", languages: "", personality: "", image: null,
      elements: { fire: 10, air: 10, water: 10, electro: 10, earth: 10, light: 10, dark: 10 },
      attributes: { fuerza: 10, inteligencia: 10, agilidad: 10, metabolismo: 10, am: 10 },
      baseHealth: 25, currentHealth: 25, maxHealth: 25,
      baseArmor: 10, armor: 10,
      baseMistyculas: 100, currentMistyculas: 100, maxMistyculas: 100,
      experience: 0, level: 1,
      actions: { 
        action: 0, 
        minor: 1, 
        bonus: 1, 
        interaction: 1, 
        talk: Infinity, 
        special: 0,
        hasLegendary: true  // Habilitar acciones legendarias por defecto
      },
      skills: [], spells: [], pets: [], items: [],
      spellSystem: {
        slots: 3,
        maxSlots: 12,
        unlockedSlots: []
      },
      equipment: {
        mainHand: null,
        offHand: null,
        head: null,
        chest: null,
        legs: null,
        feet: null,
        accessory1: null,
        accessory2: null
      }
    };

    const FORMULA_ELEMENTS = {
        attributes: [
            { id: 'Fuerza', display: 'Fuerza' },
            { id: 'Inteligencia', display: 'Inteligencia' },
            { id: 'Agilidad', display: 'Agilidad' },
            { id: 'Metabolismo', display: 'Metabolismo' },
            { id: 'A.M', display: 'A.M' }
        ],
        mods: [
            { id: 'FuerzaMod', display: 'Mod. Fuerza' },
            { id: 'InteligenciaMod', display: 'Mod. Int' },
            { id: 'AgilidadMod', display: 'Mod. Agi' },
            { id: 'MetabolismoMod', display: 'Mod. Met' },
            { id: 'AMMod', display: 'Mod. A.M' }
        ],
        stats: [
            { id: 'Mistyculas', display: 'Místyculas' },
            { id: 'Armadura', display: 'Armadura' },
            { id: 'VidaBase', display: 'Vida Base' },
            { id: 'VidaActual', display: 'Vida Actual' }
        ],
        dice: [
            { id: 'd', display: 'd' },
            { id: 'd4', display: 'd4' },
            { id: 'd6', display: 'd6' },
            { id: 'd8', display: 'd8' },
            { id: 'd10', display: 'd10' },
            { id: 'd12', display: 'd12' },
            { id: 'd20', display: 'd20' },
            { id: 'd100', display: 'd100' }
        ],
        operators: [
            { id: '+', display: '+' },
            { id: '-', display: '-' },
            { id: '*', display: '×' },
            { id: '/', display: '÷' },
            { id: '(', display: '(' },
            { id: ')', display: ')' }
        ]
    };

    function createFormulaButtons(targetId) {
        return `
            <div class="formula-section">
                <label>Fórmula:</label>
                <input type="text" id="${targetId}" class="formula-input" placeholder="Ej: 2d6 + FuerzaMod">
                <div class="formula-categories">
                    ${Object.entries(FORMULA_ELEMENTS).map(([category, elements]) => `
                        <div class="formula-category">
                            <h4>${category.charAt(0).toUpperCase() + category.slice(1)}</h4>
                            <div class="formula-buttons">
                                ${elements.map(el => `
                                    <button class="formula-btn" type="button" 
                                        onclick="insertFormula('${el.id}', '${targetId}')"
                                        title="${el.display}">
                                        ${el.display}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    function calcularMod(valor) { return Math.floor((valor - 10) / 2); }
    function actualizarAtributos() {
      document.getElementById("modFuerza").textContent = calcularMod(character.attributes.fuerza);
      document.getElementById("modInt").textContent = calcularMod(character.attributes.inteligencia);
      document.getElementById("modAgil").textContent = calcularMod(character.attributes.agilidad);
      document.getElementById("modMetab").textContent = calcularMod(character.attributes.metabolismo);
      document.getElementById("modAM").textContent = calcularMod(character.attributes.am);
    }
    function actualizarNivelXP() {
      let lvl = 1, baseXP = 0;
      for (let i = 0; i < expTable.length; i++) {
        if (character.experience >= expTable[i].exp) { 
          lvl = expTable[i].level; 
          baseXP = expTable[i].exp; 
        } else break;
      }
      character.level = lvl;
      const next = expTable.find(e => e.level === lvl + 1);
      const xpExcess = character.experience - baseXP;
      const xpNeeded = next ? next.exp - baseXP : 0;
      document.getElementById("calcXP").textContent = xpExcess + " / " + xpNeeded;
      document.getElementById("calcNivel").textContent = character.level + " / 20";
    }
    function actualizarVida() {
      const modMet = calcularMod(character.attributes.metabolismo);
      character.maxHealth = Math.floor(character.baseHealth * character.level * (modMet > 0 ? modMet : 1));
      if (character.currentHealth > character.maxHealth) character.currentHealth = character.maxHealth;
      document.getElementById("calcVida").textContent = character.currentHealth + " / " + character.maxHealth;
    }
    function actualizarArmor() {
        const modAgil = calcularMod(character.attributes.agilidad);
        const modMet = calcularMod(character.attributes.metabolismo);
        // Calcular armadura base con modificadores
        const armorBase = character.baseArmor + modAgil + modMet;
        // Mostrar armadura actual / armadura base
        document.getElementById("calcArmor").textContent = `${character.armor} / ${armorBase}`;
    }
    function actualizarMistyculas() {
      const modInt = calcularMod(character.attributes.inteligencia);
      const modAM = calcularMod(character.attributes.am);
      character.maxMistyculas = character.baseMistyculas * (modInt > 0 ? modInt : 1) * (modAM > 0 ? modAM : 1);
      if (character.currentMistyculas > character.maxMistyculas) character.currentMistyculas = character.maxMistyculas;
      document.getElementById("calcMistyculas").textContent = character.currentMistyculas + " / " + character.maxMistyculas;
    }
    function actualizarAcciones() {
      const modAgil = calcularMod(character.attributes.agilidad);
      character.actions.action = character.level + modAgil + 1;
      character.actions.maxAction = character.actions.action;
      
      document.getElementById('currentActions').textContent = character.actions.action;
      document.getElementById('maxActions').textContent = character.actions.maxAction;
      
      // La acción bonus está habilitada por defecto
      document.getElementById('bonusActionBtn').disabled = false;
      // La acción legendaria sigue requiriendo permiso del DM
      document.getElementById('legendaryActionBtn').disabled = !character.actions.hasLegendary;
    }
    function actualizarTodo() {
      actualizarAtributos();
      actualizarNivelXP();
      actualizarVida();
      actualizarArmor();
      actualizarMistyculas();
      actualizarAcciones();
      actualizarSlots(); // Añadir esta línea
    }
    function actualizarSlots() {
        // Calcular slots basados en el nivel
        if (character.level >= 10) {
            character.spellSystem.slots = 12; // Máximo en nivel 10+
        } else if (character.level >= 5) {
            character.spellSystem.slots = 5;  // 5 slots en nivel 5-9
        } else {
            character.spellSystem.slots = 3;  // 3 slots en nivel 1-4
        }
        
        // Actualizar display
        document.getElementById('spellSlots').textContent = 
            `${character.spells.length}/${character.spellSystem.slots}`;
    }
    function agregarXP() {
      const xp = parseInt(document.getElementById("inputXP").value);
      if (isNaN(xp) || xp < 0) return;
      character.experience += xp;
      actualizarTodo();
    }
    function resetAcciones() {
      actualizarAcciones();
      character.actions.minor = 1;
      character.actions.bonus = 1;
      character.actions.interaction = 1;
    }
    function aplicarDaño() {
      const dmg = parseInt(document.getElementById("inputDamage").value);
      if (isNaN(dmg) || dmg < 0) return;
      character.currentHealth -= dmg;
      if (character.currentHealth < 0) character.currentHealth = 0;
      actualizarVida();
      document.getElementById("inputDamage").value = 0;
    }
    function aplicarCura() {
      const cura = parseInt(document.getElementById("inputHeal").value);
      if (isNaN(cura) || cura < 0) return;
      character.currentHealth += cura;
      if (character.currentHealth > character.maxHealth) character.currentHealth = character.maxHealth;
      actualizarVida();
      document.getElementById("inputHeal").value = 0;
    }
    function regenerarMisty() {
      const regen = parseInt(document.getElementById("inputMistyRegen").value);
      if (isNaN(regen) || regen < 0) return;
      character.currentMistyculas += regen;
      if (character.currentMistyculas > character.maxMistyculas) character.currentMistyculas = character.maxMistyculas;
      actualizarMistyculas();
      document.getElementById("inputMistyRegen").value = 0;
    }
    // Eventos para atributos
    document.getElementById("attrFuerza").addEventListener("change", () => {
      character.attributes.fuerza = parseInt(document.getElementById("attrFuerza").value);
      actualizarTodo();
    });
    document.getElementById("attrInt").addEventListener("change", () => {
      character.attributes.inteligencia = parseInt(document.getElementById("attrInt").value);
      actualizarTodo();
    });
    document.getElementById("attrAgil").addEventListener("change", () => {
      character.attributes.agilidad = parseInt(document.getElementById("attrAgil").value);
      actualizarTodo();
    });
    document.getElementById("attrMetab").addEventListener("change", () => {
      character.attributes.metabolismo = parseInt(document.getElementById("attrMetab").value);
      actualizarTodo();
    });
    document.getElementById("attrAM").addEventListener("change", () => {
      character.attributes.am = parseInt(document.getElementById("attrAM").value);
      actualizarTodo();
    });
    // Datos del personaje
    document.getElementById("charName").addEventListener("change", function() { character.name = this.value; });
    document.getElementById("charRace").addEventListener("change", function() { character.race = this.value; });
    document.getElementById("charLang").addEventListener("change", function() { character.languages = this.value; });
    document.getElementById("charPerso").addEventListener("change", function() { character.personality = this.value; });
    // Imagen
    document.getElementById("imgContainer").addEventListener("click", function() {
      document.getElementById("imgUpload").click();
    });
    document.getElementById("imgUpload").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        character.image = ev.target.result;
        document.getElementById("imgContainer").innerHTML = `<img src="${character.image}" style="width:100%; height:100%; object-fit:cover;">`;
      }
      reader.readAsDataURL(file);
    });

    // Modal Genérico
    const modalOverlay = document.getElementById("modalOverlay");
    const modalBody = document.getElementById("modalBody");
    const modalSaveBtn = document.getElementById("modalSaveBtn");
    let modalCallback = null;
    function openModal(modalId, itemId = null) {
      modalOverlay.style.display = "flex";
      
      if(modalId === 'formulasModal') {
          const modFuerza = calcularMod(character.attributes.fuerza);
          const modAgil = calcularMod(character.attributes.agilidad);
          const modMet = calcularMod(character.attributes.metabolismo);
          const modInt = calcularMod(character.attributes.inteligencia);
          
          const formulas = {
              vida: `${character.baseHealth} × ${character.level} × ${modMet > 0 ? modMet : 1} = ${character.maxHealth}`,
              armor: `${character.baseArmor} + ${modAgil} + ${modMet} = ${character.armor}`,
              misty: `${character.baseMistyculas} × ${modInt > 0 ? modInt : 1} × ${calcularMod(character.attributes.am) > 0 ? calcularMod(character.attributes.am) : 1} = ${character.maxMistyculas}`,
              daño: `Daño Arma + ${modFuerza} = Daño Base + ${modFuerza}`,
              movimiento: `(${modFuerza} + ${modAgil}) × 10 = ${(modFuerza + modAgil) * 10} pies`,
              carga: `(${modMet} + ${modFuerza}) × 10 = ${(modMet + modFuerza) * 10} libras`,
              resistencia: `${character.level} + ${modMet} = ${character.level + modMet}`,
              tamaño: `${modMet} × 10 = ${modMet * 10}`,
              altura: `${modMet * 10} × 10 = ${modMet * 100} cm`,
              peso: `${modMet * 10} × 5 = ${modMet * 50} kg`,
              sabiduria: `${modInt} + ${character.level} = ${modInt + character.level}`
          };

          modalBody.innerHTML = `
              <h3>Fórmulas Avanzadas</h3>
              <div class="formula-card">
                  <h4>Vida Máxima:</h4>
                  <p>Vida Base × Nivel × (Mod Metabolismo > 0 ? Mod Metabolismo : 1)</p>
                  <p class="formula-result">${formulas.vida}</p>
              </div>
              <div class="formula-card">
                  <h4>Armadura:</h4>
                  <p>Base + Mod Agilidad + Mod Metabolismo</p>
                  <p class="formula-result">${formulas.armor}</p>
              </div>
              <div class="formula-card">
                  <h4>Místyculas Máximas:</h4>
                  <p>Base × (Mod Inteligencia > 0 ? Mod Inteligencia : 1) × (Mod A.M > 0 ? Mod A.M : 1)</p>
                  <p class="formula-result">${formulas.misty}</p>
              </div>
              <div class="formula-card">
                  <h4>Daño Cuerpo a Cuerpo:</h4>
                  <p>Daño del arma + Mod Fuerza</p>
                  <p class="formula-result">${formulas.daño}</p>
              </div>
              <div class="formula-card">
                  <h4>Movimiento:</h4>
                  <p>(Mod Fuerza + Mod Agilidad) × 10</p>
                  <p class="formula-result">${formulas.movimiento}</p>
              </div>
              <div class="formula-card">
                  <h4>Capacidad de Carga:</h4>
                  <p>(Mod Metabolismo + Mod Fuerza) × 10</p>
                  <p class="formula-result">${formulas.carga}</p>
              </div>
              <div class="formula-card">
                  <h4>Resistencia a Efectos:</h4>
                  <p>Nivel + Mod Metabolismo</p>
                  <p class="formula-result">${formulas.resistencia}</p>
              </div>
              <div class="formula-card">
                  <h4>Tamaño Corporal:</h4>
                  <p>Mod Metabolismo × 10</p>
                  <p class="formula-result">${formulas.tamaño}</p>
              </div>
              <div class="formula-card">
                  <h4>Altura Aproximada:</h4>
                  <p>Tamaño × 10 cm</p>
                  <p class="formula-result">${formulas.altura}</p>
              </div>
              <div class="formula-card">
                  <h4>Peso Aproximado:</h4>
                  <p>Tamaño × 5 kg</p>
                  <p class="formula-result">${formulas.peso}</p>
              </div>
              <div class="formula-card">
                  <h4>Sabiduría:</h4>
                  <p>Mod Inteligencia + Nivel</p>
                  <p class="formula-result">${formulas.sabiduria}</p>
              </div>
          `;
      }
      
      if(modalId === 'skillModal') {
          const formulaButtonsSkill = createFormulaButtons('skillFormula');

          const skill = itemId ? character.skills.find(s => s.id === itemId) : null;
          modalBody.innerHTML = `
              <h3>${itemId ? "Editar" : "Agregar"} Habilidad</h3>
              <div class="modal-form">
                  <div class="input-group">
                      <label>Nombre:</label>
                      <input type="text" id="skillName" value="${skill?.name || ''}" required>
                  </div>
                  <div class="input-group">
                      <label>Descripción:</label>
                      <textarea id="skillDesc">${skill?.desc || ''}</textarea>
                  </div>
                  <div class="input-group">
                      <label>Costo de Místyculas:</label>
                      <input type="number" id="skillMistyCost" value="${skill?.mistyCost || 0}" min="0">
                  </div>
                  <div class="input-group">
                      <label>Costo de Acciones:</label>
                      <input type="number" id="skillActionCost" value="${skill?.actionCost || 1}" min="1">
                  </div>
                  ${getRaritySelect(skill?.rarity)}
                  ${formulaButtonsSkill}
              </div>
          `;

          modalCallback = function() {
              const newSkill = {
                  id: skill ? skill.id : Date.now().toString(),
                  name: document.getElementById('skillName').value,
                  desc: document.getElementById('skillDesc').value,
                  mistyCost: parseInt(document.getElementById('skillMistyCost').value) || 0,
                  actionCost: parseInt(document.getElementById('skillActionCost').value) || 1,
                  rarity: document.getElementById('itemRarity').value,
                  formula: document.getElementById('skillFormula').value
              };

              if (itemId) {
                  const index = character.skills.findIndex(s => s.id === itemId);
                  character.skills[index] = newSkill;
              } else {
                  character.skills.push(newSkill);
              }
              renderList('skillsList', character.skills);
          };
      }

      if(modalId === 'spellModal') {
          const formulaButtonsSpell = createFormulaButtons('spellFormula');

          if (!itemId && character.spells.length >= character.spellSystem.slots) {
              PopupManager.alert("No hay slots disponibles para más técnicas o hechizos.");
              return;
          }

          const spell = itemId ? character.spells.find(s => s.id === itemId) : null;
          modalBody.innerHTML = `
              <h3>${itemId ? "Editar" : "Agregar"} Técnica/Hechizo</h3>
              <div class="modal-form">
                  <div class="input-group">
                      <label>Nombre:</label>
                      <input type="text" id="spellName" value="${spell?.name || ''}" required>
                  </div>
                  <div class="input-group">
                      <label>Tipo:</label>
                      <select id="spellType">
                          <option value="tecnica" ${spell?.type === 'tecnica' ? 'selected' : ''}>Técnica</option>
                          <option value="hechizo" ${spell?.type === 'hechizo' ? 'selected' : ''}>Hechizo</option>
                      </select>
                  </div>
                  <div class="input-group">
                      <label>Descripción:</label>
                      <textarea id="spellDesc">${spell?.desc || ''}</textarea>
                  </div>
                  <div class="input-group">
                      <label>Costo de Místyculas:</label>
                      <input type="number" id="spellMistyCost" value="${spell?.mistyCost || 0}" min="0">
                  </div>
                  <div class="input-group">
                      <label>Costo de Acciones:</label>
                      <input type="number" id="spellActionCost" value="${spell?.actionCost || 1}" min="1">
                  </div>
                  ${getRaritySelect(spell?.rarity)}
                  ${formulaButtonsSpell}
              </div>
          `;

          modalCallback = function() {
              const newSpell = {
                  id: spell ? spell.id : Date.now().toString(),
                  name: document.getElementById('spellName').value,
                  type: document.getElementById('spellType').value,
                  desc: document.getElementById('spellDesc').value,
                  mistyCost: parseInt(document.getElementById('spellMistyCost').value) || 0,
                  actionCost: parseInt(document.getElementById('spellActionCost').value) || 1,
                  rarity: document.getElementById('itemRarity').value,
                  formula: document.getElementById('spellFormula').value
              };

              if (itemId) {
                  const index = character.spells.findIndex(s => s.id === itemId);
                  character.spells[index] = newSpell;
              } else {
                  character.spells.push(newSpell);
              }
              renderList('spellsList', character.spells);
              actualizarSlots();
          };
      }

      if(modalId === 'petModal') {
        const pet = itemId ? character.pets.find(p => p.id === itemId) : null;
        modalBody.innerHTML = `
          <h3>${itemId ? "Editar" : "Agregar"} Mascota</h3>
          <label>Nombre:</label>
          <input type="text" id="petName" value="${pet?.name || ''}" placeholder="Nombre de la mascota">
          <label>Raza:</label>
          <input type="text" id="petRace" value="${pet?.race || ''}" placeholder="Raza de la mascota">
          <label>Tipo:</label>
          <input type="text" id="petType" value="${pet?.type || ''}" placeholder="Tipo de la mascota">
          <label>Imagen:</label>
          <input type="file" id="petImage">
        `;

        modalCallback = function() {
          const newPet = {
            id: pet ? pet.id : Date.now().toString(),
            name: document.getElementById('petName').value,
            race: document.getElementById('petRace').value,
            type: document.getElementById('petType').value
          };

          const imageFile = document.getElementById('petImage').files[0];
          if (imageFile) {
            const reader = new FileReader();
            reader.onload = function(e) {
              newPet.image = e.target.result;
              savePet(newPet, itemId);
            };
            reader.readAsDataURL(imageFile);
          } else {
            if (pet?.image) newPet.image = pet.image;
            savePet(newPet, itemId);
          }
        };
      }
      
      if(modalId === 'itemModal') {
        const item = itemId ? character.items.find(i => i.id === itemId) : null;
        modalBody.innerHTML = `
            <h3>${itemId ? "Editar" : "Agregar"} Objeto</h3>
            <div class="modal-form">
                <div class="input-group">
                    <label>Nombre:</label>
                    <input type="text" id="itemName" value="${item?.name || ''}" required>
                </div>
                
                <div class="input-group">
                    <label>Tipo:</label>
                    <input type="text" id="itemType" value="${item?.type || ''}" placeholder="Tipo del objeto">
                </div>

                ${getRaritySelect(item?.rarity || 'intrinseca')}

                <div class="input-group">
                    <label>Descripción:</label>
                    <textarea id="itemDesc">${item?.desc || ''}</textarea>
                </div>

                <div class="input-group">
                    <label>Bonos:</label>
                    <div id="bonusList"></div>
                    <button class="btn" type="button" onclick="addBonus()">Añadir Bono</button>
                </div>
            </div>
        `;

        if (item?.bonuses) {
            item.bonuses.forEach(bonus => addBonus(bonus));
        }

        modalCallback = function() {
            const newItem = {
                id: item ? item.id : Date.now().toString(),
                name: document.getElementById('itemName').value,
                type: document.getElementById('itemType').value,
                rarity: document.getElementById('itemRarity').value,
                desc: document.getElementById('itemDesc').value,
                bonuses: getBonusList()
            };

            if (itemId) {
                // Si estamos editando, primero removemos los bonus antiguos
                const oldItem = character.items.find(i => i.id === itemId);
                if (oldItem) {
                    removeBonuses(oldItem);
                }
                const index = character.items.findIndex(i => i.id === itemId);
                character.items[index] = newItem;
            } else {
                character.items.push(newItem);
            }
            
            // Aplicar los nuevos bonus
            applyBonuses(newItem);
            renderList('itemsList', character.items);
            actualizarTodo();
        };
      }
    }
    function closeModal() {
      modalOverlay.style.display = "none";
      modalBody.innerHTML = "";
      modalCallback = null;
    }
    modalSaveBtn.addEventListener("click", function() {
      if (modalCallback) modalCallback();
      closeModal();
    });
    // Insertar texto en fórmula
    function insertFormula(text, inputId) {
      const input = document.getElementById(inputId);
      const start = input.selectionStart;
      const end = input.selectionEnd;
      const currentValue = input.value;
      
      // Insertar el texto en la posición del cursor
      input.value = currentValue.substring(0, start) + text + currentValue.substring(end);
      
      // Colocar el cursor después del texto insertado
      const newCursorPos = start + text.length;
      input.setSelectionRange(newCursorPos, newCursorPos);
      input.focus();
    }
    function renderList(elementId, list) {
        const container = document.getElementById(elementId);
        container.innerHTML = "";
        
        if (list.length === 0) {
            container.innerHTML = "<p>No hay elementos.</p>";
            return;
        }
        
        list.forEach(item => {
            const div = document.createElement("div");
            div.className = "item";
            div.setAttribute('data-rarity', item.rarity || 'intrinseca');
            
            div.innerHTML = `
                <div class="item-header">${item.name}</div>
                
                <div class="item-stats">
                    ${item.actionCost ? `
                        <div class="item-stat">
                            <span>Acciones:</span>
                            <strong>${item.actionCost}</strong>
                        </div>
                    ` : ''}
                    
                    ${item.mistyCost ? `
                        <div class="item-stat">
                            <span>Místyculas:</span>
                            <strong>${item.mistyCost}</strong>
                        </div>
                    ` : ''}
                </div>
                
                ${item.formula ? `
                    <div class="item-formula" onclick="editarFormula('${elementId}', '${item.id}')">
                        Fórmula: ${item.formula}
                        <small>(Click para editar)</small>
                    </div>
                ` : ''}
                
                ${item.desc ? `
                    <div class="item-description">
                        <strong>Descripción:</strong> ${item.desc}
                    </div>
                ` : ''}
                
                ${item.type && !item.formula ? `
                    <div class="item-description">
                        <strong>Tipo:</strong> ${item.type}
                    </div>
                ` : ''}
                
                ${item.image ? `
                    <img src="${item.image}" alt="Imagen" style="max-width:100px; margin:5px auto;">
                ` : ''}
                
                <div class="item-buttons">
                    <button class="btn" onclick="editarItem('${elementId}', '${item.id}')">Editar</button>
                    <button class="btn" onclick="eliminarItem('${elementId}', '${item.id}')">Eliminar</button>
                    ${(elementId === 'skillsList' || elementId === 'spellsList') ?
                        `<button class="btn" onclick="usarItem('${elementId}', '${item.id}')">Usar</button>` : ''}
                </div>
            `;

            // Agregar sección de bonus si existen
            if (item.bonuses && item.bonuses.length > 0) {
                div.innerHTML += `
                    <div class="item-bonuses">
                        <strong>Bonus:</strong>
                        ${item.bonuses.map(bonus => `
                            <div class="bonus-entry">
                                ${bonus.type === 'attribute' ? 'Atributo' : 
                                  bonus.type === 'current' ? 'Valor Actual' : 'Estadística'}: 
                                ${bonus.target} (${bonus.value > 0 ? '+' : ''}${bonus.value})
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            container.appendChild(div);
        });
    }
    async function eliminarItem(listId, id) {
        try {
            const confirmed = await PopupManager.confirm(
                "¿Estás seguro de que deseas eliminar este elemento?",
                "Confirmar eliminación"
            );

            if (!confirmed) return;

            if (listId === "itemsList") {
                const item = character.items.find(i => i.id === id);
                if (item) {
                    removeBonuses(item);
                }
                character.items = character.items.filter(i => i.id !== id);
                renderList(listId, character.items);
                actualizarTodo();
            } else if (listId === "skillsList") {
                character.skills = character.skills.filter(s => s.id !== id);
                renderList(listId, character.skills);
            } else if (listId === "spellsList") {
                character.spells = character.spells.filter(s => s.id !== id);
                renderList(listId, character.spells);
                actualizarSlots();
            } else if (listId === "petsList") {
                character.pets = character.pets.filter(p => p.id !== id);
                renderList(listId, character.pets);
            }

            await PopupManager.alert("Elemento eliminado correctamente");
        } catch (error) {
            await PopupManager.alert("Error al eliminar: " + error.message);
        }
    }
    function editarItem(listId, id) {
      if (listId === "skillsList") { openModal('skillModal', id); }
      else if (listId === "spellsList") { openModal('spellModal', id); }
      else if (listId === "petsList") { openModal('petModal', id); }
      else if (listId === "itemsList") { openModal('itemModal', id); }
    }
    // Usar habilidad o hechizo
    async function usarItem(listId, id) {
        try {
            const item = listId === "skillsList" 
                ? character.skills.find(s => s.id === id)
                : character.spells.find(s => s.id === id);

            if (!item) {
                await PopupManager.alert("Item no encontrado.");
                return;
            }

            if (character.currentMistyculas < item.mistyCost) {
                await PopupManager.alert("No tienes suficientes místyculas.");
                return;
            }
            if (character.actions.action < item.actionCost) {
                await PopupManager.alert("No tienes suficientes acciones.");
                return;
            }

            const confirmed = await PopupManager.confirm(
                `¿Deseas usar ${item.name}?\nCosto: ${item.actionCost} acciones, ${item.mistyCost} místyculas`,
                "Confirmar uso"
            );

            if (confirmed) {
                // Restar costos
                character.currentMistyculas -= item.mistyCost;
                character.actions.action = Math.max(0, character.actions.action - item.actionCost);
                
                // Actualizar displays
                actualizarMistyculas();
                document.getElementById('currentActions').textContent = character.actions.action;
                document.getElementById('maxActions').textContent = character.actions.maxAction;
                
                const resultado = resolverFormula(item.formula);
                await PopupManager.alert(
                    `${listId === "skillsList" ? "Habilidad" : "Técnica/Hechizo"}: ${item.name}\n` +
                    `Fórmula: ${item.formula}\n` +
                    `Resultado: ${resultado}\n` +
                    `Acciones restantes: ${character.actions.action}`,
                    "Resultado"
                );
            }
        } catch (error) {
            await PopupManager.alert("Error al usar el item: " + error.message);
        }
    }
    function resolverFormula(formula) {
        try {
            if (!formula.trim()) return 0;
            
            // Obtener valores de atributos y stats
            const values = {
                Fuerza: character.attributes.fuerza,
                Inteligencia: character.attributes.inteligencia,
                Agilidad: character.attributes.agilidad,
                Metabolismo: character.attributes.metabolismo,
                'A.M': character.attributes.am,
                FuerzaMod: calcularMod(character.attributes.fuerza),
                InteligenciaMod: calcularMod(character.attributes.inteligencia),
                AgilidadMod: calcularMod(character.attributes.agilidad),
                MetabolismoMod: calcularMod(character.attributes.metabolismo),
                AMMod: calcularMod(character.attributes.am),
                Mistyculas: character.currentMistyculas,
                Armadura: character.armor,
                VidaBase: character.baseHealth,
                VidaActual: character.currentHealth
            };

            // Procesar dados con atributos
            let processedFormula = formula.replace(/(\d+)?\s*d\s*(\w+)/g, (match, num, attr) => {
                const numDice = num ? parseInt(num) : 1;
                const sides = values[attr] || parseInt(attr);
                
                if (isNaN(sides)) {
                    throw new Error(`Valor inválido para dados: ${attr}`);
                }

                let total = 0;
                const rolls = [];
                for (let i = 0; i < numDice; i++) {
                    const roll = Math.floor(Math.random() * sides) + 1;
                    rolls.push(roll);
                    total += roll;
                }
                
                return total.toString();
            });

            // Reemplazar valores de atributos y stats
            for (const [key, value] of Object.entries(values)) {
                const regex = new RegExp(key, 'g');
                processedFormula = processedFormula.replace(regex, value.toString());
            }

            const resultado = eval(processedFormula);
            return Math.floor(resultado);
        } catch (error) {
            console.error('Error en la fórmula:', error);
            return 0;
        }
    }
    actualizarTodo();
    applyAllBonuses(); // Añade esta línea

    const PopupManager = {
      show(options = {}) {
        return new Promise((resolve) => {
          const popup = document.createElement('div');
          popup.className = 'custom-popup';
          popup.innerHTML = `
              <div class="popup-content">
                  <h3>${options.title || ''}</h3>
                  <p>${options.content || ''}</p>
                  <div class="popup-buttons">
                      <button class="btn confirm-btn">${options.confirmText || 'Aceptar'}</button>
                      ${options.showCancel ? `<button class="btn cancel-btn">${options.cancelText || 'Cancelar'}</button>` : ''}
                  </div>
              </div>
          `;
          document.body.appendChild(popup);

          const confirmBtn = popup.querySelector('.confirm-btn');
          const cancelBtn = popup.querySelector('.cancel-btn');

          confirmBtn.onclick = () => {
              popup.remove();
              resolve(true);
          };
          if (cancelBtn) {
              cancelBtn.onclick = () => {
                  popup.remove();
                  resolve(false);
              };
          }
        });
      },

      async confirm(message, title = 'Confirmar') {
        return this.show({
          title,
          content: message,
          showCancel: true
        });
      },

      async alert(message, title = 'Aviso') {
        return this.show({
          title,
          content: message
        });
      },

      async prompt(title, message, defaultValue = '') {
        return new Promise((resolve) => {
            const popup = document.createElement('div');
            popup.className = 'custom-popup';
            popup.innerHTML = `
                <div class="popup-content">
                    <h3>${title}</h3>
                    <p>${message}</p>
                    <input type="text" 
                           value="${defaultValue}" 
                           style="width: 100%; padding: 8px; margin: 10px 0;"
                           id="popupInput">
                    <div class="popup-buttons">
                        <button class="btn confirm-btn">Aceptar</button>
                        <button class="btn cancel-btn">Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(popup);

            const input = popup.querySelector('#popupInput');
            const confirmBtn = popup.querySelector('.confirm-btn');
            const cancelBtn = popup.querySelector('.cancel-btn');

            input.focus();
            input.select();

            confirmBtn.onclick = () => {
                const value = input.value;
                popup.remove();
                resolve(value);
            };
            
            cancelBtn.onclick = () => {
                popup.remove();
                resolve(null);
            };
        });
      }
    };

    // Añadir manejo de elementos
    document.querySelectorAll('td[data-element]').forEach(td => {
      td.addEventListener('click', function() {
        this.classList.toggle('active');
      });
    });

    // Función auxiliar para guardar mascotas
    function savePet(newPet, itemId) {
      if (itemId) {
        const index = character.pets.findIndex(p => p.id === itemId);
        character.pets[index] = newPet;
      } else {
        character.pets.push(newPet);
      }
      renderList('petsList', character.pets);
    }

    function openStatsEditModal() {
        const modalOverlay = document.getElementById("modalOverlay");
        const modalBody = document.getElementById("modalBody");
        
        // Mostrar el modal
        modalOverlay.style.display = "flex";
        
        // Actualizar el contenido del modal
        modalBody.innerHTML = `
            <h3 style="margin-bottom: 20px; text-align: center;">Editar Estadísticas Base</h3>
            <div class="modal-form">
                <div class="stat-edit-group">
                    <label>Vida:</label>
                    <div class="stat-input-pair">
                        <input type="number" id="editBaseHealth" value="${character.baseHealth}" min="1" placeholder="Base">
                        <input type="number" id="editCurrentHealth" value="${character.currentHealth}" min="0" placeholder="Actual">
                    </div>
                </div>
                <div class="stat-edit-group">
                    <label>Armadura:</label>
                    <div class="stat-input-pair">
                        <input type="number" id="editBaseArmor" value="${character.baseArmor}" min="0" placeholder="Base">
                        <input type="number" id="editCurrentArmor" value="${character.armor}" min="0" placeholder="Actual">
                    </div>
                </div>
                <div class="stat-edit-group">
                    <label>Místyculas:</label>
                    <div class="stat-input-pair">
                        <input type="number" id="editBaseMistyculas" value="${character.baseMistyculas}" min="1" placeholder="Base">
                        <input type="number" id="editCurrentMistyculas" value="${character.currentMistyculas}" min="0" placeholder="Actual">
                    </div>
                </div>
                <div class="stat-edit-group">
                    <label>Experiencia Total:</label>
                    <input type="number" id="editXP" value="${character.experience}" min="0">
                </div>
            </div>
        `;

        // Configurar el callback para guardar
        modalCallback = function() {
            // Actualizar valores base
            character.baseHealth = parseInt(document.getElementById('editBaseHealth').value) || 25;
            character.baseArmor = parseInt(document.getElementById('editBaseArmor').value) || 10;
            character.baseMistyculas = parseInt(document.getElementById('editBaseMistyculas').value) || 100;
            
            // Actualizar valores actuales
            character.currentHealth = parseInt(document.getElementById('editCurrentHealth').value) || character.currentHealth;
            character.armor = parseInt(document.getElementById('editCurrentArmor').value) || character.armor;
            character.currentMistyculas = parseInt(document.getElementById('editCurrentMistyculas').value) || character.currentMistyculas;
            
            // Actualizar XP
            character.experience = parseInt(document.getElementById('editXP').value) || 0;
            
            // Actualizar todo
            actualizarTodo();
        };
    }

    function renderBonusList(bonuses) {
      return bonuses.map((bonus, index) => `
          <div class="bonus-item">
              <select onchange="updateBonus(${index}, 'type')">
                  <option value="attribute" ${bonus.type === 'attribute' ? 'selected' : ''}>Atributo</option>
                  <option value="stat" ${bonus.type === 'stat' ? 'selected' : ''}>Estadística</option>
              </select>
              
              ${bonus.type === 'attribute' ? `
                  <select onchange="updateBonus(${index}, 'attribute')">
                      <option value="fuerza">Fuerza</option>
                      <option value="inteligencia">Inteligencia</option>
                      <option value="agilidad">Agilidad</option>
                      <option value="metabolismo">Metabolismo</option>
                      <option value="am">A.M</option>
                  </select>
              ` : `
                  <select onchange="updateBonus(${index}, 'stat')">
                      <option value="health">Vida Base</option>
                      <option value="armor">Armadura Base</option>
                      <option value="mistyculas">Místyculas Base</option>
                  </select>
              `}
              
              <input type="number" 
                     value="${bonus.value}"
                     onchange="updateBonus(${index}, 'value')"
                     min="-20" 
                     max="20">
                     
              <button class="btn" onclick="removeBonus(${index})">X</button>
          </div>
      `).join('');
    }

    function equipItem(item, slot) {
      // Desequipar item actual si existe
      if(character.equipment[slot]) {
          removeBonuses(character.equipment[slot]);
          character.items.push(character.equipment[slot]);
      }
      
      // Equipar nuevo item
      character.equipment[slot] = item;
      applyBonuses(item);
      
      // Remover de inventario
      character.items = character.items.filter(i => i.id !== item.id);
      
      actualizarTodo();
    }

    function addBonus(existingBonus = null) {
        const bonusList = document.getElementById('bonusList');
        const bonusDiv = document.createElement('div');
        bonusDiv.className = 'bonus-item';
        
        // Modificar las opciones para incluir stats actuales
        const typeSelect = document.createElement('select');
        typeSelect.innerHTML = `
            <option value="attribute">Atributo Base</option>
            <option value="current">Valor Actual</option>
            <option value="stat">Estadística Base</option>
        `;
        typeSelect.value = existingBonus?.type || 'attribute';
        
        const targetSelect = document.createElement('select');
        updateTargetOptions(targetSelect, typeSelect.value);
        if (existingBonus?.target) {
            targetSelect.value = existingBonus.target;
        }
        
        const valueInput = document.createElement('input');
        valueInput.type = 'number';
        valueInput.min = '-50'; // Aumentar rango
        valueInput.max = '50';  // Aumentar rango
        valueInput.value = existingBonus?.value || '0';
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'btn';
        removeBtn.textContent = 'X';
        removeBtn.onclick = () => bonusDiv.remove();
        
        typeSelect.onchange = () => updateTargetOptions(targetSelect, typeSelect.value);
        
        bonusDiv.appendChild(typeSelect);
        bonusDiv.appendChild(targetSelect);
        bonusDiv.appendChild(valueInput);
        bonusDiv.appendChild(removeBtn);
        
        bonusList.appendChild(bonusDiv);
    }

    function updateTargetOptions(select, type) {
        switch(type) {
            case 'attribute':
                select.innerHTML = `
                    <option value="fuerza">Fuerza Base</option>
                    <option value="inteligencia">Inteligencia Base</option>
                    <option value="agilidad">Agilidad Base</option>
                    <option value="metabolismo">Metabolismo Base</option>
                    <option value="am">A.M Base</option>
                `;
                break;
            case 'current':
                select.innerHTML = `
                    <option value="currentHealth">Vida Actual</option>
                    <option value="currentArmor">Armadura Actual</option>
                    <option value="currentMistyculas">Místyculas Actuales</option>
                `;
                break;
            case 'stat':
                select.innerHTML = `
                    <option value="baseHealth">Vida Base</option>
                    <option value="baseArmor">Armadura Base</option>
                    <option value="baseMistyculas">Místyculas Base</option>
                `;
                break;
        }
    }

    function getBonusList() {
        const bonuses = [];
        document.querySelectorAll('#bonusList .bonus-item').forEach(item => {
            bonuses.push({
                type: item.querySelector('select').value,
                target: item.querySelectorAll('select')[1].value,
                value: parseInt(item.querySelector('input').value) || 0
            });
        });
        return bonuses;
    }

    function removeBonus(index) {
        const bonusList = document.getElementById('bonusList');
        bonusList.children[index].remove();
    }

    function renderBonusItem(bonus) {
        return `
            <select class="bonus-type">
                <option value="attribute" ${bonus.type === 'attribute' ? 'selected' : ''}>Atributo</option>
                <option value="stat" ${bonus.type === 'stat' ? 'selected' : ''}>Estadística</option>
            </select>
            
            <select class="bonus-target">
                ${bonus.type === 'attribute' ? `
                    <option value="fuerza" ${bonus.target === 'fuerza' ? 'selected' : ''}>Fuerza</option>
                    <option value="inteligencia" ${bonus.target === 'inteligencia' ? 'selected' : ''}>Inteligencia</option>
                    <option value="agilidad" ${bonus.target === 'agilidad' ? 'selected' : ''}>Agilidad</option>
                    <option value="metabolismo" ${bonus.target === 'metabolismo' ? 'selected' : ''}>Metabolismo</option>
                    <option value="am" ${bonus.target === 'am' ? 'selected' : ''}>A.M</option>
                ` : `
                    <option value="health" ${bonus.target === 'health' ? 'selected' : ''}>Vida Base</option>
                    <option value="armor" ${bonus.target === 'armor' ? 'selected' : ''}>Armadura Base</option>
                    <option value="mistyculas" ${bonus.target === 'mistyculas' ? 'selected' : ''}>Místyculas Base</option>
                `}
            </select>
            
            <input type="number" class="bonus-value" value="${bonus.value || 0}" min="-20" max="20">
            <button class="btn" onclick="removeBonus()">X</button>
        `;
    }

    function applyBonuses(item) {
        if (!item.bonuses) return;
        
        item.bonuses.forEach(bonus => {
            switch(bonus.type) {
                case 'attribute':
                    // Los atributos base no pueden exceder 30
                    const currentAttr = character.attributes[bonus.target];
                    character.attributes[bonus.target] = Math.min(30, currentAttr + bonus.value);
                    break;
                case 'current':
                    switch(bonus.target) {
                        case 'currentHealth':
                            character.currentHealth += bonus.value;
                            break;
                        case 'currentArmor':
                            character.armor += bonus.value;
                            break;
                        case 'currentMistyculas':
                            character.currentMistyculas += bonus.value;
                            break;
                    }
                    break;
                case 'stat':
                    switch(bonus.target) {
                        case 'baseHealth':
                            character.baseHealth += bonus.value;
                            break;
                        case 'baseArmor':
                            character.baseArmor += bonus.value;
                            break;
                        case 'baseMistyculas':
                            character.baseMistyculas += bonus.value;
                            break;
                    }
                    break;
            }
        });
        
        actualizarTodo();
    }

    function removeBonuses(item) {
        if (!item.bonuses) return;
        
        item.bonuses.forEach(bonus => {
            switch(bonus.type) {
                case 'attribute':
                    character.attributes[bonus.target] = Math.max(10, character.attributes[bonus.target] - bonus.value);
                    break;
                case 'current':
                    switch(bonus.target) {
                        case 'currentHealth':
                            character.currentHealth = Math.max(0, character.currentHealth - bonus.value);
                            break;
                        case 'currentArmor':
                            character.armor -= bonus.value; // Simplemente restar el valor sin límites
                            break;
                        case 'currentMistyculas':
                            character.currentMistyculas = Math.max(0, character.currentMistyculas - bonus.value);
                            break;
                    }
                    break;
                case 'stat':
                    switch(bonus.target) {
                        case 'baseHealth':
                            character.baseHealth = Math.max(25, character.baseHealth - bonus.value);
                            break;
                        case 'baseArmor':
                            character.baseArmor = Math.max(10, character.baseArmor - bonus.value);
                            break;
                        case 'baseMistyculas':
                            character.baseMistyculas = Math.max(100, character.baseMistyculas - bonus.value);
                            break;
                    }
                    break;
            }
        });
        
        actualizarTodo();
    }

    function exportCharacter() {
        const data = JSON.stringify(character, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `personaje_${character.name || 'sin_nombre'}.json`;
        a.click();
        window.URL.revokeObjectURL(url);
    }

    function importCharacter() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        
        input.onchange = function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function(event) {
                try {
                    const loadedCharacter = JSON.parse(event.target.result);
                    character = loadedCharacter;
                    
                    // Aplicar todos los bonus después de cargar
                    applyAllBonuses();
                    
                    // Actualizar listas y UI
                    renderList('skillsList', character.skills);
                    renderList('spellsList', character.spells);
                    renderList('petsList', character.pets);
                    renderList('itemsList', character.items);
                    
                    // Actualizar campos del personaje
                    document.getElementById('charName').value = character.name || '';
                    document.getElementById('charRace').value = character.race || '';
                    document.getElementById('charLang').value = character.languages || '';
                    document.getElementById('charPerso').value = character.personality || '';
                    
                    // Actualizar imagen si existe
                    if(character.image) {
                        document.getElementById('imgContainer').innerHTML = 
                            `<img src="${character.image}" style="width:100%; height:100%; object-fit:cover;">`;
                    }
                    
                    PopupManager.alert('Personaje cargado correctamente');
                } catch (error) {
                    PopupManager.alert('Error al cargar el archivo: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        };
        
        input.click();
    }

    // Añadir esta función para manejar las acciones
    async function useAction(type, cost) {
        if (type === 'hablar') {
            await PopupManager.alert("Acción de hablar realizada");
            return;
        }
        
        if (type === 'legendaria') {
            // Generar costo aleatorio entre 10 y 20
            cost = Math.floor(Math.random() * 11) + 10; // Número aleatorio entre 10 y 20
        }

        if (character.actions.action < cost) {
            await PopupManager.alert(`No tienes suficientes acciones disponibles. Necesitas ${cost} acciones.`);
            return;
        }

        const confirmed = await PopupManager.confirm(
            `¿Deseas usar esta acción? (Costo: ${cost} acciones)`,
            "Confirmar acción"
        );

        if (confirmed) {
            character.actions.action -= cost;
            actualizarAcciones();
            
            let mensaje = `Acción realizada. Acciones restantes: ${character.actions.action}`;
            if (type === 'legendaria') {
                mensaje = `¡Acción legendaria realizada! (Costó ${cost} acciones)\nAcciones restantes: ${character.actions.action}`;
            }
            
            await PopupManager.alert(mensaje);
        }
    }

    function getRaritySelect(currentRarity = 'intrinseca') {
        return `
            <div class="input-group">
                <label>Rareza:</label>
                <select id="itemRarity">
                    ${Object.entries(RARITIES).map(([key, value]) => 
                        `<option value="${key}" ${currentRarity === key ? 'selected' : ''}>${value.name}</option>`
                    ).join('')}
                </select>
            </div>
        `;
    }

    async function editarFormula(listId, id) {
        const item = listId === "skillsList" 
            ? character.skills.find(s => s.id === id)
            : character.spells.find(s => s.id === id);
        
        if (!item) return;

        // Crear un popup personalizado con los botones de fórmula
        const popup = document.createElement('div');
        popup.className = 'custom-popup';
        popup.innerHTML = `
            <div class="popup-content">
                <h3>Editar Fórmula</h3>
                ${createFormulaButtons('editFormulaInput')}
                <div class="popup-buttons">
                    <button class="btn confirm-btn">Aceptar</button>
                    <button class="btn cancel-btn">Cancelar</button>
                </div>
            </div>
        `;
        document.body.appendChild(popup);

        const input = popup.querySelector('#editFormulaInput');
        input.value = item.formula || "";

        return new Promise((resolve) => {
            const confirmBtn = popup.querySelector('.confirm-btn');
            const cancelBtn = popup.querySelector('.cancel-btn');

            confirmBtn.onclick = () => {
                const value = input.value;
                popup.remove();
                
                if (value !== null) {
                    item.formula = value;
                    
                    if (listId === "skillsList") {
                        const index = character.skills.findIndex(s => s.id === id);
                        character.skills[index] = item;
                        renderList('skillsList', character.skills);
                    } else {
                        const index = character.spells.findIndex(s => s.id === id);
                        character.spells[index] = item;
                        renderList('spellsList', character.spells);
                    }
                }
                resolve(value);
            };
            
            cancelBtn.onclick = () => {
                popup.remove();
                resolve(null);
            };
        });
    }

    function applyAllBonuses() {
        // Resetear los valores base
        character.attributes = {
            fuerza: 10,
            inteligencia: 10,
            agilidad: 10,
            metabolismo: 10,
            am: 10
        };
        character.baseHealth = 25;
        character.baseArmor = 10;
        character.baseMistyculas = 100;

        // Aplicar bonus de todos los items
        character.items.forEach(item => {
            if (item.bonuses) {
                applyBonuses(item);
            }
        });

        // Actualizar todo
        actualizarTodo();
    }
  </script>
</body>
</html>
