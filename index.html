<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hoja de Personaje Isekai delivery system By Tkatomon v2.1 </title>
  <style>
    /* . . . . . ESTILOS GLOBALES . . . . . */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      background: #f0f2f5;
      font-family: 'Segoe UI', Roboto, Arial, sans-serif;
      color: #2c3e50;
      line-height: 1.6;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    h1, h2, h3 {
      text-align: center;
      margin-bottom: 15px;
    }
    /* Card Component */
    .card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      text-align: center;
      margin: 20px auto;
      max-width: 900px;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }
    /* Form Elements */
    label {
      font-weight: bold;
      margin-bottom: 5px;
      display: block;
      text-align: center;
    }
    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 90%;
      max-width: 300px;
      padding: 10px;
      margin: 0 auto 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      display: block;
    }
    /* Grid Layout */
    .grid {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }
    .half {
      flex: 1 1 45%;
      min-width: 280px;
    }
    .stats-grid {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      gap: 20px;
      margin-top: 15px;
    }
    .stat {
      background: #f7f9fc;
      border-radius: 8px;
      padding: 15px 20px;
      min-width: 150px;
      text-align: center;
      font-size: 1.1em;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    td[data-element] {
      height: 50px;
      width: 80px;
      color: white;
      font-weight: bold;
      position: relative;
      text-align: center;
      border-radius: 6px;
      cursor: pointer;
      transition: opacity 0.3s;
    }
    td[data-element].active {
      opacity: 1;
    }
    td[data-element]:not(.active) {
      opacity: 0.5;
    }
    td[data-element="fire"]     { background: linear-gradient(145deg, #ff4d4d, #cc0000); }
    td[data-element="air"]      { background: linear-gradient(145deg, #e6e6e6, #cccccc); }
    td[data-element="water"]    { background: linear-gradient(145deg, #4d94ff, #0052cc); }
    td[data-element="electric"] { background: linear-gradient(145deg, #ffff4d, #cccc00); }
    td[data-element="earth"]    { background: linear-gradient(145deg, #994d00, #663300); }
    td[data-element="light"]    { background: linear-gradient(145deg, #ffff99, #ffcc00); }
    td[data-element="dark"]     { background: linear-gradient(145deg, #4d4d4d, #1a1a1a); }
    small {
      display: block;
      text-align: center;
      color: #777;
    }
    /* Buttons */
    .btn {
      background: #2196F3;
      color: #fff;
      border: none;
      padding: 10px 18px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
      font-size: 0.95em;
      transition: background 0.3s;
    }
    .btn:hover {
      background: #1976D2;
    }
    /* Item List */
    .item-list {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 15px;
      background: #f9f9f9;
      min-height: 80px;
      max-width: 800px;
      margin: 0 auto;
    }
    .item {
      margin-bottom: 10px;
      padding: 15px;
      border-radius: 8px;
      transition: transform 0.2s;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .item-header {
      text-align: center;
      font-size: 1.2em;
      font-weight: bold;
    }
    .item-stats {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 5px 0;
    }
    .item-stat {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .item-description {
      text-align: justify;
      margin: 5px 0;
      padding: 0 10px;
    }
    .item-formula {
      position: relative;
      text-align: center;
      font-family: monospace;
      padding: 10px;
      background: rgba(0,0,0,0.05);
      border-radius: 8px;
      margin: 10px 0;
      cursor: help;
      transition: all 0.3s ease;
    }

    .item-formula:hover {
      background: rgba(0,0,0,0.1);
    }

    .item-formula[data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
      white-space: pre-line;
      z-index: 1000;
      min-width: 200px;
      max-width: 400px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }

    .formula-result {
      display: block;
      margin-top: 5px;
      font-size: 1.1em;
      color: #2196F3;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: white;
      border-radius: 8px;
      padding: 20px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      cursor: pointer;
    }
    /* Fórmula Buttons */
    .formula-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 15px 0;
      justify-content: center;
    }
    .formula-btn {
      background: #2196F3;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.3s ease;
    }
    .formula-btn:hover {
      background: #1976D2;
      transform: translateY(-2px);
    }
    /* Stats Input */
    .stats-input {
      text-align: center;
      margin: 15px 0;
    }
    /* Responsive Media Queries */
    @media (max-width: 600px) {
      input[type="text"],
      input[type="number"],
      select,
      textarea {
        max-width: 90%;
      }
      .grid {
        flex-direction: column;
        align-items: center;
      }
      .half {
        width: 100%;
      }
      .stats-grid {
        flex-direction: column;
        align-items: center;
      }
      .stat {
        width: 90%;
        margin-bottom: 10px;
      }
    }
    /* Custom Popup Styles */
    .custom-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      z-index: 10000;
      min-width: 300px;
      text-align: center;
      animation: popupFadeIn 0.3s;
    }
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
    }
    @keyframes popupFadeIn {
      from {
        opacity: 0;
        transform: translate(-50%, -60%);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%);
      }
    }
    .popup-content {
      margin: 20px 0;
    }
    .popup-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    .formula-card {
      background: #f5f5f5;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }
    .formula-card h4 {
      color: #2196F3;
      margin: 0 0 10px 0;
    }
    .formula-result {
      font-family: monospace;
      background: #fff;
      padding: 10px;
      border-radius: 4px;
      border-left: 4px solid #2196F3;
    }
    .modal-form {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .input-group label {
      font-weight: bold;
      color: #34495e;
    }
    .input-group input, 
    .input-group textarea,
    .input-group select {
      padding: 8px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 14px;
    }
    .input-group textarea {
      min-height: 100px;
      resize: vertical;
    }
    .stat-edit-group {
      margin-bottom: 20px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 8px;
    }
    .stat-edit-group label {
      display: block;
      font-weight: bold;
      color: #34495e;
      margin-bottom: 8px;
    }
    .stat-input-pair {
      display: flex;
      gap: 10px;
      margin-top: 5px;
    }
    .stat-input-pair input {
      width: 45%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .stat-edit-group input[type="number"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .formula-section {
      margin-top: 15px;
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 8px;
      background: #f9f9f9;
    }
    .formula-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      justify-content: flex-start;
    }
    .formula-btn {
      background: #2196F3;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.2s;
    }
    .formula-btn:hover {
      background: #1976D2;
      transform: translateY(-2px);
    }
    /* Añadir estos estilos */
    .combat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 20px 0;
      padding: 15px;
    }

    .combat-section {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .combat-section h3 {
      color: #34495e;
      margin-bottom: 10px;
    }

    .combat-section input {
      width: 80%;
      margin-bottom: 10px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .equipment-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      padding: 20px;
    }

    .equipment-slot {
      background: #f5f5f5;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      min-height: 150px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .equipment-slot h3 {
      margin: 0;
      font-size: 1em;
      color: #666;
    }

    .slot-content {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fff;
      border-radius: 4px;
      padding: 10px;
    }

    .slot-content.empty {
      color: #999;
      font-style: italic;
    }

    .equipment-item {
      width: 100%;
      padding: 10px;
      background: #fff;
      border-radius: 4px;
      cursor: pointer;
    }

    .stat-edit-group {
      margin-bottom: 20px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 8px;
    }

    .stat-edit-group label {
      display: block;
      font-weight: bold;
      color: #34495e;
      margin-bottom: 8px;
    }

    .stat-input-pair {
      display: flex;
      gap: 10px;
      margin-top: 5px;
    }

    .stat-input-pair input {
      width: 45%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .stat-edit-group input[type="number"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .actions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 15px;
      padding: 10px;
    }
    .action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 15px;
      background: #2c3e50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      min-height: 80px;
    }
    .action-btn:not(:disabled):hover {
      transform: translateY(-2px);
      background: #34495e;
    }
    .action-btn:disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }
    .action-cost {
      font-size: 0.8em;
      color: #ecf0f1;
    }
    /* Responsive Styles */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .card {
        padding: 15px;
        margin: 10px auto;
      }
      
      .grid {
        gap: 10px;
      }
      
      .stats-grid {
        gap: 10px;
      }
      
      .stat {
        min-width: unset;
        width: 100%;
        font-size: 0.95em;
      }
      
      table {
        font-size: 0.9em;
      }
      
      td[data-element] {
        height: 40px;
        width: 60px;
      }
      
      .combat-grid {
        grid-template-columns: 1fr;
      }
      
      .actions-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .item {
        padding: 10px;
      }
      
      .item-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        justify-content: center;
      }
      
      .btn {
        padding: 8px 12px;
        font-size: 0.9em;
      }
      
      .modal-content {
        width: 95%;
        padding: 15px;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.5em;
      }
      
      h2 {
        font-size: 1.3em;
      }
      
      .actions-grid {
        grid-template-columns: 1fr;
      }
      
      .combat-section input {
        width: 100%;
      }
      
      .item-buttons {
        flex-direction: column;
      }
      
      table {
        font-size: 0.8em;
      }
      
      td[data-element] {
        height: 35px;
        width: 50px;
      }
    }

    /* Estilos para rarezas */
    .item[data-rarity="intrinseca"] {
        background: linear-gradient(145deg, #808080, #696969);
        border: 1px solid #404040;
        color: #000000;
    }

    .item[data-rarity="comun"] {
        background: linear-gradient(145deg, #4CAF50, #45a049);
        border: 1px solid #2e7d32;
        color: #000000;
    }

    .item[data-rarity="epica"] {
        background: linear-gradient(145deg, #673AB7, #5E35B1);
        border: 1px solid #4A148C;
        color: #000000;
    }

    .item[data-rarity="legendario"] {
        background: linear-gradient(145deg, #FFD700, #FFC400);
        border: 2px solid #B8860B;
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        color: #000000;
    }

    .item[data-rarity="mitico"] {
        background: linear-gradient(145deg, #FF0000, #CC0000);
        border: 2px solid #000000;
        box-shadow: 0 0 15px rgba(255, 0, 0, 0.3);
        color: #FFD700;
        text-shadow: 1px 1px 1px #000000;
    }

    .item[data-rarity="genesis"] {
        background: linear-gradient(145deg, #00BCD4, #4CAF50);
        border: 2px solid #000000;
        box-shadow: 0 0 20px rgba(0, 188, 212, 0.4);
        color: #FFD700;
        text-shadow: 1px 1px 1px #000000;
    }

    /* Asegurarse que los encabezados mantengan el color correcto */
    .item[data-rarity="intrinseca"] .item-header,
    .item[data-rarity="comun"] .item-header,
    .item[data-rarity="epica"] .item-header {
        color: #000000;
    }

    .item[data-rarity="mitico"] .item-header,
    .item[data-rarity="genesis"] .item-header {
        color: #FFD700;
        text-shadow: 1px 1px 1px #000000;
    }

    .item[data-rarity="legendario"] .item-header {
        color: #000000;
    }

    .formula-input {
        width: 100%;
        padding: 8px;
        margin: 10px 0;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-family: monospace;
    }

    .formula-categories {
        margin-top: 15px;
        padding: 10px;
        background: #f5f5f5;
        border-radius: 8px;
    }

    .formula-category {
        margin-bottom: 15px;
    }

    .formula-category h4 {
        color: #2196F3;
        margin-bottom: 8px;
    }

    .formula-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
    }

    .custom-popup .popup-content {
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    }

    .pet-info {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
        margin: 10px 0;
    }

    .pet-attributes {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 10px;
        margin: 10px 0;
        padding: 10px;
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
    }

    .pet-attribute {
        text-align: center;
    }

    .pet-attribute label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .pet-stats {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 10px 0;
        padding: 10px;
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
    }

    .pet-stat {
        text-align: center;
    }

    .pet-abilities, .pet-stats, .pet-abilities {
        margin: 10px 0;
        padding: 8px;
        background: white;
        border-radius: 4px;
    }

    .pet-abilities p {
        font-style: italic;
        color: #666;
    }

    .slot-item {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        align-items: center;
    }

    .slot-item input {
        flex: 1;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background: #f5f5f5;
    }

    .slot-item button {
        padding: 8px 12px;
    }

    .item-bonuses {
        margin: 10px 0;
        padding: 10px;
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
    }

    .bonus-entry {
        padding: 5px;
        margin: 5px 0;
        border-radius: 4px;
        background: rgba(255,255,255,0.1);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Datos del Personaje -->
    <div class="card">
      <h1>Hoja de Personaje RPG</h1>
      <div class="grid">
        <div class="half">
          <label for="charName">Nombre</label>
          <input type="text" id="charName" placeholder="Nombre del personaje">
          <label for="charRace">Raza</label>
          <input type="text" id="charRace" placeholder="Raza del personaje">
          <label for="charLang">Idiomas</label>
          <input type="text" id="charLang" placeholder="Ej: Español, Inglés">
          <label for="charPerso">Personalidad</label>
          <input type="text" id="charPerso" placeholder="Personalidad">
        </div>
        <div class="half">
          <label>Imagen</label>
          <div id="imgContainer" style="width:90%; height:220px; border:2px dashed #ccc; display:flex; align-items:center; justify-content:center; cursor:pointer; margin: auto;">
            <span>Click para cargar imagen</span>
          </div>
          <input type="file" id="imgUpload" style="display:none;">
        </div>
      </div>
    </div>

    <!-- Elementos -->
    <div class="card">
      <h2 style="font-size:1.8em; color:#34495e; margin-bottom:20px;">Elementos</h2>
      <table>
        <tr>
          <th>Fuego</th>
          <th>Aire</th>
          <th>Agua</th>
          <th>Eléctrico</th>
          <th>Tierra</th>
          <th>Luz</th>
          <th>Oscuridad</th>
        </tr>
        <tr>
          <td data-element="fire"><input type="number" id="elemFire" value="10" min="10" max="100"></td>
          <td data-element="air"><input type="number" id="elemAir" value="10" min="10" max="100"></td>
          <td data-element="water"><input type="number" id="elemWater" value="10" min="10" max="100"></td>
          <td data-element="electric"><input type="number" id="elemElectro" value="10" min="10" max="100"></td>
          <td data-element="earth"><input type="number" id="elemEarth" value="10" min="10" max="100"></td>
          <td data-element="light"><input type="number" id="elemLight" value="10" min="10" max="100"></td>
          <td data-element="dark"><input type="number" id="elemDark" value="10" min="10" max="100"></td>
        </tr>
      </table>
    </div>

    <!-- Atributos -->
    <div class="card">
      <div class="grid">
        <div class="half">
          <h2>Atributos</h2>
          <table>
            <thead>
              <tr>
                <th>Fuerza</th>
                <th>Inteligencia</th>
                <th>Agilidad</th>
                <th>Metabolismo</th>
                <th>A.M</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <input type="number" id="attrFuerza" value="10" min="10">
                  <div id="modFuerza">0</div>
                </td>
                <td>
                  <input type="number" id="attrInt" value="10" min="10">
                  <div id="modInt">0</div>
                </td>
                <td>
                  <input type="number" id="attrAgil" value="10" min="10">
                  <div id="modAgil">0</div>
                </td>
                <td>
                  <input type="number" id="attrMetab" value="10" min="10">
                  <div id="modMetab">0</div>
                </td>
                <td>
                  <input type="number" id="attrAM" value="10" min="10">
                  <div id="modAM">0</div>
                </td>
              </tr>
            </tbody>
          </table>
          <small>Modificador = (Valor - 10) / 2</small>
        </div>
      </div>
    </div>

    <!-- Estadísticas -->
    <div class="card">
      <h2>Estadísticas</h2>
      <div class="stats-grid">
        <div class="stat">Vida: <span id="calcVida">0 / 0</span></div>
        <div class="stat">Armadura: <span id="calcArmor">10</span></div>
        <div class="stat">Místyculas: <span id="calcMistyculas">0 / 0</span></div>
        <div class="stat">XP: <span id="calcXP">0 / 0</span></div>
        <div class="stat">Nivel: <span id="calcNivel">1 / 20</span></div>
      </div>
      <div class="stats-input">
        <input type="number" id="inputXP" placeholder="Añadir XP" value="0" min="0" style="width:80px;">
        <button class="btn" onclick="agregarXP()">Añadir XP</button>
      </div>
      <div style="text-align:center;">
        <button class="btn" onclick="actualizarTodo()">Actualizar Estadísticas</button>
        <button class="btn" onclick="openStatsEditModal()">Editar Estadísticas</button>
      </div>
    </div>

    <!-- Equipamiento -->
    <div class="card">
        <h2>Equipamiento</h2>
        <div style="text-align: right; margin-bottom: 10px;">
            <button class="btn" onclick="openEquipSlotModal()">Gestionar Slots</button>
        </div>
        <div class="equipment-grid" id="equipmentGrid">
            <div class="equipment-slot" data-slot="mainHand">
                <h3>Mano Principal</h3>
                <div class="slot-content empty">Vacío</div>
            </div>
            <div class="equipment-slot" data-slot="offHand">
                <h3>Mano Secundaria</h3>
                <div class="slot-content empty">Vacío</div>
            </div>
            <div class="equipment-slot" data-slot="head">
                <h3>Cabeza</h3>
                <div class="slot-content empty">Vacío</div>
            </div>
            <div class="equipment-slot" data-slot="chest">
                <h3>Pecho</h3>
                <div class="slot-content empty">Vacío</div>
            </div>
            <div class="equipment-slot" data-slot="legs">
                <h3>Piernas</h3>
                <div class="slot-content empty">Vacío</div>
            </div>
            <div class="equipment-slot" data-slot="feet">
                <h3>Pies</h3>
                <div class="slot-content empty">Vacío</div>
            </div>
            <div class="equipment-slot" data-slot="accessory1">
                <h3>Accesorio 1</h3>
                <div class="slot-content empty">Vacío</div>
            </div>
            <div class="equipment-slot" data-slot="accessory2">
                <h3>Accesorio 2</h3>
                <div class="slot-content empty">Vacío</div>
            </div>
        </div>
    </div>

    <!-- Fórmulas Avanzadas -->
    <div class="card" style="text-align:center;">
      <button class="btn" onclick="openModal('formulasModal')">Mostrar Fórmulas Avanzadas</button>
    </div>

    <!-- Acciones y Combate -->
    <div class="card">
        <h2 style="font-size:1.8em; color:#34495e; margin-bottom:20px;">Acciones y Combate</h2>
        
        <div class="stats-grid">
            <div class="stat">
                Acciones: <span id="currentActions">0</span>/<span id="maxActions">0</span>
            </div>
        </div>

        <div class="combat-grid">
            <div class="combat-section">
                <h3>Daño</h3>
                <input type="number" id="inputDamage" value="0" min="0">
                <button class="btn" onclick="aplicarDaño()">Aplicar Daño</button>
            </div>
            
            <div class="combat-section">
                <h3>Curación</h3>
                <input type="number" id="inputHeal" value="0" min="0">
                <button class="btn" onclick="aplicarCura()">Aplicar Cura</button>
            </div>
            
            <div class="combat-section">
                <h3>Místyculas</h3>
                <input type="number" id="inputMistyRegen" value="0" min="0">
                <button class="btn" onclick="regenerarMisty()">Recuperar</button>
            </div>
        </div>

        <div class="actions-grid">
            <button class="action-btn" onclick="useAction('hablar', 0)" data-action-type="hablar">
                Hablar (Sin coste)
            </button>
            <button class="action-btn" onclick="useAction('minor', 1)" data-action-type="minor">
                Acción Menor (1 acción)
            </button>
            <button class="action-btn" onclick="useAction('object', 1)" data-action-type="object">
                Acción de Objeto (1 acción)
            </button>
            <button class="action-btn" onclick="useAction('complex', 2)" data-action-type="complex">
                Acción Compleja (2 acciones)
            </button>
            <button class="action-btn" onclick="useAction('reaction', 3)" data-action-type="reaction">
                Reacción (3 acciones)
            </button>
            <button class="action-btn" onclick="useAction('bonus')" data-action-type="bonus">
                Acción Bonus (+1 acción)
            </button>
            <button class="action-btn" onclick="useAction('legendary')" data-action-type="legendary">
                Acción Legendaria (20 acciones)
            </button>
        </div>
    </div>

    <!-- Secciones para Habilidades, Técnicas & Hechizos, Mascotas y Objetos -->
    <div class="card">
      <h2>Habilidades</h2>
      <div class="item-list" id="skillsList"></div>
      <div style="text-align:center;">
        <button class="btn" onclick="openModal('skillModal')">Agregar Habilidad</button>
      </div>
    </div>

    <div class="card">
      <h2>Técnicas & Hechizos</h2>
      <div class="spell-info">
        <div class="slots-counter">
          <span class="slots-text">Slots Disponibles:</span>
          <span class="slots-numbers" id="spellSlots">0/0</span>
        </div>
      </div>
      <div class="item-list" id="spellsList"></div>
      <div style="text-align:center;">
        <button class="btn" onclick="openModal('spellModal')">Agregar Técnica/Hechizo</button>
      </div>
    </div>

    <div class="card">
      <h2>Mascotas</h2>
      <div class="item-list" id="petsList"></div>
      <div style="text-align:center;">
        <button class="btn" onclick="openModal('petModal')">Agregar / Editar Mascota</button>
      </div>
    </div>
    <div class="card">
      <h2>Objetos</h2>
      <div class="item-list" id="itemsList"></div>
      <div style="text-align:center;">
        <button class="btn" onclick="openModal('itemModal')">Agregar / Editar Objeto</button>
      </div>
    </div>

    <!-- Gestión de Personaje -->
    <div class="card">
      <h2>Gestión de Personaje</h2>
      <div style="text-align:center;">
        <button class="btn" onclick="exportCharacter()">Exportar Personaje</button>
        <button class="btn" onclick="importCharacter()">Importar Personaje</button>
      </div>
    </div>
  </div>

  <!-- Modal Genérico -->
  <div id="modalOverlay" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal()">×</span>
      <div id="modalBody"></div>
      <button class="btn" id="modalSaveBtn">Guardar</button>
    </div>
  </div>

  <script>
    const RARITIES = {
        intrinseca: { name: "Intrínseca", color: "#808080", textColor: "black" },
        comun: { name: "Común", color: "#4CAF50", textColor: "black" },
        epica: { name: "Épica", color: "#9C27B0", textColor: "#FFD700" },
        legendario: { name: "Legendario", color: "#FFD700", textColor: "black" },
        mitico: { name: "Mítico", color: "#FF0000", textColor: "#FFD700", border: "2px solid black" },
        genesis: { name: "Génesis", color: "linear-gradient(45deg, #4CAF50, #2196F3)", textColor: "#FFD700", border: "2px solid black" }
    };

    let currentFormulaInput = null;
    const expTable = [
      { level: 1, exp: 0 }, { level: 2, exp: 1000 }, { level: 3, exp: 3000 },
      { level: 4, exp: 6000 }, { level: 5, exp: 10000 }, { level: 6, exp: 15000 },
      { level: 7, exp: 21000 }, { level: 8, exp: 28000 }, { level: 9, exp: 36000 },
      { level: 10, exp: 45000 }, { level: 11, exp: 55000 }, { level: 12, exp: 66000 },
      { level: 13, exp: 78000 }, { level: 14, exp: 91000 }, { level: 15, exp: 105000 },
      { level: 16, exp: 120000 }, { level: 17, exp: 136000 }, { level: 18, exp: 153000 },
      { level: 19, exp: 171000 }, { level: 20, exp: 190000 }
    ];
    let character = {
      name: "", race: "", languages: "", personality: "", image: null,
      elements: { fire: 10, air: 10, water: 10, electro: 10, earth: 10, light: 10, dark: 10 },
      attributes: { fuerza: 10, inteligencia: 10, agilidad: 10, metabolismo: 10, am: 10 },
      baseHealth: 25, currentHealth: 25, maxHealth: 25,
      baseArmor: 10, armor: 10,
      baseMistyculas: 100, currentMistyculas: 100, maxMistyculas: 100,
      experience: 0, level: 1,
      actions: { 
        maxActions: 0,
        currentActions: 0,
        minor: true, 
        object: true, 
        complex: true, 
        reaction: true, 
        bonus: true, 
        legendary: true
      },
      skills: [], spells: [], pets: [], items: [],
      spellSystem: {
        slots: 3,
        maxSlots: 12,
        unlockedSlots: []
      },
      equipment: {
        mainHand: null,
        offHand: null,
        head: null,
        chest: null,
        legs: null,
        feet: null,
        accessory1: null,
        accessory2: null
      },
      petSystem: {
        stats: {
          baseHealth: 25,
          baseArmor: 10
        }
      }
    };

    const FORMULA_ELEMENTS = {
        attributes: [
            { id: 'Fuerza', display: 'Fuerza' },
            { id: 'Inteligencia', display: 'Inteligencia' },
            { id: 'Agilidad', display: 'Agilidad' },
            { id: 'Metabolismo', display: 'Metabolismo' },
            { id: 'A.M', display: 'A.M' }
        ],
        mods: [
            { id: 'FuerzaMod', display: 'Mod. Fuerza' },
            { id: 'InteligenciaMod', display: 'Mod. Int' },
            { id: 'AgilidadMod', display: 'Mod. Agi' },
            { id: 'MetabolismoMod', display: 'Mod. Met' },
            { id: 'AMMod', display: 'Mod. A.M' }
        ],
        stats: [
            { id: 'Mistyculas', display: 'Místyculas' },
            { id: 'Armadura', display: 'Armadura' },
            { id: 'VidaBase', display: 'Vida Base' },
            { id: 'VidaActual', display: 'Vida Actual' }
        ],
        dice: [
            { id: 'd', display: 'd' },
            { id: 'd4', display: 'd4' },
            { id: 'd6', display: 'd6' },
            { id: 'd8', display: 'd8' },
            { id: 'd10', display: 'd10' },
            { id: 'd12', display: 'd12' },
            { id: 'd20', display: 'd20' },
            { id: 'd100', display: 'd100' }
        ],
        operators: [
            { id: '+', display: '+' },
            { id: '-', display: '-' },
            { id: '*', display: '×' },
            { id: '/', display: '÷' },
            { id: '(', display: '(' },
            { id: ')', display: ')' }
        ]
    };

    function createFormulaButtons(targetId) {
        return `
            <div class="formula-section">
                <label>Fórmula:</label>
                <input type="text" id="${targetId}" class="formula-input" placeholder="Ej: 2d6 + FuerzaMod">
                <div class="formula-categories">
                    ${Object.entries(FORMULA_ELEMENTS).map(([category, elements]) => `
                        <div class="formula-category">
                            <h4>${category.charAt(0).toUpperCase() + category.slice(1)}</h4>
                            <div class="formula-buttons">
                                ${elements.map(el => `
                                    <button class="formula-btn" type="button" 
                                        onclick="insertFormula('${el.id}', '${targetId}')"
                                        title="${el.display}">
                                        ${el.display}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    function calcularMod(valor) { return Math.floor((valor - 10) / 2); }
    function actualizarAtributos() {
      document.getElementById("modFuerza").textContent = calcularMod(character.attributes.fuerza);
      document.getElementById("modInt").textContent = calcularMod(character.attributes.inteligencia);
      document.getElementById("modAgil").textContent = calcularMod(character.attributes.agilidad);
      document.getElementById("modMetab").textContent = calcularMod(character.attributes.metabolismo);
      document.getElementById("modAM").textContent = calcularMod(character.attributes.am);
    }
    function actualizarNivelXP() {
      let lvl = 1, baseXP = 0;
      for (let i = 0; i < expTable.length; i++) {
        if (character.experience >= expTable[i].exp) { 
          lvl = expTable[i].level; 
          baseXP = expTable[i].exp; 
        } else break;
      }
      character.level = lvl;
      const next = expTable.find(e => e.level === lvl + 1);
      const xpExcess = character.experience - baseXP;
      const xpNeeded = next ? next.exp - baseXP : 0;
      document.getElementById("calcXP").textContent = xpExcess + " / " + xpNeeded;
      document.getElementById("calcNivel").textContent = character.level + " / 20";
    }
    function actualizarVida() {
      const modMet = calcularMod(character.attributes.metabolismo);
      character.maxHealth = Math.floor(character.baseHealth * character.level * (modMet > 0 ? modMet : 1));
      if (character.currentHealth > character.maxHealth) character.currentHealth = character.maxHealth;
      document.getElementById("calcVida").textContent = character.currentHealth + " / " + character.maxHealth;
    }
    function actualizarArmor() {
        const modAgil = calcularMod(character.attributes.agilidad);
        const modMet = calcularMod(character.attributes.metabolismo);
        // Calcular armadura base con modificadores
        const armorBase = character.baseArmor + modAgil + modMet;
        // Mostrar armadura actual / armadura base
        document.getElementById("calcArmor").textContent = `${character.armor} / ${armorBase}`;
    }
    function actualizarMistyculas() {
      const modInt = calcularMod(character.attributes.inteligencia);
      const modAM = calcularMod(character.attributes.am);
      character.maxMistyculas = character.baseMistyculas * (modInt > 0 ? modInt : 1) * (modAM > 0 ? modAM : 1);
      if (character.currentMistyculas > character.maxMistyculas) character.currentMistyculas = character.maxMistyculas;
      document.getElementById("calcMistyculas").textContent = character.currentMistyculas + " / " + character.maxMistyculas;
    }
    function actualizarAcciones() {
        document.getElementById('currentActions').textContent = character.actions.currentActions;
        document.getElementById('maxActions').textContent = character.actions.maxActions;
        
        document.querySelectorAll('.action-btn').forEach(btn => {
            const actionType = btn.dataset.actionType;
            btn.disabled = !character.actions[actionType];
        });
    }
    function actualizarTodo() {
        actualizarAtributos();
        actualizarNivelXP();
        actualizarVida();
        actualizarArmor();
        actualizarMistyculas();
        
        // Recalcular acciones máximas y restablecer acciones actuales
        const modAgil = calcularMod(character.attributes.agilidad);
        character.actions.maxActions = 1 + character.level + modAgil;
        character.actions.currentActions = character.actions.maxActions; // Restablecer al máximo
        
        actualizarAcciones();
        actualizarSlots();
    }
    function actualizarSlots() {
        // Calcular slots basados en el nivel
        if (character.level >= 10) {
            character.spellSystem.slots = 12; // Máximo en nivel 10+
        } else if (character.level >= 5) {
            character.spellSystem.slots = 5;  // 5 slots en nivel 5-9
        } else {
            character.spellSystem.slots = 3;  // 3 slots en nivel 1-4
        }
        
        // Actualizar display
        document.getElementById('spellSlots').textContent = 
            `${character.spells.length}/${character.spellSystem.slots}`;
    }
    function agregarXP() {
      const xp = parseInt(document.getElementById("inputXP").value);
      if (isNaN(xp) || xp < 0) return;
      character.experience += xp;
      actualizarTodo();
    }
    function resetAcciones() {
      actualizarAcciones();
      character.actions.minor = 1;
      character.actions.bonus = 1;
      character.actions.interaction = 1;
    }
    function aplicarDaño() {
      const dmg = parseInt(document.getElementById("inputDamage").value);
      if (isNaN(dmg) || dmg < 0) return;
      character.currentHealth -= dmg;
      if (character.currentHealth < 0) character.currentHealth = 0;
      actualizarVida();
      document.getElementById("inputDamage").value = 0;
    }
    function aplicarCura() {
      const cura = parseInt(document.getElementById("inputHeal").value);
      if (isNaN(cura) || cura < 0) return;
      character.currentHealth += cura;
      if (character.currentHealth > character.maxHealth) character.currentHealth = character.maxHealth;
      actualizarVida();
      document.getElementById("inputHeal").value = 0;
    }
    function regenerarMisty() {
      const regen = parseInt(document.getElementById("inputMistyRegen").value);
      if (isNaN(regen) || regen < 0) return;
      character.currentMistyculas += regen;
      if (character.currentMistyculas > character.maxMistyculas) character.currentMistyculas = character.maxMistyculas;
      actualizarMistyculas();
      document.getElementById("inputMistyRegen").value = 0;
    }
    // Eventos para atributos
    document.getElementById("attrFuerza").addEventListener("change", () => {
      character.attributes.fuerza = parseInt(document.getElementById("attrFuerza").value);
      actualizarTodo();
    });
    document.getElementById("attrInt").addEventListener("change", () => {
      character.attributes.inteligencia = parseInt(document.getElementById("attrInt").value);
      actualizarTodo();
    });
    document.getElementById("attrAgil").addEventListener("change", () => {
      character.attributes.agilidad = parseInt(document.getElementById("attrAgil").value) || 10;
      const modAgil = calcularMod(character.attributes.agilidad);
      character.actions.maxActions = 1 + character.level + modAgil;
      character.actions.currentActions = character.actions.maxActions;
      actualizarTodo();
    });
    document.getElementById("attrMetab").addEventListener("change", () => {
      character.attributes.metabolismo = parseInt(document.getElementById("attrMetab").value);
      actualizarTodo();
    });
    document.getElementById("attrAM").addEventListener("change", () => {
      character.attributes.am = parseInt(document.getElementById("attrAM").value);
      actualizarTodo();
    });
    // Datos del personaje
    document.getElementById("charName").addEventListener("change", function() { character.name = this.value; });
    document.getElementById("charRace").addEventListener("change", function() { character.race = this.value; });
    document.getElementById("charLang").addEventListener("change", function() { character.languages = this.value; });
    document.getElementById("charPerso").addEventListener("change", function() { character.personality = this.value; });
    // Imagen
    document.getElementById("imgContainer").addEventListener("click", function() {
      document.getElementById("imgUpload").click();
    });
    document.getElementById("imgUpload").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        character.image = ev.target.result;
        document.getElementById("imgContainer").innerHTML = `<img src="${character.image}" style="width:100%; height:100%; object-fit:cover;">`;
      }
      reader.readAsDataURL(file);
    });

    // Modal Genérico
    const modalOverlay = document.getElementById("modalOverlay");
    const modalBody = document.getElementById("modalBody");
    const modalSaveBtn = document.getElementById("modalSaveBtn");
    let modalCallback = null;
    async function openModal(modalId, itemId = null) {
      modalOverlay.style.display = "flex";
      
      if(modalId === 'formulasModal') {
          const modFuerza = calcularMod(character.attributes.fuerza);
          const modAgil = calcularMod(character.attributes.agilidad);
          const modMet = calcularMod(character.attributes.metabolismo);
          const modInt = calcularMod(character.attributes.inteligencia);
          
          const formulas = {
              vida: `${character.baseHealth} × ${character.level} × ${modMet > 0 ? modMet : 1} = ${character.maxHealth}`,
              armor: `${character.baseArmor} + ${modAgil} + ${modMet} = ${character.armor}`,
              misty: `${character.baseMistyculas} × ${modInt > 0 ? modInt : 1} × ${calcularMod(character.attributes.am) > 0 ? calcularMod(character.attributes.am) : 1} = ${character.maxMistyculas}`,
              daño: `Daño Arma + ${modFuerza} = Daño Base + ${modFuerza}`,
              movimiento: `(${modFuerza} + ${modAgil}) × 10 = ${(modFuerza + modAgil) * 10} pies`,
              carga: `(${modMet} + ${modFuerza}) × 10 = ${(modMet + modFuerza) * 10} libras`,
              resistencia: `${character.level} + ${modMet} = ${character.level + modMet}`,
              tamaño: `${modMet} × 10 = ${modMet * 10}`,
              altura: `${modMet * 10} × 10 = ${modMet * 100} cm`,
              peso: `${modMet * 10} × 5 = ${modMet * 50} kg`,
              sabiduria: `${modInt} + ${character.level} = ${modInt + character.level}`
          };

          modalBody.innerHTML = `
              <h3>Fórmulas Avanzadas</h3>
              <div class="formula-card">
                  <h4>Vida Máxima:</h4>
                  <p>Vida Base × Nivel × (Mod Metabolismo > 0 ? Mod Metabolismo : 1)</p>
                  <p class="formula-result">${formulas.vida}</p>
              </div>
              <div class="formula-card">
                  <h4>Armadura:</h4>
                  <p>Base + Mod Agilidad + Mod Metabolismo</p>
                  <p class="formula-result">${formulas.armor}</p>
              </div>
              <div class="formula-card">
                  <h4>Místyculas Máximas:</h4>
                  <p>Base × (Mod Inteligencia > 0 ? Mod Inteligencia : 1) × (Mod A.M > 0 ? Mod A.M : 1)</p>
                  <p class="formula-result">${formulas.misty}</p>
              </div>
              <div class="formula-card">
                  <h4>Daño Cuerpo a Cuerpo:</h4>
                  <p>Daño del arma + Mod Fuerza</p>
                  <p class="formula-result">${formulas.daño}</p>
              </div>
              <div class="formula-card">
                  <h4>Movimiento:</h4>
                  <p>(Mod Fuerza + Mod Agilidad) × 10</p>
                  <p class="formula-result">${formulas.movimiento}</p>
              </div>
              <div class="formula-card">
                  <h4>Capacidad de Carga:</h4>
                  <p>(Mod Metabolismo + Mod Fuerza) × 10</p>
                  <p class="formula-result">${formulas.carga}</p>
              </div>
              <div class="formula-card">
                  <h4>Resistencia a Efectos:</h4>
                  <p>Nivel + Mod Metabolismo</p>
                  <p class="formula-result">${formulas.resistencia}</p>
              </div>
              <div class="formula-card">
                  <h4>Tamaño Corporal:</h4>
                  <p>Mod Metabolismo × 10</p>
                  <p class="formula-result">${formulas.tamaño}</p>
              </div>
              <div class="formula-card">
                  <h4>Altura Aproximada:</h4>
                  <p>Tamaño × 10 cm</p>
                  <p class="formula-result">${formulas.altura}</p>
              </div>
              <div class="formula-card">
                  <h4>Peso Aproximado:</h4>
                  <p>Tamaño × 5 kg</p>
                  <p class="formula-result">${formulas.peso}</p>
              </div>
              <div class="formula-card">
                  <h4>Sabiduría:</h4>
                  <p>Mod Inteligencia + Nivel</p>
                  <p class="formula-result">${formulas.sabiduria}</p>
              </div>
          `;
      }
      
      if (modalId === 'skillModal') {
          await handleSkillModal(itemId);
      }

      if (modalId === 'spellModal') {
          await handleSpellModal(itemId);
      }

      if(modalId === 'petModal') {
        openPetModal(itemId);
      }
      
      if(modalId === 'itemModal') {
        const item = itemId ? character.items.find(i => i.id === itemId) : null;
        modalBody.innerHTML = `
            <h3>${itemId ? "Editar" : "Agregar"} Objeto</h3>
            <div class="modal-form">
                <div class="input-group">
                    <label>Nombre:</label>
                    <input type="text" id="itemName" value="${item?.name || ''}" required>
                </div>
                <div class="input-group">
                    <label>Tipo:</label>
                    <select id="itemType">
                        <option value="weapon" ${item?.type === 'weapon' ? 'selected' : ''}>Arma</option>
                        <option value="armor" ${item?.type === 'armor' ? 'selected' : ''}>Armadura</option>
                        <option value="accessory" ${item?.type === 'accessory' ? 'selected' : ''}>Accesorio</option>
                        <option value="tool" ${item?.type === 'tool' ? 'selected' : ''}>Herramienta</option>
                    </select>
                </div>
                ${getRaritySelect(item?.rarity || 'intrinseca')}
                <div class="input-group">
                    <label>Descripción:</label>
                    <textarea id="itemDesc">${item?.desc || ''}</textarea>
                </div>
                <div class="input-group">
                    <label>Bonuses:</label>
                    <div id="bonusList"></div>
                    <button class="btn" type="button" onclick="addBonus()">Añadir Bonus</button>
                </div>
            </div>
        `;

        if (item?.bonuses) {
            item.bonuses.forEach(bonus => addBonus(bonus));
        }

        modalCallback = function() {
            const newItem = createItem({
                id: item ? item.id : Date.now().toString(),
                name: document.getElementById('itemName').value,
                type: document.getElementById('itemType').value,
                rarity: document.getElementById('itemRarity').value,
                desc: document.getElementById('itemDesc').value,
                bonuses: getBonusList()
            });

            if (!validateItem(newItem)) return;

            if (itemId) {
                const oldItem = character.items.find(i => i.id === itemId);
                if (oldItem) {
                    removeBonuses(oldItem);
                }
                const index = character.items.findIndex(i => i.id === itemId);
                character.items[index] = newItem;
            } else {
                character.items.push(newItem);
            }
            
            applyBonuses(newItem);
            renderList('itemsList', character.items);
            actualizarTodo();
        };
      }
    }
    function closeModal() {
      modalOverlay.style.display = "none";
      modalBody.innerHTML = "";
      modalCallback = null;
    }
    modalSaveBtn.addEventListener("click", function() {
      if (modalCallback) modalCallback();
      closeModal();
    });
    // Insertar texto en fórmula
    function insertFormula(text, inputId) {
      const input = document.getElementById(inputId);
      const start = input.selectionStart;
      const end = input.selectionEnd;
      const currentValue = input.value;
      
      // Insertar el texto en la posición del cursor
      input.value = currentValue.substring(0, start) + text + currentValue.substring(end);
      
      // Colocar el cursor después del texto insertado
      const newCursorPos = start + text.length;
      input.setSelectionRange(newCursorPos, newCursorPos);
      input.focus();
    }
    function renderList(elementId, list) {
        const container = document.getElementById(elementId);
        if (!container) {
            console.error(`Contenedor ${elementId} no encontrado`);
            return;
        }
        
        container.innerHTML = "";
        
        if (!list || list.length === 0) {
            container.innerHTML = "<p>No hay elementos.</p>";
            return;
        }
        
        list.forEach(item => {
            const div = document.createElement("div");
            div.className = "item";
            div.setAttribute('data-rarity', item.rarity || 'intrinseca');
            
            if (elementId === 'skillsList' || elementId === 'spellsList') {
                const formulaResult = item.formula ? resolverFormula(item.formula) : null;
                
                div.innerHTML = `
                    <div class="item-header">${item.name}</div>
                    <div class="item-content">
                        ${elementId === 'spellsList' ? `
                            <div class="item-type">
                                <strong>Tipo:</strong> ${item.type}
                            </div>
                        ` : ''}
                        
                        <div class="item-stats">
                            <div class="item-stat">
                                <span>Acciones:</span>
                                <strong>${item.actionCost}</strong>
                            </div>
                            <div class="item-stat">
                                <span>Místyculas:</span>
                                <strong>${item.mistyCost}</strong>
                            </div>
                        </div>
                        
                        <div class="item-description">
                            <strong>Descripción:</strong> ${item.desc || 'Sin descripción'}
                        </div>
                        
                        ${item.formula ? `
                            <div class="item-formula">
                                <strong>Fórmula:</strong> ${item.formula}
                            </div>
                        ` : ''}
                        
                        <div class="item-buttons">
                            <button class="btn" onclick="editarItem('${elementId}', '${item.id}')">Editar</button>
                            <button class="btn" onclick="eliminarItem('${elementId}', '${item.id}')">Eliminar</button>
                            <button class="btn" onclick="usarItem('${elementId}', '${item.id}')">Usar</button>
                        </div>
                    </div>
                `;
                
                div.setAttribute('data-rarity', item.rarity || 'intrinseca');
            }
            else if (elementId === 'petsList') {
                div.innerHTML = `
                    <div class="item-header">${item.name}</div>
                    <div class="item-content">
                        <div class="item-type">
                            <strong>Tipo:</strong> ${item.type}
                        </div>
                        <div class="pet-attributes">
                            <div class="pet-attribute">
                                <label>Fuerza:</label>
                                <span>${item.attributes.fuerza}</span>
                            </div>
                            <div class="pet-attribute">
                                <label>Int:</label>
                                <span>${item.attributes.inteligencia}</span>
                            </div>
                            <div class="pet-attribute">
                                <label>Agi:</label>
                                <span>${item.attributes.agilidad}</span>
                            </div>
                            <div class="pet-attribute">
                                <label>Met:</label>
                                <span>${item.attributes.metabolismo}</span>
                            </div>
                            <div class="pet-attribute">
                                <label>A.M:</label>
                                <span>${item.attributes.am}</span>
                            </div>
                        </div>
                        <div class="pet-stats">
                            <div class="pet-stat">
                                <span>Nivel:</span>
                                <strong>${item.level}</strong>
                            </div>
                            <div class="pet-stat">
                                <span>Vida:</span>
                                <strong>${item.stats.currentHealth}/${item.stats.maxHealth}</strong>
                            </div>
                            <div class="pet-stat">
                                <span>Armadura:</span>
                                <strong>${item.stats.armor}</strong>
                            </div>
                        </div>
                        ${item.abilities ? `
                            <div class="pet-abilities">
                                <strong>Habilidades:</strong>
                                <p>${item.abilities}</p>
                            </div>
                        ` : ''}
                        <div class="item-buttons">
                            <button class="btn" onclick="editarItem('${elementId}', '${item.id}')">Editar</button>
                            <button class="btn" onclick="eliminarItem('${elementId}', '${item.id}')">Eliminar</button>
                        </div>
                    </div>
                `;
            }
            else if (elementId === 'itemsList') {
                div.innerHTML = `
                    <div class="item-header">${item.name}</div>
                    <div class="item-content">
                        <div class="item-type">
                            <strong>Tipo:</strong> ${item.type}
                        </div>
                        ${item.desc ? `
                            <div class="item-description">
                                <strong>Descripción:</strong> ${item.desc}
                            </div>
                        ` : ''}
                        ${item.bonuses && item.bonuses.length > 0 ? `
                            <div class="item-bonuses">
                                <strong>Bonus:</strong>
                                ${item.bonuses.map(bonus => `
                                    <div class="bonus-entry">
                                        ${bonus.target === 'baseHealth' ? 'Vida Base' : 
                                          bonus.target === 'baseArmor' ? 'Armadura Base' : 
                                          bonus.target === 'baseMistyculas' ? 'Místyculas Base' : 
                                          bonus.target}: ${bonus.value > 0 ? '+' : ''}${bonus.value}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        <div class="item-buttons">
                            <button class="btn" onclick="editarItem('${elementId}', '${item.id}')">Editar</button>
                            <button class="btn" onclick="eliminarItem('${elementId}', '${item.id}')">Eliminar</button>
                            <button class="btn" onclick="mostrarSlotEquipamiento('${item.id}')">Equipar</button>
                        </div>
                    </div>
                `;
            }
            
            container.appendChild(div);
        });
    }
    function eliminarItem(listId, id) {
        if (listId === "skillsList") {
            character.skills = character.skills.filter(s => s.id !== id);
            renderList(listId, character.skills);
        } else if (listId === "spellsList") {
            character.spells = character.spells.filter(s => s.id !== id);
            renderList(listId, character.spells);
            actualizarSlots();
        } else if (listId === "petsList") {
            character.pets = character.pets.filter(p => p.id !== id);
            renderList(listId, character.pets);
        } else if (listId === "itemsList") {
            const item = character.items.find(i => i.id === id);
            if (item) {
                removeBonuses(item);
            }
            character.items = character.items.filter(i => i.id !== id);
            renderList(listId, character.items);
            actualizarTodo();
        }
    }
    function editarItem(listId, id) {
      if (listId === "skillsList") { openModal('skillModal', id); }
      else if (listId === "spellsList") { openModal('spellModal', id); }
      else if (listId === "petsList") { openModal('petModal', id); }
      else if (listId === "itemsList") { openModal('itemModal', id); }
    }
    // Usar habilidad o hechizo
    async function usarItem(listId, id) {
        try {
            const item = listId === "skillsList" 
                ? character.skills.find(s => s.id === id)
                : character.spells.find(s => s.id === id);

            if (!item) {
                throw new Error("Item no encontrado.");
            }

            // Verificar costos
            if (character.currentMistyculas < item.mistyCost) {
                throw new Error("No tienes suficientes místyculas.");
            }
            if (character.actions.currentActions < item.actionCost) {
                throw new Error(`No tienes suficientes acciones. Necesitas ${item.actionCost} acciones.`);
            }

            // Calcular resultado
            const resultado = resolverFormula(item.formula);

            const confirmed = await PopupManager.show({
                title: `¿Usar ${item.name}?`,
                content: `
                    <div class="popup-formula">
                        <strong>Fórmula:</strong> ${item.formula}
                        ${resultado ? `
                            <div class="popup-result">
                            Resultado: ${resultado.result.toLocaleString()}
                            </div>
                            <div style="font-size: 0.9em; color: #666;">
                            ${resultado.details.join('<br>')}
                            </div>
                        ` : ''}

                    </div>
                    <div class="popup-stats">
                    <div class="popup-stat">
                        <strong>Costo de Acciones:</strong><br>
                        ${item.actionCost}
                    </div>
                    <div class="popup-stat">
                        <strong>Costo de Místyculas:</strong><br>
                        ${item.mistyCost}
                    </div>
                    </div>
                `,
                showCancel: true,
                confirmText: 'Usar',
                cancelText: 'Cancelar'
            });

            if (confirmed) {
                // Aplicar costos
                character.currentMistyculas -= item.mistyCost;
                character.actions.currentActions -= item.actionCost;
                
                actualizarMistyculas();
                actualizarAcciones();
            }

            return confirmed;
        } catch (error) {
            await PopupManager.show({
                title: 'Error',
                content: error.message
            });
            return false;
        }
    }
    function resolverFormula(formula) {
    try {
        if (!formula || !formula.trim()) return null;
        
        let processedFormula = formula;
        let operationDetails = [];
        
        // Valores disponibles
        const values = {
            //Atributos
            'Fuerza': character.attributes.fuerza,
            'FUE': character.attributes.fuerza,
            'Inteligencia': character.attributes.inteligencia,
            'INT': character.attributes.inteligencia,
            'Agilidad': character.attributes.agilidad,
            'AGI': character.attributes.agilidad,
            'Metabolismo': character.attributes.metabolismo,
            'MET': character.attributes.metabolismo,
            'A.M': character.attributes.am,
            'AM': character.attributes.am,
            
            // Modificadores
            'FuerzaMod': calcularMod(character.attributes.fuerza),
            'FUEMod': calcularMod(character.attributes.fuerza),
            'InteligenciaMod': calcularMod(character.attributes.inteligencia),
            'INTMod': calcularMod(character.attributes.inteligencia),
            'AgilidadMod': calcularMod(character.attributes.agilidad),
            'AGIMod': calcularMod(character.attributes.agilidad),
            'MetabolismoMod': calcularMod(character.attributes.metabolismo),
            'METMod': calcularMod(character.attributes.metabolismo),
            'AMMod': calcularMod(character.attributes.am),
            
            // Estadísticas
            'Nivel': character.level,
            'LVL': character.level,
            'Armadura': character.armor,
            'ARM': character.armor,
            'VidaActual': character.currentHealth,
            'HP': character.currentHealth,
            'VidaMaxima': character.maxHealth,
            'HPMax': character.maxHealth,
            'VidaBase': character.baseHealth,
            'HPBase': character.baseHealth,
            'ArmaduraBase': character.baseArmor,
            'ARMBase': character.baseArmor,
            'Misty': character.currentMistyculas,
            'MP': character.currentMistyculas,
            'MistyMaxima': character.maxMistyculas,
                                             'MPMax': character.maxMistyculas
        };

        // Dados
        processedFormula = processedFormula.replace(/(\w+|\d+)d(\w+|\d+)/gi, (match, num, sides) => {
            const numDice = values[num] || parseInt(num);
            const diceSize = values[sides] || parseInt(sides);
            
            if (isNaN(numDice) || isNaN(diceSize)) {
                throw new Error(`Valores inválidos para dados: ${num}d${sides}`);
            }

            const rolls = [];
            let total = 0;
            const safeDice = Math.min(Math.abs(numDice), 100);
            const safeSides = Math.min(Math.abs(diceSize), 1000);

            for (let i = 0; i < safeDice; i++) {
                const roll = Math.floor(Math.random() * safeSides) + 1;
                rolls.push(roll);
                total += roll;
            }

            operationDetails.push(`${num}d${sides}: [${rolls.join(', ')}] = ${total}`);
            return total;
        });

        // Variables
        Object.entries(values)
            .sort((a, b) => b[0].length - a[0].length)
            .forEach(([key, value]) => {
                const regex = new RegExp(`\\b${key}\\b`, 'g');
                if (processedFormula.match(regex)) {
                    operationDetails.push(`${key} = ${value}`);
                    processedFormula = processedFormula.replace(regex, value);
                }
            });

        // Limpiar operadores
        processedFormula = processedFormula
            .replace(/[×x]/g, '*')
            .replace(/÷/g, '/')
            .replace(/\s+/g, '');

        console.log('Fórmula procesada:', processedFormula);
        
        const result = Math.floor(eval(processedFormula));
        
        if (isNaN(result)) {
            throw new Error('El resultado no es un número válido');
        }

        return {
            result: result,
            details: operationDetails,
            formula: formula
        };
        
    } catch (error) {
        console.error('Error en la fórmula:', error);
        return {
            result: 'Error',
            details: [`Error: ${error.message}`],
            formula: formula
        };
    }
}

    actualizarTodo();
    applyAllBonuses();

    const PopupManager = {
      show(options = {}) {
        return new Promise((resolve) => {
          const popup = document.createElement('div');
          popup.className = 'custom-popup';
          popup.innerHTML = `
              <div class="popup-content">
                  <h3>${options.title || ''}</h3>
                  <p>${options.content || ''}</p>
                  <div class="popup-buttons">
                      <button class="btn confirm-btn">${options.confirmText || 'Aceptar'}</button>
                      ${options.showCancel ? `<button class="btn cancel-btn">${options.cancelText || 'Cancelar'}</button>` : ''}

                  </div>
              </div>
          `;
          document.body.appendChild(popup);

          const confirmBtn = popup.querySelector('.confirm-btn');
          const cancelBtn = popup.querySelector('.cancel-btn');

          confirmBtn.onclick = () => {
              popup.remove();
              resolve(true);
          };
          if (cancelBtn) {
              cancelBtn.onclick = () => {
                  popup.remove();
                  resolve(false);
              };
          }
        });
      },

      // Alias para mantener compatibilidad
      alert(message, title = 'Aviso') {
        return this.show({
          title,
          content: message
        });
      },

      async confirm(message, title = 'Confirmar') {
        return this.show({
          title,
          content: message,
          showCancel: true
        });
      },

      async alert(message, title = 'Aviso') {
        return this.show({
          title,
          content: message
        });
      },

      async prompt(title, message, defaultValue = '') {
        return new Promise((resolve) => {
            const popup = document.createElement('div');
            popup.className = 'custom-popup';
            popup.innerHTML = `
                <div class="popup-content">
                    <h3>${title}</h3>
                    <p>${message}</p>
                    <input type="text" 
                           value="${defaultValue}" 
                           style="width: 100%; padding: 8px; margin: 10px 0;"
                           id="popupInput">
                    <div class="popup-buttons">
                        <button class="btn confirm-btn">Aceptar</button>
                        <button class="btn cancel-btn">Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(popup);

            const input = popup.querySelector('#popupInput');
            const confirmBtn = popup.querySelector('.confirm-btn');
            const cancelBtn = popup.querySelector('.cancel-btn');

            input.focus();
            input.select();

            confirmBtn.onclick = () => {
                const value = input.value;
                popup.remove();
                resolve(value);
            };
            
            cancelBtn.onclick = () => {
                popup.remove();
                resolve(null);
            };
        });
      }
    };

    // Añadir manejo de elementos
    document.querySelectorAll('td[data-element]').forEach(td => {
      td.addEventListener('click', function() {
        this.classList.toggle('active');
      });
    });

    // Función auxiliar para guardar mascotas
    function savePet(newPet, itemId) {
      if (itemId) {
        const index = character.pets.findIndex(p => p.id === itemId);
        character.pets[index] = newPet;
      } else {
        character.pets.push(newPet);
      }
      renderList('petsList', character.pets);
    }

    function openStatsEditModal() {
        const modalOverlay = document.getElementById("modalOverlay");
        const modalBody = document.getElementById("modalBody");
        
        modalOverlay.style.display = "flex";
        
        modalBody.innerHTML = `
            <h3 style="margin-bottom: 20px; text-align: center;">Editar Estadísticas</h3>
            <div class="modal-form">
                <div class="stat-edit-group">
                    <h4>Vida</h4>
                    <div style="margin-bottom: 10px;">
                        <label>Base (sin modificadores):</label>
                        <input type="number" id="editBaseHealth" value="${character.baseHealth}" min="1" placeholder="Base">
                        <small style="display: block; color: #666;">Valor base por defecto: 25</small>
                    </div>
                    <div>
                        <label>Actual:</label>
                        <input type="number" id="editCurrentHealth" value="${character.currentHealth}" min="0" placeholder="Actual">
                        <small style="display: block; color: #666;">Máximo actual con modificadores: ${character.maxHealth}</small>
                    </div>
                </div>

                <div class="stat-edit-group">
                    <h4>Armadura</h4>
                    <div style="margin-bottom: 10px;">
                        <label>Base (sin modificadores):</label>
                        <input type="number" id="editBaseArmor" value="${character.baseArmor}" min="0" placeholder="Base">
                        <small style="display: block; color: #666;">Valor base por defecto: 10</small>
                    </div>
                    <div>
                        <label>Actual (con modificadores):</label>
                        <input type="number" id="editCurrentArmor" value="${character.armor}" min="0" placeholder="Actual">
                        <small style="display: block; color: #666;">
                            Incluye modificadores de Agilidad (${calcularMod(character.attributes.agilidad)}) y 
                            Metabolismo (${calcularMod(character.attributes.metabolismo)})
                        </small>
                    </div>
                </div>

                <div class="stat-edit-group">
                    <h4>Místyculas</h4>
                    <div style="margin-bottom: 10px;">
                        <label>Base (sin modificadores):</label>
                        <input type="number" id="editBaseMistyculas" value="${character.baseMistyculas}" min="1" placeholder="Base">
                        <small style="display: block; color: #666;">Valor base por defecto: 100</small>
                    </div>
                    <div>
                        <label>Actual:</label>
                        <input type="number" id="editCurrentMistyculas" value="${character.currentMistyculas}" min="0" placeholder="Actual">
                        <small style="display: block; color: #666;">Máximo actual con modificadores: ${character.maxMistyculas}</small>
                    </div>
                </div>

                <div class="stat-edit-group">
                    <h4>Experiencia</h4>
                    <div>
                        <label>Total acumulado:</label>
                        <input type="number" id="editXP" value="${character.experience}" min="0">
                        <small style="display: block; color: #666;">
                            Nivel actual: ${character.level} | 
                            Siguiente nivel: ${expTable.find(e => e.level === character.level + 1)?.exp || 'Máximo'}
                        </small>
                    </div>
                </div>
            </div>
        `;

        modalCallback = function() {
            // Actualizar valores base
            character.baseHealth = parseInt(document.getElementById('editBaseHealth').value) || 25;
            character.baseArmor = parseInt(document.getElementById('editBaseArmor').value) || 10;
            character.baseMistyculas = parseInt(document.getElementById('editBaseMistyculas').value) || 100;
            
            // Actualizar valores actuales
            character.currentHealth = parseInt(document.getElementById('editCurrentHealth').value) || character.currentHealth;
            character.armor = parseInt(document.getElementById('editCurrentArmor').value) || character.armor;
            character.currentMistyculas = parseInt(document.getElementById('editCurrentMistyculas').value) || character.currentMistyculas;
            
            // Actualizar XP
            character.experience = parseInt(document.getElementById('editXP').value) || 0;
            
            // Actualizar todo
            actualizarTodo();
        };
    }

    function renderBonusList(bonuses) {
      return bonuses.map((bonus, index) => `
          <div class="bonus-item">
              <select onchange="updateBonus(${index}, 'type')">
                  <option value="stat" ${bonus.type === 'stat' ? 'selected' : ''}>Estadística Base</option>
              </select>
              
              <select onchange="updateBonus(${index}, 'stat')">
                  <option value="baseHealth">Vida Base</option>
                  <option value="baseArmor">Armadura Base</option>
                  <option value="baseMistyculas">Místyculas Base</option>
              </select>
              
              <input type="number" 
                     value="${bonus.value}"
                     onchange="updateBonus(${index}, 'value')"
                     min="-50" 
                     max="50">
                     
              <button class="btn" onclick="removeBonus(${index})">X</button>
          </div>
      `).join('');
    }

    async function equipItem(item, slot) {
        try {
            // Verificar si el slot es válido
            if (!character.equipment.hasOwnProperty(slot)) {
                throw new Error('Slot de equipamiento inválido');
            }

            // Verificar si el item puede equiparse en ese slot
            if (!isValidItemForSlot(item, slot)) {
                throw new Error('Este item no puede equiparse en este slot');
            }

            // Si hay un item equipado, desequiparlo primero
            if (character.equipment[slot]) {
                await desequiparItem(slot);
            }

            // Equipar el nuevo item
            character.equipment[slot] = item;
            
            // Remover el item del inventario
            character.items = character.items.filter(i => i.id !== item.id);
            
            // Aplicar los bonus del nuevo item
            if (item.bonuses) {
                applyBonuses(item);
            }
            
            // Actualizar UI
            renderEquipmentSlots();
            renderList('itemsList', character.items);
            
            await PopupManager.show({
                title: 'Éxito',
                content: `${item.name} equipado en ${slot}`
            });
            
            return true;
        } catch (error) {
            await PopupManager.show({
                title: 'Error',
                content: error.message
            });
            return false;
        }
    }

    // Agregar función auxiliar
    function isValidItemForSlot(item, slot) {
        const slotTypes = {
            mainHand: ['weapon', 'tool'],
            offHand: ['weapon', 'shield', 'tool'],
            head: ['helmet', 'accessory'],
            chest: ['armor'],
            legs: ['armor'],
            feet: ['boots', 'armor'],
            accessory1: ['accessory', 'ring', 'amulet'],
            accessory2: ['accessory', 'ring', 'amulet']
        };

        // Si el slot no existe en la configuración, no es válido
        if (!slotTypes[slot]) return false;

        // Verificar si el tipo de item está permitido en ese slot
        return slotTypes[slot].includes(item.type);
    }

    function addBonus(existingBonus = null) {
        const bonusList = document.getElementById('bonusList');
        const bonusDiv = document.createElement('div');
        bonusDiv.className = 'bonus-item';
        
        const targetSelect = document.createElement('select');
        updateTargetOptions(targetSelect);
        if (existingBonus?.target) {
            targetSelect.value = existingBonus.target;
        }
        
        const valueInput = document.createElement('input');
        valueInput.type = 'number';
        valueInput.min = '-50';
        valueInput.max = '50';
        valueInput.value = existingBonus?.value || '0';
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'btn';
        removeBtn.textContent = 'X';
        removeBtn.onclick = () => bonusDiv.remove();
        
        bonusDiv.appendChild(targetSelect);
        bonusDiv.appendChild(valueInput);
        bonusDiv.appendChild(removeBtn);
        
        bonusList.appendChild(bonusDiv);
    }

    function updateTargetOptions(select) {
        select.innerHTML = `
            <option value="baseHealth">Vida Base</option>
            <option value="baseArmor">Armadura Base</option>
            <option value="baseMistyculas">Místyculas Base</option>
        `;
    }

    function getBonusList() {
        const bonuses = [];
        document.querySelectorAll('#bonusList .bonus-item').forEach(item => {
            bonuses.push({
                type: 'stat',
                target: item.querySelector('select').value,
                value: parseInt(item.querySelector('input').value) || 0
            });
        });
        return bonuses;
    }

    function removeBonus(index) {
        const bonusList = document.getElementById('bonusList');
        bonusList.children[index].remove();
    }

    function renderBonusItem(bonus) {
        return `
            <select class="bonus-target">
                <option value="baseHealth" ${bonus.target === 'baseHealth' ? 'selected' : ''}>Vida Base</option>
                <option value="baseArmor" ${bonus.target === 'baseArmor' ? 'selected' : ''}>Armadura Base</option>
                <option value="baseMistyculas" ${bonus.target === 'baseMistyculas' ? 'selected' : ''}>Místyculas Base</option>
            </select>
            
            <input type="number" class="bonus-value" value="${bonus.value || 0}" min="-50" max="50">
            <button class="btn" onclick="removeBonus()">X</button>
        `;
    }

    function applyBonuses(item) {
        if (!item || !item.bonuses) return;
        
        console.log('Aplicando bonus para:', item.name);
        
        item.bonuses.forEach(bonus => {
            switch(bonus.target) {
                case 'baseHealth':
                    character.baseHealth += bonus.value;
                    console.log(`Aplicando bonus de vida base: +${bonus.value}`);
                    break;
                case 'baseArmor':
                    character.baseArmor += bonus.value;
                    console.log(`Aplicando bonus de armadura base: +${bonus.value}`);
                    break;
                case 'baseMistyculas':
                    character.baseMistyculas += bonus.value;
                    console.log(`Aplicando bonus de místyculas base: +${bonus.value}`);
                    break;
            }
        });
        
        actualizarTodo();
    }

    function removeBonuses(item) {
        if (!item || !item.bonuses) return;
        
        console.log('Removiendo bonus de:', item.name);
        
        item.bonuses.forEach(bonus => {
            switch(bonus.target) {
                case 'baseHealth':
                    character.baseHealth = Math.max(25, character.baseHealth - bonus.value);
                    console.log(`Removiendo bonus de vida base: -${bonus.value}`);
                    break;
                case 'baseArmor':
                    character.baseArmor = Math.max(10, character.baseArmor - bonus.value);
                    console.log(`Removiendo bonus de armadura base: -${bonus.value}`);
                    break;
                case 'baseMistyculas':
                    character.baseMistyculas = Math.max(100, character.baseMistyculas - bonus.value);
                    console.log(`Removiendo bonus de místyculas base: -${bonus.value}`);
                    break;
            }
        });
        
        actualizarTodo();
    }

    function exportCharacter() {
        const data = JSON.stringify(character, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `personaje_${character.name || 'sin_nombre'}.json`;
        a.click();
        window.URL.revokeObjectURL(url);
    }

    function importCharacter() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        
        input.onchange = async function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            
            reader.onload = async function(event) {
                try {
                    const loadedCharacter = JSON.parse(event.target.result);
                    
                    // Asegurar que los atributos tengan valores válidos
                    const defaultAttributes = {
                        fuerza: 10,
                        inteligencia: 10,
                        agilidad: 10,
                        metabolismo: 10,
                        am: 10
                    };
                    
                    // Combinar atributos cargados con valores por defecto
                    loadedCharacter.attributes = {
                        ...defaultAttributes,
                        ...loadedCharacter.attributes
                    };
                    
                    // Actualizar character con los datos cargados
                    character = loadedCharacter;
                    
                    // Actualizar inputs de atributos
                    document.getElementById('attrFuerza').value = character.attributes.fuerza;
                    document.getElementById('attrInt').value = character.attributes.inteligencia;
                    document.getElementById('attrAgil').value = character.attributes.agilidad;
                    document.getElementById('attrMetab').value = character.attributes.metabolismo;
                    document.getElementById('attrAM').value = character.attributes.am;
                    
                    // Aplicar bonus y actualizar UI
                    applyAllBonuses();
                    actualizarTodo();
                    
                    // Actualizar listas
                    renderList('skillsList', character.skills);
                    renderList('spellsList', character.spells);
                    renderList('petsList', character.pets);
                    renderList('itemsList', character.items);
                    
                    // Actualizar campos del personaje
                    document.getElementById('charName').value = character.name || '';
                    document.getElementById('charRace').value = character.race || '';
                    document.getElementById('charLang').value = character.languages || '';
                    document.getElementById('charPerso').value = character.personality || '';
                    
                    // Actualizar imagen
                    if(character.image) {
                        document.getElementById('imgContainer').innerHTML = 
                            `<img src="${character.image}" style="width:100%; height:100%; object-fit:cover;">`;
                    }
                    
                    await PopupManager.alert('Personaje cargado correctamente');
                    
                } catch (error) {
                    console.error('Error al cargar:', error);
                    await PopupManager.alert('Error al cargar el archivo: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        };
        
        input.click();
    }

    function initializeActions() {
        const modAgil = calcularMod(character.attributes.agilidad);
        character.actions = {
            maxActions: 1 + character.level + modAgil, 
            currentActions: 1 + character.level + modAgil,
            minor: true,
            object: true,
            complex: true,
            reaction: true,
            bonus: true,
            legendary: true,
        };
        actualizarAcciones();
    }

    async function useAction(type, cost) {
        // Validar acciones legendarias
        if (type === 'legendary' && !character.actions.legendary) {
            await PopupManager.show({
                title: 'Aviso',
                content: "No puedes usar acciones legendarias sin permiso del DM."
            });
            return false;
        }

        // Calcular costo para acciones legendarias
        if (type === 'legendary') {
            cost = Math.floor(Math.random() * 11) + 10;
        }

        // Si es acción bonus, no verificar costo
        if (type !== 'bonus') {
            // Verificar acciones disponibles
            if (character.actions.currentActions < cost) {
                await PopupManager.show({
                    title: 'Aviso', 
                    content: `No tienes suficientes acciones. Necesitas ${cost} acciones.`
                });
                return false;
            }

            // Aplicar costo
            character.actions.currentActions -= cost;
        }
        
        // Caso especial: acción bonus otorga +1 acción
        if (type === 'bonus') {
            character.actions.currentActions = Math.min(
                character.actions.maxActions,
                character.actions.currentActions + 1  // Añade 1 acción
            );
        }
        
        // Actualizar UI
        actualizarAcciones();
        
        const messages = {
            minor: "Acción menor realizada",
            object: "Acción de objeto realizada", 
            complex: "Acción compleja realizada",
            reaction: "Reacción realizada",
            bonus: "Acción bonus realizada (+1 acción)",
            legendary: `¡Acción legendaria realizada! (Costó ${cost} acciones)`
        };

        await PopupManager.show({
            title: 'Resultado',
            content: `${messages[type]}\nAcciones restantes: ${character.actions.currentActions}`
        });
        
        return true;
    }

    function applyAllBonuses() {
        // Resetear los valores base
        character.attributes = {
            fuerza: 10,
            inteligencia: 10,
            agilidad: 10,
            metabolismo: 10,
            am: 10
        };
        character.baseHealth = 25;
        character.baseArmor = 10;
        character.baseMistyculas = 100;

        // Aplicar bonus solo de items equipados
        Object.values(character.equipment).forEach(item => {
            if (item && item.bonuses) {
                applyBonuses(item);
            }
        });

        // Actualizar todo
        actualizarTodo();
    }

    function openPetModal(itemId = null) {
        const pet = itemId ? character.pets.find(p => p.id === itemId) : null;
        
        modalBody.innerHTML = `
            <h3>${itemId ? "Editar" : "Agregar"} Mascota</h3>
            <div class="modal-form">
                <div class="input-group">
                    <label>Nombre:</label>
                    <input type="text" id="petName" value="${pet?.name || ''}" required>
                </div>
                
                <div class="input-group">
                    <label>Tipo:</label>
                    <input type="text" id="petType" value="${pet?.type || ''}" required>
                </div>

                <div class="stat-edit-group">
                    <h4>Atributos</h4>
                    <div class="stat-input-pair">
                        <label>Fuerza:</label>
                        <input type="number" id="petStr" value="${pet?.attributes?.fuerza || 10}" min="1" max="30">
                    </div>
                    <div class="stat-input-pair">
                        <label>Inteligencia:</label>
                        <input type="number" id="petInt" value="${pet?.attributes?.inteligencia || 10}" min="1" max="30">
                    </div>
                    <div class="stat-input-pair">
                        <label>Agilidad:</label>
                        <input type="number" id="petAgi" value="${pet?.attributes?.agilidad || 10}" min="1" max="30">
                    </div>
                    <div class="stat-input-pair">
                        <label>Metabolismo:</label>
                        <input type="number" id="petMet" value="${pet?.attributes?.metabolismo || 10}" min="1" max="30">
                    </div>
                    <div class="stat-input-pair">
                        <label>A.M:</label>
                        <input type="number" id="petAM" value="${pet?.attributes?.am || 10}" min="1" max="30">
                    </div>
                </div>

                <div class="stat-edit-group">
                    <h4>Estadísticas</h4>
                    <div class="stat-input-pair">
                        <label>Nivel:</label>
                        <input type="number" id="petLevel" value="${pet?.level || 1}" min="1" max="20">
                    </div>
                    <div class="stat-input-pair">
                        <label>Vida Base:</label>
                        <input type="number" id="petBaseHealth" value="${pet?.stats?.baseHealth || 25}" min="1">
                    </div>
                    <div class="stat-input-pair">
                        <label>Vida Actual:</label>
                        <input type="number" id="petCurrentHealth" value="${pet?.stats?.currentHealth || pet?.stats?.maxHealth || 25}" min="0">
                    </div>
                    <div class="stat-input-pair">
                        <label>Armadura Base:</label>
                        <input type="number" id="petBaseArmor" value="${pet?.stats?.baseArmor || 10}" min="0">
                    </div>
                    <div class="stat-input-pair">
                        <label>Armadura Actual:</label>
                        <input type="number" id="petCurrentArmor" value="${pet?.stats?.armor || 10}" min="0">
                    </div>
                </div>

                <div class="input-group">
                    <label>Habilidades:</label>
                    <textarea id="petAbilities" placeholder="Lista de habilidades (una por línea)">${pet?.abilities || ''}</textarea>
                </div>
            </div>
        `;

        modalCallback = function() {
            const baseHealth = parseInt(document.getElementById('petBaseHealth').value) || 25;
            const currentHealth = parseInt(document.getElementById('petCurrentHealth').value);
            const level = parseInt(document.getElementById('petLevel').value) || 1;
            const maxHealth = baseHealth * level;

            const newPet = {
                id: pet?.id || Date.now().toString(),
                name: document.getElementById('petName').value,
                type: document.getElementById('petType').value,
                level: level,
                attributes: {
                    fuerza: parseInt(document.getElementById('petStr').value) || 10,
                    inteligencia: parseInt(document.getElementById('petInt').value) || 10,
                    agilidad: parseInt(document.getElementById('petAgi').value) || 10,
                    metabolismo: parseInt(document.getElementById('petMet').value) || 10,
                    am: parseInt(document.getElementById('petAM').value) || 10
                },
                abilities: document.getElementById('petAbilities').value,
                stats: {
                    baseHealth: baseHealth,
                    maxHealth: maxHealth,
                    currentHealth: Math.min(currentHealth || maxHealth, maxHealth),
                    baseArmor: parseInt(document.getElementById('petBaseArmor').value) || 10,
                    armor: parseInt(document.getElementById('petCurrentArmor').value) || 10
                }
            };

            if (itemId) {
                const index = character.pets.findIndex(p => p.id === itemId);
                character.pets[index] = newPet;
            } else {
                character.pets.push(newPet);
            }
            
            renderList('petsList', character.pets);
        };
    }

    // Añadir función para actualizar la vida de la mascota
    function updatePetHealth(petId, newHealth) {
        const pet = character.pets.find(p => p.id === petId);
        if (pet) {
            pet.stats.currentHealth = Math.max(0, Math.min(pet.stats.maxHealth, parseInt(newHealth)));
            renderList('petsList', character.pets);
        }
    }

    function openEquipSlotModal() {
        modalBody.innerHTML = `
            <h3>Gestionar Slots de Equipamiento</h3>
            <div class="modal-form">
                <div id="slotsList">
                    ${Object.keys(character.equipment).map(slot => `
                        <div class="slot-item">
                            <input type="text" value="${slot}" readonly>
                            <button class="btn" onclick="removeEquipSlot('${slot}')">X</button>
                        </div>
                    `).join('')}
                </div>
                <div class="input-group" style="margin-top: 15px;">
                    <label>Añadir nuevo slot:</label>
                    <input type="text" id="newSlotName" placeholder="Nombre del slot">
                    <button class="btn" onclick="addEquipSlot()">Añadir Slot</button>
                </div>
            </div>
        `;

        modalCallback = null;
        modalOverlay.style.display = "flex";
    }

    function addEquipSlot() {
        const slotName = document.getElementById('newSlotName').value.trim();
        
        if (!slotName) {
            PopupManager.alert("Ingresa un nombre válido para el slot");
            return;
        }
        
        if (character.equipment.hasOwnProperty(slotName)) {
            PopupManager.alert("Ya existe un slot con ese nombre");
            return;
        }
        
        // Añadir nuevo slot
        character.equipment[slotName] = null;
        
        // Actualizar UI
        renderEquipmentSlots();
        openEquipSlotModal(); // Refrescar modal
    }

    function removeEquipSlot(slotName) {
        if (character.equipment[slotName]) {
            // Si hay un item equipado, devolverlo al inventario
            character.items.push(character.equipment[slotName]);
        }
        
        delete character.equipment[slotName];
        renderEquipmentSlots();
        openEquipSlotModal(); // Refrescar modal
    }

    function renderEquipmentSlots() {
        const grid = document.getElementById('equipmentGrid');
        grid.innerHTML = '';
        
        Object.entries(character.equipment).forEach(([slot, item]) => {
            grid.innerHTML += `
                <div class="equipment-slot" data-slot="${slot}">
                    <h3>${slot}</h3>
                    <div class="slot-content ${!item ? 'empty' : ''}">
                        ${item ? `
                            <div class="equipment-item">
                                ${item.name}
                                <button class="btn" onclick="desequiparItem('${slot}')">Desequipar</button>
                            </div>
                        ` : 'Vacío'}
                    </div>
                </div>
            `;
        });
    }

    async function desequiparItem(slot) {
        // Verificar que hay un item equipado
        const item = character.equipment[slot];
        if (!item) return;

        // Remover los bonus del item antes de desequiparlo
        if (item.bonuses) {
            removeBonuses(item);
        }

        // Devolver el item al inventario
        character.items.push(item);
        
        // Limpiar el slot
        character.equipment[slot] = null;
        
        // Recalcular todos los bonus y actualizar UI
        applyAllBonuses();
        renderEquipmentSlots();
        renderList('itemsList', character.items);
    }

    function initialize() {
      // Inicializar acciones
      const modAgil = calcularMod(character.attributes.agilidad);
      character.actions = {
        maxActions: character.level + modAgil + 1,
        currentActions: character.level + modAgil + 1,
        minor: true,
        object: true,
        complex: true,
        reaction: true,
        bonus: true,
        legendary: true,
      };

      // Actualizar UI
      actualizarTodo();
      actualizarAcciones();
      
      // Renderizar listas
      renderList('skillsList', character.skills);
      renderList('spellsList', character.spells);
      renderList('petsList', character.pets);
      renderList('itemsList', character.items);
      
      // Actualizar slots de hechizos
      document.getElementById('spellSlots').textContent = 
        `${character.spells.length}/${character.spellSystem.slots}`;
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Inicializar
      initialize();

      // Event listeners para elementos
      document.querySelectorAll('td[data-element] input').forEach(input => {
        input.addEventListener('change', (e) => {
          const element = e.target.closest('td').dataset.element;
          character.elements[element] = parseInt(e.target.value) || 10;
        });
      });

      // Event listeners para atributos
      ['Fuerza', 'Int', 'Agil', 'Metab', 'AM'].forEach(id => {
        document.getElementById(`attr${id}`).addEventListener('change', (e) => {
          const attr = id.toLowerCase();
          character.attributes[attr] = parseInt(e.target.value) || 10;
          actualizarTodo();
        });
      });

      // Event listeners para stats
      ['inputDamage', 'inputHeal', 'inputMistyRegen'].forEach(id => {
        document.getElementById(id).addEventListener('input', (e) => {
          e.target.value = Math.max(0, parseInt(e.target.value) || 0);
        });
      });

      // Event listeners para datos personaje
      document.getElementById('charName').addEventListener('change', (e) => character.name = e.target.value);
      document.getElementById('charRace').addEventListener('change', (e) => character.race = e.target.value);
      document.getElementById('charLang').addEventListener('change', (e) => character.languages = e.target.value);
      document.getElementById('charPerso').addEventListener('change', (e) => character.personality = e.target.value);
    });

    function validateSkill(skill) {
        if (!skill.name.trim()) {
            PopupManager.show({
                title: 'Error',
                content: 'El nombre es obligatorio'
            });
            return false;
        }
        return true;
    }

    function validateSpell(spell) {
        if (!spell.name.trim()) {
            PopupManager.show({
                title: 'Error', 
                content: 'El nombre es obligatorio'
            });
            return false;
        }
        return true;
    }

    function validateItem(item) {
        if (!item.name.trim()) {
            PopupManager.show({
                title: 'Error',
                content: 'El nombre es obligatorio'
            });
            return false;
        }
        return true;
    }

    function getRaritySelect(currentRarity = 'intrinseca') {
        return `
            <div class="input-group">
                <label>Rareza:</label>
                <select id="itemRarity">
                    ${Object.entries(RARITIES).map(([value, data]) => `
                        <option value="${value}" ${currentRarity === value ? 'selected' : ''}>
                            ${data.name}
                        </option>
                    `).join('')}
                </select>
            </div>
        `;
    }

    function createSkill(data) {
        return {
            id: data.id || Date.now().toString(),
            name: data.name,
            desc: data.desc || '',
            mistyCost: parseInt(data.mistyCost) || 0,
            actionCost: parseInt(data.actionCost) || 1,
            rarity: data.rarity || 'intrinseca',
            formula: data.formula || ''
        };
    }

    function createSpell(data) {
        return {
            id: data.id || Date.now().toString(),
            name: data.name,
            type: data.type || 'tecnica',
            desc: data.desc || '',
            mistyCost: parseInt(data.mistyCost) || 0,
            actionCost: parseInt(data.actionCost) || 1,
            rarity: data.rarity || 'intrinseca',
            formula: data.formula || ''
        };
    }

    function createItem(data) {
        return {
            id: data.id || Date.now().toString(),
            name: data.name,
            type: data.type || 'tool',
            desc: data.desc || '',
            rarity: data.rarity || 'intrinseca',
            bonuses: data.bonuses || [],
            equipSlot: data.equipSlot || null
        };
    }

    async function handleSkillModal(itemId = null) {
        const skill = itemId ? character.skills.find(s => s.id === itemId) : null;
        const formulaButtons = createFormulaButtons('skillFormula');
        
        modalBody.innerHTML = `
            <h3>${itemId ? "Editar" : "Crear"} Habilidad</h3>
            <div class="modal-form">
                <div class="input-group">
                    <label>Nombre:</label>
                    <input type="text" id="skillName" value="${skill?.name || ''}" required>
                </div>
                <div class="input-group">
                    <label>Descripción:</label>
                    <textarea id="skillDesc">${skill?.desc || ''}</textarea>
                </div>
                <div class="input-group">
                    <label>Costo de Místyculas:</label>
                    <input type="number" id="skillMistyCost" value="${skill?.mistyCost || 0}" min="0">
                </div>
                <div class="input-group">
                    <label>Costo de Acciones:</label>
                    <input type="number" id="skillActionCost" value="${skill?.actionCost || 1}" min="1">
                </div>
                ${getRaritySelect(skill?.rarity)}
                ${formulaButtons}
            </div>
        `;

        return new Promise((resolve) => {
            modalCallback = () => {
                const newSkill = createSkill({
                    id: skill?.id,
                    name: document.getElementById('skillName').value,
                    desc: document.getElementById('skillDesc').value,
                    mistyCost: document.getElementById('skillMistyCost').value,
                    actionCost: document.getElementById('skillActionCost').value,
                    rarity: document.getElementById('itemRarity').value,
                    formula: document.getElementById('skillFormula').value
                });

                if (!validateSkill(newSkill)) return;

                if (itemId) {
                    const index = character.skills.findIndex(s => s.id === itemId);
                    character.skills[index] = newSkill;
                } else {
                    character.skills.push(newSkill);
                }
                
                renderList('skillsList', character.skills);
                resolve(newSkill);
            };
        });
    }

    async function handleSpellModal(itemId = null) {
        if (!itemId && character.spells.length >= character.spellSystem.slots) {
            await PopupManager.show({
                title: 'Error',
                content: "No hay slots disponibles para más técnicas o hechizos."
            });
            return null;
        }

        const spell = itemId ? character.spells.find(s => s.id === itemId) : null;
        const formulaButtons = createFormulaButtons('spellFormula');
        
        modalBody.innerHTML = `
            <h3>${itemId ? "Editar" : "Crear"} Técnica/Hechizo</h3>
            <div class="modal-form">
                <div class="input-group">
                    <label>Nombre:</label>
                    <input type="text" id="spellName" value="${spell?.name || ''}" required>
                </div>
                <div class="input-group">
                    <label>Tipo:</label>
                    <select id="spellType">
                        <option value="tecnica" ${spell?.type === 'tecnica' ? 'selected' : ''}>Técnica</option>
                        <option value="hechizo" ${spell?.type === 'hechizo' ? 'selected' : ''}>Hechizo</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Descripción:</label>
                    <textarea id="spellDesc">${spell?.desc || ''}</textarea>
                </div>
                <div class="input-group">
                    <label>Costo de Místyculas:</label>
                    <input type="number" id="spellMistyCost" value="${spell?.mistyCost || 0}" min="0">
                </div>
                <div class="input-group">
                    <label>Costo de Acciones:</label>
                    <input type="number" id="spellActionCost" value="${spell?.actionCost || 1}" min="1">
                </div>
                ${getRaritySelect(spell?.rarity)}
                ${formulaButtons}
            </div>
        `;

        modalOverlay.style.display = "flex";

        return new Promise((resolve) => {
            modalCallback = () => {
                const newSpell = {
                    id: spell?.id || Date.now().toString(),
                    name: document.getElementById('spellName').value,
                    type: document.getElementById('spellType').value,
                    desc: document.getElementById('spellDesc').value,
                    mistyCost: parseInt(document.getElementById('spellMistyCost').value) || 0,
                    actionCost: parseInt(document.getElementById('spellActionCost').value) || 1,
                    rarity: document.getElementById('itemRarity').value,
                    formula: document.getElementById('spellFormula').value
                };

                if (!validateSpell(newSpell)) return;

                if (itemId) {
                    const index = character.spells.findIndex(s => s.id === itemId);
                    if (index !== -1) {
                        character.spells[index] = newSpell;
                    }
                } else {
                    character.spells.push(newSpell);
                }
                
                renderList('spellsList', character.spells);
                actualizarSlots();
                resolve(newSpell);
            };
        });
    }

    async function mostrarSlotEquipamiento(itemId) {
        const item = character.items.find(i => i.id === itemId);
        if (!item) return;

        modalBody.innerHTML = `
            <h3>Equipar ${item.name}</h3>
            <div class="modal-form">
                <div class="input-group">
                    <label>Seleccionar Slot:</label>
                    <select id="equipSlot">
                        ${Object.entries(character.equipment).map(([slot, equipped]) => `
                            <option value="${slot}" ${!isValidItemForSlot(item, slot) ? 'disabled' : ''}>
                                ${slot} ${equipped ? '(Ocupado)' : '(Vacío)'}
                            </option>
                        `).join('')}
                    </select>
                </div>
            </div>
        `;

        modalOverlay.style.display = "flex";
        modalCallback = async () => {
            const slot = document.getElementById('equipSlot').value;
            try {
                await equipItem(item, slot);
                renderList('itemsList', character.items);
                renderEquipmentSlots();
            } catch (error) {
                await PopupManager.alert(error.message);
            }
        };
    }
  </script>
</body>
</html>
