<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hoja de Personaje - Isekai Delivery Service v3.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos base y paleta de colores v3.3 */
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-color: #1f2937;
            --text-secondary: #6b7280;
            --title-color: #111827;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --border-color: #e5e7eb;
            --input-bg: #ffffff;
            --stat-bg: #f9fafb;
            --rarity-intrinsic-bg: #f3f4f6;
            --rarity-common-bg: #f9fafb;
            --rarity-rare-bg: #eff6ff;
            --rarity-epic-bg: #f5f3ff;
            --rarity-legendary-bg: #fffbeb;
        }
        
        body.dark {
            --bg-color: #111827;
            --card-bg: #1f2937;
            --text-color: #d1d5db;
            --text-secondary: #9ca3af;
            --title-color: #f9fafb;
            --border-color: #374151;
            --input-bg: #374151;
            --stat-bg: #374151;
            --rarity-intrinsic-bg: #374151;
            --rarity-common-bg: #374151;
            --rarity-rare-bg: #1e3a8a;
            --rarity-epic-bg: #4c1d95;
            --rarity-legendary-bg: #78350f;
        }

        html { scroll-behavior: smooth; }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        .card {
            background-color: var(--card-bg);
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .card-title {
            color: var(--title-color);
            font-weight: 600;
            font-size: 1.125rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.75rem;
            margin-bottom: 1rem;
        }
        .input-field {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: border-color 0.2s, box-shadow 0.2s, background-color 0.3s;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: none;
        }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--accent-hover); }
        .btn-secondary { background-color: #4b5563; color: white; }
        .btn-secondary:hover:not(:disabled) { background-color: #374151; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover:not(:disabled) { background-color: #dc2626; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6); display: flex;
            align-items: center; justify-content: center; z-index: 50;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content {
            background: var(--card-bg);
            color: var(--text-color);
            padding: 1.5rem; border-radius: 0.75rem;
            width: 90%; max-width: 600px; transform: scale(0.95);
            transition: transform 0.3s, background-color 0.3s; display: flex; flex-direction: column;
        }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-scrollable-content { max-height: 70vh; overflow-y: auto; padding-right: 1rem; margin-right: -1rem; }
        .tab-button.active { border-color: var(--accent-color); color: var(--accent-color); font-weight: 600; }
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 22px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(18px); }

        /* Estilos de Rareza */
        .item-card { border-left-width: 5px; transition: all 0.3s ease; }
        .item-card[data-rarity="Intrínseco"] { border-color: #6b7280; background-color: var(--rarity-intrinsic-bg); }
        .item-card[data-rarity="Común"] { border-color: #9ca3af; background-color: var(--rarity-common-bg); }
        .item-card[data-rarity="Raro"] { border-color: #3b82f6; background-color: var(--rarity-rare-bg); }
        .item-card[data-rarity="Épico"] { border-color: #8b5cf6; background-color: var(--rarity-epic-bg); }
        .item-card[data-rarity="Legendario"] { border-color: #f59e0b; background-color: var(--rarity-legendary-bg); }
        
        @keyframes mitico-anim {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .item-card[data-rarity="Mítico / Único"] {
            background: linear-gradient(60deg, #b91c1c, #f59e0b, #ca8a04, #b91c1c);
            background-size: 300% 300%;
            animation: mitico-anim 5s ease infinite;
            border-left-color: transparent;
        }
        .item-card[data-rarity="Mítico / Único"] .rarity-text,
        .item-card[data-rarity="Mítico / Único"] p, 
        .item-card[data-rarity="Mítico / Único"] span, 
        .item-card[data-rarity="Mítico / Único"] .font-bold,
        .item-card[data-rarity="Mítico / Único"] .font-semibold,
        .item-card[data-rarity="Mítico / Único"] .text-gray-500 { 
            color: white; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.4); 
        }
        .item-card[data-rarity="Mítico / Único"] .bg-gray-200,
        .item-card[data-rarity="Mítico / Único"] .bg-gray-100 { 
            background-color: rgba(0,0,0,0.2); 
            border: 1px solid rgba(255,255,255,0.2); 
        }
        
        @keyframes genesis-anim {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .item-card[data-rarity="Genesis"] {
            background: linear-gradient(60deg, #1e3a8a, #059669, #f59e0b, #9333ea, #1e3a8a);
            background-size: 300% 300%;
            animation: genesis-anim 6s ease infinite;
            border-left-color: transparent;
        }
        .item-card[data-rarity="Genesis"] .rarity-text,
        .item-card[data-rarity="Genesis"] p, 
        .item-card[data-rarity="Genesis"] span, 
        .item-card[data-rarity="Genesis"] .font-bold,
        .item-card[data-rarity="Genesis"] .font-semibold,
        .item-card[data-rarity="Genesis"] .text-gray-500 { color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.4); }
        .item-card[data-rarity="Genesis"] .bg-gray-200,
        .item-card[data-rarity="Genesis"] .bg-gray-100 { background-color: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.2); }
        
        .rarity-text { font-weight: 600; }
        .item-card[data-rarity="Intrínseco"] .rarity-text { color: #4b5563; }
        .item-card[data-rarity="Común"] .rarity-text { color: #6b7280; }
        .item-card[data-rarity="Raro"] .rarity-text { color: #2563eb; }
        .item-card[data-rarity="Épico"] .rarity-text { color: #7c3aed; }
        .item-card[data-rarity="Legendario"] .rarity-text { color: #d97706; }
        .item-card[data-rarity="Mítico / Único"] .rarity-text { color: #facc15; }
        .item-card[data-rarity="Genesis"] .rarity-text { color: #a78bfa; }

        body.dark .item-card[data-rarity="Raro"] .rarity-text,
        body.dark .item-card[data-rarity="Épico"] .rarity-text,
        body.dark .item-card[data-rarity="Legendario"] .rarity-text {
             color: #f9fafb;
        }
        .stat-block {
            background-color: var(--stat-bg);
            transition: background-color 0.3s;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl md:text-4xl font-bold text-center mb-2 text-gray-800 dark:text-gray-200">Hoja de Personaje v3.3</h1>
        <p class="text-center text-gray-500 dark:text-gray-400 mb-6">Los cambios se guardan automáticamente en tu navegador.</p>

        <!-- Contenedor Principal con Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Columna Izquierda -->
            <div class="space-y-6">
                <!-- Identidad del Personaje -->
                <div class="card p-6">
                    <h2 class="card-title">Identidad</h2>
                    <div class="space-y-4">
                        <div class="flex items-center space-x-4">
                            <img id="character-image-preview" src="https://placehold.co/100x100/e0e0e0/2c3e50?text=Avatar" alt="Avatar del Personaje" class="w-24 h-24 rounded-full object-cover border-4 border-gray-200 dark:border-gray-700">
                            <div class="space-y-2">
                                <label for="character-image-upload" class="btn btn-primary text-sm w-full">Cargar Imagen</label>
                                <input type="file" id="character-image-upload" class="hidden" accept="image/*">
                            </div>
                        </div>
                        <div>
                            <label for="char-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nombre</label>
                            <input type="text" id="char-name" class="input-field" placeholder="Nombre del Personaje">
                        </div>
                        <div>
                            <label for="char-race" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Raza</label>
                            <input type="text" id="char-race" class="input-field" placeholder="Ej: Humano, Elfo">
                        </div>
                        <div>
                            <label for="char-notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Notas</label>
                            <textarea id="char-notes" class="input-field" rows="2" placeholder="Anotaciones sobre el personaje..."></textarea>
                        </div>
                        <div>
                            <label for="char-personality" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Personalidad</label>
                            <textarea id="char-personality" class="input-field" rows="3" placeholder="Describe la personalidad..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Atributos -->
                <div class="card p-6">
                    <h2 class="card-title">Atributos</h2>
                    <div id="attributes-container" class="space-y-3">
                        <!-- Los atributos se generan dinámicamente aquí -->
                    </div>
                </div>
            </div>

            <!-- Columna Central -->
            <div class="space-y-6">
                <!-- Experiencia y Nivel -->
                <div class="card p-6">
                    <h2 class="card-title">Nivel y Experiencia</h2>
                    <div class="space-y-4">
                        <div class="text-center">
                            <p class="text-lg font-medium">Nivel Actual</p>
                            <p class="text-5xl font-bold" id="level-display">1</p>
                        </div>
                        <div>
                            <p class="text-center font-medium">Experiencia (XP)</p>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4 mt-1">
                                <div id="xp-bar" class="bg-sky-500 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <p class="text-center text-sm mt-1"><span id="current-xp-display">0</span> / <span id="needed-xp-display">300</span> XP</p>
                        </div>
                        <div class="flex gap-2">
                            <input type="number" id="xp-to-add" class="input-field" placeholder="Añadir XP">
                            <button id="add-xp-btn" class="btn btn-primary">Añadir</button>
                        </div>
                    </div>
                </div>

                <!-- Estadísticas Derivadas -->
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-4 gap-2">
                        <h2 class="card-title m-0 p-0 border-none">Estadísticas</h2>
                        <div class="flex gap-2">
                           <button id="restore-stats-btn" class="btn btn-primary text-sm">Restaurar</button>
                           <button id="edit-base-stats-btn" class="btn btn-secondary text-sm">Editar Base</button>
                        </div>
                    </div>
                    <div id="stats-container" class="grid grid-cols-2 gap-x-6 gap-y-3">
                        <!-- Las estadísticas se generan dinámicamente aquí -->
                    </div>
                </div>

                <!-- Combate -->
                <div class="card p-6">
                    <h2 class="card-title">Combate</h2>
                    <div class="space-y-4">
                        <div class="text-center">
                            <p class="text-lg font-medium">Puntos de Acción (PA)</p>
                            <p class="text-4xl font-bold"><span id="current-actions">3</span> / <span id="max-actions">3</span></p>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <button class="btn btn-primary" onclick="useAction(0, 'Hablar')">Hablar (0)</button>
                            <button class="btn btn-primary" onclick="useAction(1, 'Menor')">A. Menor (1)</button>
                            <button class="btn btn-primary" onclick="useAction(1, 'Objeto')">A. Objeto (1)</button>
                            <button class="btn btn-primary" onclick="useAction(2, 'Compleja')">A. Compleja (2)</button>
                            <button class="btn btn-primary" onclick="useAction(3, 'Reacción')">Reacción (3)</button>
                            <button class="btn btn-secondary" onclick="useAction(-1, 'Bonus')">A. Bonus (+1)</button>
                        </div>
                        <button class="btn-primary w-full mt-2" onclick="useAction(20, 'Legendaria')">Acción Legendaria (20)</button>
                        <button id="end-turn-btn" class="btn btn-secondary w-full">Finalizar Turno</button>
                    </div>
                </div>
            </div>

            <!-- Columna Derecha -->
            <div class="space-y-6">
                <!-- Equipamiento -->
                <div class="card p-6">
                    <h2 class="card-title">Equipamiento</h2>
                    <div id="equipment-slots" class="space-y-3">
                        <!-- Los slots de equipamiento se generan dinámicamente aquí -->
                    </div>
                    <button id="manage-slots-btn" class="btn btn-secondary w-full mt-4 text-sm">Gestionar Slots</button>
                </div>

                <!-- Inventario -->
                <div class="card p-6">
                    <h2 class="card-title">Inventario y Habilidades</h2>
                    <!-- Pestañas -->
                    <div class="border-b border-gray-200 dark:border-gray-700 mb-4">
                        <nav class="-mb-px flex space-x-4" id="inventory-tabs">
                            <button data-tab="skills" class="tab-button whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200 active">Habilidades</button>
                            <button data-tab="techniques" class="tab-button whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200">Técnicas/Hechizos</button>
                            <button data-tab="items" class="tab-button whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200">Objetos</button>
                            <button data-tab="pets" class="tab-button whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200">Mascotas</button>
                        </nav>
                    </div>
                    <!-- Contenido de las pestañas -->
                    <div id="inventory-content">
                        <!-- Habilidades -->
                        <div id="tab-content-skills" class="tab-pane active space-y-4">
                            <button id="add-skill-btn" class="btn btn-primary w-full">Añadir Habilidad</button>
                            <div id="skills-list" class="space-y-3"></div>
                        </div>
                        <!-- Técnicas/Hechizos -->
                        <div id="tab-content-techniques" class="tab-pane hidden space-y-4">
                            <div class="text-center font-medium">Slots: <span id="technique-slots">0</span></div>
                            <button id="add-technique-btn" class="btn btn-primary w-full">Añadir Técnica/Hechizo</button>
                            <div id="techniques-list" class="space-y-3"></div>
                        </div>
                        <!-- Objetos -->
                        <div id="tab-content-items" class="tab-pane hidden space-y-4">
                            <button id="add-item-btn" class="btn btn-primary w-full">Añadir Objeto</button>
                            <div id="items-list" class="space-y-3"></div>
                        </div>
                        <!-- Mascotas -->
                        <div id="tab-content-pets" class="tab-pane hidden space-y-4">
                            <button id="add-pet-btn" class="btn btn-primary w-full">Añadir Mascota</button>
                            <div id="pets-list" class="space-y-3"></div>
                        </div>
                    </div>
                </div>

                <!-- Gestión -->
                 <div class="card p-6">
                    <h2 class="card-title">Gestión de Datos</h2>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="theme-toggle-btn" class="btn btn-secondary">Cambiar Tema</button>
                        <button id="export-json-btn" class="btn btn-primary">Exportar</button>
                        <button id="import-json-btn" class="btn btn-primary">Importar</button>
                        <input type="file" id="json-import-input" class="hidden" accept=".json, .txt">
                        <button id="clear-local-data-btn" class="btn btn-danger col-span-2">Limpiar Datos y Reiniciar</button>
                    </div>
                    <div class="mt-4 space-y-2">
                        <input type="text" id="char-titles" class="input-field" placeholder="Títulos y Honores">
                        <input type="text" id="char-spirits" class="input-field" placeholder="Espíritus y Vínculos">
                        <input type="text" id="char-size" class="input-field" placeholder="Tamaño Físico">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Genérico -->
    <div id="modal" class="modal-overlay">
        <div id="modal-content" class="modal-content">
            <!-- El contenido del modal se inyecta aquí -->
        </div>
    </div>

    <!-- Modal Secundario -->
    <div id="modal-secondary" class="modal-overlay" style="z-index: 60;">
        <div id="modal-secondary-content" class="modal-content">
            <!-- Contenido del modal secundario -->
        </div>
    </div>
    
    <!-- Modal de Notificación -->
    <div id="notification-modal" class="modal-overlay" onclick="this.classList.remove('active')">
        <div class="modal-content max-w-sm text-center">
            <h3 id="notification-title" class="text-xl font-bold mb-4"></h3>
            <p id="notification-message" class="whitespace-pre-wrap"></p>
        </div>
    </div>


<script>
// ===================================================================================
// CONFIGURACIÓN Y ESTADO
// ===================================================================================
const XP_TABLE = {
    1: 300, 2: 900, 3: 2700, 4: 6500, 5: 14000,
    6: 23000, 7: 34000, 8: 48000, 9: 64000, 10: 85000,
    11: 100000, 12: 120000, 13: 145000, 14: 165000, 15: 195000,
    16: 225000, 17: 250000, 18: 280000, 19: 315000, 20: Infinity
};
const EVOLUTION_LEVELS = [5, 10, 15, 20];
const RARITIES = ['Intrínseco', 'Común', 'Raro', 'Épico', 'Legendario', 'Mítico / Único', 'Genesis'];
const LOCAL_STORAGE_KEY = 'characterSheetData_v3';
const THEME_STORAGE_KEY = 'characterSheetTheme_v3';

let character; // Se inicializará en window.onload

function getDefaultCharacter() {
    return {
        identity: {
            name: '', race: '', notes: '', personality: '',
            image: 'https://placehold.co/100x100/e0e0e0/2c3e50?text=Avatar',
            titles: '', spirits: '', size: ''
        },
        attributes: {
            FUE: { name: 'Fuerza', value: 10 }, AGI: { name: 'Agilidad', value: 10 },
            MET: { name: 'Metabolismo', value: 10 }, INT: { name: 'Inteligencia', value: 10 },
            APM: { name: 'Aptitud Mágica', value: 10 },
        },
        stats: {
            level: { name: 'Nivel', base: 1, current: 1 }, xp: { name: 'Experiencia', base: 0, current: 0 },
            health: { name: 'Vida', base: 25, current: 25, max: 25 }, armor: { name: 'Armadura', base: 10, current: 10 },
            mana: { name: 'Místyculas', base: 100, current: 100, max: 100 }, actions: { name: 'Acciones', base: 3, current: 3 },
            movement: { name: 'Movimiento', base: 6, current: 6 }, load: { name: 'Carga', base: 10, current: 10 },
            resistance: { name: 'Resistencia', base: 0, current: 0 }, wisdom: { name: 'Sabiduría', base: 0, current: 0 },
        },
        combat: { currentActions: 3, },
        equipment: [
            { slotName: 'Arma', type: 'arma', item: null, isCustom: false, isDamageFormulaActive: false },
            { slotName: 'Armadura', type: 'armadura', item: null, isCustom: false, isDamageFormulaActive: false },
            { slotName: 'Accesorio 1', type: 'accesorio', item: null, isCustom: false, isDamageFormulaActive: false },
            { slotName: 'Accesorio 2', type: 'accesorio', item: null, isCustom: false, isDamageFormulaActive: false },
        ],
        inventory: { skills: [], techniques: [], items: [], pets: [], }
    };
}

// ===================================================================================
// GUARDADO Y CARGA DE DATOS (LocalStorage)
// ===================================================================================

function saveAndRefresh() {
    calculateDerivedStats();
    updateUI();
    saveCharacterToLocalStorage();
}

function saveCharacterToLocalStorage() {
    try {
        // Actualizar campos de texto antes de guardar
        character.identity.name = document.getElementById('char-name').value;
        character.identity.race = document.getElementById('char-race').value;
        character.identity.notes = document.getElementById('char-notes').value;
        character.identity.personality = document.getElementById('char-personality').value;
        character.identity.titles = document.getElementById('char-titles').value;
        character.identity.spirits = document.getElementById('char-spirits').value;
        character.identity.size = document.getElementById('char-size').value;
        
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(character));
    } catch (error) {
        console.error("Error saving character to localStorage:", error);
        showNotification("Error de Guardado", "No se pudo guardar el personaje en el navegador. El almacenamiento podría estar lleno.");
    }
}

function loadCharacterFromLocalStorage() {
    const data = localStorage.getItem(LOCAL_STORAGE_KEY);
    if (data) {
        try {
            return JSON.parse(data);
        } catch (error) {
            console.error("Error parsing character data from localStorage:", error);
            showNotification("Error de Carga", "Los datos locales están corruptos. Se cargará un personaje por defecto.");
            localStorage.removeItem(LOCAL_STORAGE_KEY);
            return null;
        }
    }
    return null;
}

function clearLocalData() {
    openModal(`
        <h3 class="text-xl font-bold mb-4">Confirmar Eliminación</h3>
        <p>¿Seguro que quieres borrar todos los datos del personaje guardados en este navegador? Esta acción no se puede deshacer y la página se recargará.</p>
        <div class="flex justify-end mt-6 space-x-2">
            <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
            <button class="btn btn-danger" id="confirm-delete-btn">Sí, borrar todo</button>
        </div>
    `);
    document.getElementById('confirm-delete-btn').onclick = () => {
        localStorage.removeItem(LOCAL_STORAGE_KEY);
        localStorage.removeItem(THEME_STORAGE_KEY);
        location.reload();
    };
}


// ===================================================================================
// LÓGICA DE CÁLCULO Y NIVELACIÓN
// ===================================================================================

function getXpForNextLevel() {
    const currentLevel = character.stats.level.current;
    if (currentLevel >= 20) return Infinity;
    return XP_TABLE[currentLevel];
}

function addXP(amount) {
    if (character.stats.level.current >= 20) {
        showNotification("Nivel Máximo", "Ya has alcanzado el nivel máximo.");
        return;
    }
    character.stats.xp.current += amount;
    showNotification("Experiencia Ganada", `¡Has ganado ${amount} XP!`);
    
    let xpNeeded = getXpForNextLevel();
    while (character.stats.xp.current >= xpNeeded) {
        if (character.stats.level.current >= 20) {
            character.stats.xp.current = xpNeeded;
            break;
        }
        levelUp(xpNeeded);
        xpNeeded = getXpForNextLevel();
    }
    saveAndRefresh();
}

function levelUp(xpUsed) {
    character.stats.xp.current -= xpUsed;
    character.stats.level.current++;
    character.stats.level.base++; // Actualizar base también
    
    let levelUpMessage = `¡Felicidades! Has alcanzado el nivel ${character.stats.level.current}.`;
    if (EVOLUTION_LEVELS.includes(character.stats.level.current)) {
        levelUpMessage += "\n\n¡Es un Nivel de Evolución! ¡Algo especial podría suceder!";
    }
    showNotification("¡Subiste de Nivel!", levelUpMessage);
    
    // No llamamos a saveAndRefresh aquí porque es llamado por addXP
}


function getModifier(attributeValue) {
    return Math.floor((attributeValue - 10) / 2);
}

function calculateDerivedStats() {
    if (!character) return; // Prevenir errores si el personaje no está cargado

    const tempHealth = character.stats.health.current;
    const tempMana = character.stats.mana.current;
    const tempAttributes = JSON.parse(JSON.stringify(character.attributes));

    // Aplicar bonificaciones de equipo a los atributos temporales
    character.equipment.forEach(slot => {
        if (slot.item) {
            slot.item.effects.forEach(effect => {
                const [type, key, value] = effect.split(':');
                if (type === 'attr' && tempAttributes[key]) {
                    tempAttributes[key].value += parseFloat(value);
                }
            });
        }
    });

    const mods = {
        FUE: getModifier(tempAttributes.FUE.value), AGI: getModifier(tempAttributes.AGI.value),
        MET: getModifier(tempAttributes.MET.value), INT: getModifier(tempAttributes.INT.value),
        APM: getModifier(tempAttributes.APM.value)
    };
    const level = character.stats.level.current;

    let maxHealth = character.stats.health.base + (mods.MET * level);
    let armor = 10 + mods.AGI + mods.MET;
    let maxMana = character.stats.mana.base * Math.max(1, mods.INT) * Math.max(1, mods.APM);
    let actions = character.stats.actions.base + mods.AGI;
    let movement = character.stats.movement.base + (mods.AGI * 2);
    let load = character.stats.load.base + (mods.FUE * 2);
    let wisdom = level + mods.INT;
    let resistance = level + mods.MET;
    
    // Aplicar bonificaciones de equipo directas a las estadísticas
    character.equipment.forEach(slot => {
        if (slot.item) {
            slot.item.effects.forEach(effect => {
                const [type, key, value] = effect.split(':');
                if (type === 'stat') {
                    if (key === 'health') maxHealth += parseFloat(value);
                    if (key === 'mana') maxMana += parseFloat(value);
                    if (key === 'armor') armor += parseFloat(value);
                    if (key === 'actions') actions += parseFloat(value);
                    if (key === 'movement') movement += parseFloat(value);
                    if (key === 'load') load += parseFloat(value);
                    if (key === 'resistance') resistance += parseFloat(value);
                    if (key === 'wisdom') wisdom += parseFloat(value);
                }
            });
        }
    });

    // Asignar los valores finales
    character.stats.health.max = maxHealth;
    character.stats.mana.max = maxMana;
    character.stats.armor.current = armor;
    character.stats.actions.current = actions;
    character.stats.movement.current = movement;
    character.stats.load.current = load;
    character.stats.wisdom.current = wisdom;
    character.stats.resistance.current = resistance;
    
    character.stats.health.current = Math.min(tempHealth, maxHealth);
    character.stats.mana.current = Math.min(tempMana, maxMana);
    
    character.combat.currentActions = Math.min(character.combat.currentActions, character.stats.actions.current);
}


// ===================================================================================
// RENDERIZADO Y ACTUALIZACIÓN DE LA UI
// ===================================================================================

function updateUI() {
    if (!character) return;

    // Identity
    document.getElementById('char-name').value = character.identity.name;
    document.getElementById('char-race').value = character.identity.race;
    document.getElementById('char-notes').value = character.identity.notes;
    document.getElementById('char-personality').value = character.identity.personality;
    document.getElementById('character-image-preview').src = character.identity.image;
    document.getElementById('char-titles').value = character.identity.titles;
    document.getElementById('char-spirits').value = character.identity.spirits;
    document.getElementById('char-size').value = character.identity.size;

    // Attributes
    const attributesContainer = document.getElementById('attributes-container');
    attributesContainer.innerHTML = '';
    for (const key in character.attributes) {
        const attr = character.attributes[key];
        
        let equipmentBonus = 0;
        character.equipment.forEach(slot => {
            if (slot.item) {
                slot.item.effects.forEach(effect => {
                    const [type, effectKey, value] = effect.split(':');
                    if (type === 'attr' && effectKey === key) {
                        equipmentBonus += parseFloat(value);
                    }
                });
            }
        });

        const totalValue = attr.value + equipmentBonus;
        const mod = getModifier(totalValue);

        const div = document.createElement('div');
        div.className = 'grid grid-cols-5 items-center gap-2';
        div.innerHTML = `
            <label for="attr-${key}" class="font-semibold col-span-2">${attr.name}</label>
            <input type="number" id="attr-${key}" class="input-field text-center" value="${attr.value}">
            <span class="text-green-600 font-medium text-center">(+${equipmentBonus})</span>
            <div class="bg-gray-200 dark:bg-gray-600 text-center font-bold rounded-md py-2">${mod >= 0 ? '+' : ''}${mod}</div>
        `;
        attributesContainer.appendChild(div);
    }
    
    // XP & Level
    const xpNeeded = getXpForNextLevel();
    document.getElementById('level-display').textContent = character.stats.level.current;
    document.getElementById('current-xp-display').textContent = character.stats.xp.current;
    document.getElementById('needed-xp-display').textContent = isFinite(xpNeeded) ? xpNeeded : "MAX";
    const xpPercentage = isFinite(xpNeeded) ? (character.stats.xp.current / xpNeeded) * 100 : 100;
    document.getElementById('xp-bar').style.width = `${Math.min(xpPercentage, 100)}%`;


    // Stats
    const statsContainer = document.getElementById('stats-container');
    statsContainer.innerHTML = '';
    const statsToDisplay = {
        health: { name: 'Vida', base: character.stats.health.max, current: character.stats.health.current },
        mana: { name: 'Místyculas', base: character.stats.mana.max, current: character.stats.mana.current },
        armor: { name: 'Armadura', current: character.stats.armor.current },
        actions: { name: 'Acciones', current: character.stats.actions.current },
        movement: { name: 'Movimiento', current: character.stats.movement.current },
        load: { name: 'Carga', current: character.stats.load.current },
        resistance: { name: 'Resistencia', current: character.stats.resistance.current },
        wisdom: { name: 'Sabiduría', current: character.stats.wisdom.current },
    };

    for (const key in statsToDisplay) {
        const stat = statsToDisplay[key];
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center stat-block p-2 rounded-md';
        if (key === 'health' || key === 'mana') {
             div.innerHTML = `
                <span class="font-medium">${stat.name}</span>
                <div class="flex items-center gap-1">
                    <input type="number" id="stat-${key}-current" value="${stat.current}" class="input-field w-16 text-center">
                    <span>/</span>
                    <span class="font-bold">${stat.base}</span>
                </div>
            `;
            statsContainer.appendChild(div);
        } else {
            div.innerHTML = `
                <span class="font-medium">${stat.name}</span>
                <span class="font-bold">${stat.current}</span>
            `;
            statsContainer.appendChild(div);
        }
    }

    // Combat
    document.getElementById('current-actions').textContent = character.combat.currentActions;
    document.getElementById('max-actions').textContent = character.stats.actions.current;
    
    // Technique Slots
    const level = character.stats.level.current;
    let slots = 0;
    if (level >= 1 && level <= 4) slots = 3;
    else if (level >= 5 && level <= 9) slots = 5;
    else if (level >= 10) slots = 12;
    document.getElementById('technique-slots').textContent = `${character.inventory.techniques.length} / ${slots}`;

    renderInventory();
    renderEquipment();
    addEventListeners();
}

function addEventListeners() {
    // Remove old listeners to prevent duplicates if this function is called multiple times.
    // This is a simplified approach. For a larger app, a more robust event delegation strategy would be better.
    
    // Attributes
    for (const key in character.attributes) {
        const input = document.getElementById(`attr-${key}`);
        if(input) {
            input.onchange = (e) => { // Use onchange to avoid multiple listeners
                character.attributes[key].value = parseInt(e.target.value, 10);
                saveAndRefresh();
            };
        }
    }

    // Stats
    ['health', 'mana'].forEach(key => {
        const input = document.getElementById(`stat-${key}-current`);
        if(input) {
            input.onchange = (e) => {
                let val = parseInt(e.target.value, 10);
                if (val > character.stats[key].max) val = character.stats[key].max;
                if (val < 0) val = 0;
                character.stats[key].current = val;
                saveCharacterToLocalStorage(); // Only save, no need to refresh everything
            };
        }
    });

    // Identity fields
    ['char-name', 'char-race', 'char-notes', 'char-personality', 'char-titles', 'char-spirits', 'char-size'].forEach(id => {
        const input = document.getElementById(id);
        if(input) {
            input.onblur = saveCharacterToLocalStorage; // Save when user leaves the field
        }
    });
}


function renderInventory() {
    renderList('skills', character.inventory.skills, renderSkillCard);
    renderList('techniques', character.inventory.techniques, renderTechniqueCard);
    renderList('items', character.inventory.items, renderItemCard);
    renderList('pets', character.inventory.pets, renderPetCard);
}

function renderList(type, list, renderer) {
    const container = document.getElementById(`${type}-list`);
    container.innerHTML = '';
    list.forEach((item, index) => {
        container.appendChild(renderer(item, index));
    });
}

// ===================================================================================
// LÓGICA DE MODALES
// ===================================================================================

const modal = document.getElementById('modal');
const modalContent = document.getElementById('modal-content');
const modalSecondary = document.getElementById('modal-secondary');
const modalSecondaryContent = document.getElementById('modal-secondary-content');


function openModal(content, level = 1) {
    if (level === 1) {
        modalContent.innerHTML = content;
        modal.classList.add('active');
    } else {
        modalSecondaryContent.innerHTML = content;
        modalSecondary.classList.add('active');
    }
}

function closeModal(level = 1) {
    if (level === 1) {
        modal.classList.remove('active');
        modalContent.innerHTML = '';
        if (modalSecondary.classList.contains('active')) {
             modalSecondary.classList.remove('active');
             modalSecondaryContent.innerHTML = '';
        }
    } else {
        modalSecondary.classList.remove('active');
        modalSecondaryContent.innerHTML = '';
    }
}

function showNotification(title, message) {
    document.getElementById('notification-title').textContent = title;
    document.getElementById('notification-message').textContent = message;
    document.getElementById('notification-modal').classList.add('active');
}

// ===================================================================================
// LÓGICA DE INVENTARIO: HABILIDADES, TÉCNICAS, OBJETOS, MASCOTAS
// ===================================================================================

function createRaritySelector(selectedRarity = 'Común') {
    return `
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Rareza</label>
            <select class="input-field item-rarity">
                ${RARITIES.map(r => `<option value="${r}" ${r === selectedRarity ? 'selected' : ''}>${r}</option>`).join('')}
            </select>
        </div>
    `;
}

// --- Habilidades ---
document.getElementById('add-skill-btn').addEventListener('click', () => openSkillForm());

function openSkillForm(skill = null, index = -1) {
    const isEditing = skill !== null;
    const title = isEditing ? 'Editar Habilidad' : 'Añadir Habilidad';
    const btnText = isEditing ? 'Guardar Cambios' : 'Crear Habilidad';
    const content = `
        <h3 class="text-2xl font-bold mb-4">${title}</h3>
        <div class="modal-scrollable-content">
            <div class="space-y-4">
                <input id="skill-name" class="input-field" placeholder="Nombre" value="${skill?.name || ''}">
                <select id="skill-type" class="input-field">
                    <option value="Activa" ${skill?.type === 'Activa' ? 'selected' : ''}>Activa</option>
                    <option value="Pasiva" ${skill?.type === 'Pasiva' ? 'selected' : ''}>Pasiva</option>
                </select>
                <input id="skill-cost-pa" type="number" class="input-field" placeholder="Coste PA" value="${skill?.costPA || 0}">
                <input id="skill-cost-mp" type="number" class="input-field" placeholder="Coste Místyculas" value="${skill?.costMP || 0}">
                
                <div class="border p-4 rounded-md mt-4 border-gray-200 dark:border-gray-600">
                    <label for="skill-formula" class="font-semibold">Fórmula</label>
                    <textarea id="skill-formula" class="input-field mt-1" placeholder="Ej: (FUE)d(6)" rows="2">${skill?.formula || ''}</textarea>
                    <div id="formula-builder-container" class="mt-2"></div>
                </div>

            </div>
        </div>
        <div class="flex justify-end space-x-2 mt-6 pt-4 border-t dark:border-gray-600">
            <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
            <button id="save-skill-btn" class="btn btn-primary">${btnText}</button>
        </div>
    `;
    openModal(content);
    
    renderFormulaBuilder('formula-builder-container', 'skill-formula');
    document.getElementById('save-skill-btn').addEventListener('click', () => saveSkill(index));
}

function saveSkill(index) {
    const isEditing = index !== -1;
    const newSkill = {
        name: document.getElementById('skill-name').value,
        type: document.getElementById('skill-type').value,
        costPA: parseInt(document.getElementById('skill-cost-pa').value) || 0,
        costMP: parseInt(document.getElementById('skill-cost-mp').value) || 0,
        formula: document.getElementById('skill-formula').value,
        rarity: isEditing ? character.inventory.skills[index].rarity : 'Común',
        isDamageFormulaActive: isEditing ? character.inventory.skills[index].isDamageFormulaActive : false,
    };
    if (index === -1) {
        character.inventory.skills.push(newSkill);
    } else {
        character.inventory.skills[index] = { ...character.inventory.skills[index], ...newSkill };
    }
    closeModal();
    saveAndRefresh();
}

function renderSkillCard(skill, index) {
    const card = document.createElement('div');
    card.className = 'p-4 rounded-lg item-card';
    card.dataset.rarity = skill.rarity || 'Común';
    
    const rarityOptions = RARITIES.map(r => `<option value="${r}" ${skill.rarity === r ? 'selected' : ''}>${r}</option>`).join('');

    let damageSwitch = '';
    if (skill.formula) {
        damageSwitch = `
            <div class="flex items-center space-x-2 mt-2">
                <span class="text-xs font-medium">Potenciar con Arma</span>
                <label class="switch">
                    <input type="checkbox" onchange="toggleAbilityDamage(${index}, 'skills')" ${skill.isDamageFormulaActive ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
        `;
    }

    card.innerHTML = `
        <div class="flex justify-between items-start">
            <div>
                <p class="font-bold">${skill.name} <span class="text-sm font-normal">(${skill.type})</span></p>
                <select class="input-field item-rarity-select mt-2 text-sm" onchange="changeRarity('skills', ${index}, this.value)">
                    ${rarityOptions}
                </select>
                <p class="text-sm mt-2">Coste: ${skill.costPA} PA / ${skill.costMP} MP</p>
                <p class="text-sm font-mono bg-gray-200 dark:bg-gray-600 px-2 py-1 rounded mt-1 inline-block">${skill.formula || 'Sin fórmula'}</p>
                ${damageSwitch}
            </div>
            <div class="flex flex-col space-y-1">
                <button class="btn btn-primary text-xs" onclick="useAbility('skills', ${index})">Usar</button>
                <button class="btn btn-secondary text-xs" onclick="openSkillForm(character.inventory.skills[${index}], ${index})">Editar</button>
                <button class="btn btn-danger text-xs" onclick="deleteItem('skills', ${index})">Borrar</button>
            </div>
        </div>
    `;
    return card;
}

function changeRarity(type, index, newRarity) {
    character.inventory[type][index].rarity = newRarity;
    saveAndRefresh();
}

function toggleAbilityDamage(index, type) {
    character.inventory[type][index].isDamageFormulaActive = !character.inventory[type][index].isDamageFormulaActive;
    saveCharacterToLocalStorage();
}

// --- Técnicas/Hechizos ---
document.getElementById('add-technique-btn').addEventListener('click', () => openTechniqueForm());

function openTechniqueForm(tech = null, index = -1) {
    const isEditing = tech !== null;
    const title = isEditing ? 'Editar Técnica/Hechizo' : 'Añadir Técnica/Hechizo';
    const content = `
        <h3 class="text-2xl font-bold mb-4">${title}</h3>
        <div class="modal-scrollable-content">
            <div class="space-y-4">
                <input id="tech-name" class="input-field" placeholder="Nombre" value="${tech?.name || ''}">
                <select id="tech-type" class="input-field">
                    <option value="Técnica" ${tech?.type === 'Técnica' ? 'selected' : ''}>Técnica</option>
                    <option value="Hechizo" ${tech?.type === 'Hechizo' ? 'selected' : ''}>Hechizo</option>
                </select>
                <input id="tech-cost-pa" type="number" class="input-field" placeholder="Coste PA" value="${tech?.costPA || 0}">
                <input id="tech-cost-mp" type="number" class="input-field" placeholder="Coste Místyculas" value="${tech?.costMP || 0}">
                <div class="border p-4 rounded-md mt-4 border-gray-200 dark:border-gray-600">
                    <label for="tech-formula" class="font-semibold">Fórmula</label>
                    <textarea id="tech-formula" class="input-field mt-1" placeholder="Fórmula. Ej: (INT)d(8)" rows="2">${tech?.formula || ''}</textarea>
                    <div id="formula-builder-container" class="mt-2"></div>
                </div>
            </div>
        </div>
        <div class="flex justify-end space-x-2 mt-6 pt-4 border-t dark:border-gray-600">
            <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
            <button id="save-tech-btn" class="btn btn-primary">${isEditing ? 'Guardar' : 'Crear'}</button>
        </div>
    `;
    openModal(content);
    
    renderFormulaBuilder('formula-builder-container', 'tech-formula');
    document.getElementById('save-tech-btn').addEventListener('click', () => saveTechnique(index));
}

function saveTechnique(index) {
    const isEditing = index !== -1;
    const newTech = {
        name: document.getElementById('tech-name').value,
        type: document.getElementById('tech-type').value,
        costPA: parseInt(document.getElementById('tech-cost-pa').value) || 0,
        costMP: parseInt(document.getElementById('tech-cost-mp').value) || 0,
        formula: document.getElementById('tech-formula').value,
        rarity: isEditing ? character.inventory.techniques[index].rarity : 'Común',
        isDamageFormulaActive: isEditing ? character.inventory.techniques[index].isDamageFormulaActive : false,
    };
    if (index === -1) {
        character.inventory.techniques.push(newTech);
    } else {
        character.inventory.techniques[index] = { ...character.inventory.techniques[index], ...newTech };
    }
    closeModal();
    saveAndRefresh();
}

function renderTechniqueCard(tech, index) {
    const card = document.createElement('div');
    card.className = 'p-4 rounded-lg item-card';
    card.dataset.rarity = tech.rarity || 'Común';
    const rarityOptions = RARITIES.map(r => `<option value="${r}" ${tech.rarity === r ? 'selected' : ''}>${r}</option>`).join('');

    let damageSwitch = '';
    if (tech.formula) {
        damageSwitch = `
            <div class="flex items-center space-x-2 mt-2">
                <span class="text-xs font-medium">Potenciar con Arma</span>
                <label class="switch">
                    <input type="checkbox" onchange="toggleAbilityDamage(${index}, 'techniques')" ${tech.isDamageFormulaActive ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
        `;
    }

    card.innerHTML = `
        <div class="flex justify-between items-start">
            <div>
                <p class="font-bold">${tech.name} <span class="text-sm font-normal">(${tech.type})</span></p>
                <select class="input-field item-rarity-select mt-2 text-sm" onchange="changeRarity('techniques', ${index}, this.value)">
                    ${rarityOptions}
                </select>
                <p class="text-sm mt-2">Coste: ${tech.costPA} PA / ${tech.costMP} MP</p>
                <p class="text-sm font-mono bg-gray-200 dark:bg-gray-600 px-2 py-1 rounded mt-1 inline-block">${tech.formula || 'Sin fórmula'}</p>
                ${damageSwitch}
            </div>
            <div class="flex flex-col space-y-1">
                <button class="btn btn-primary text-xs" onclick="useAbility('techniques', ${index})">Usar</button>
                <button class="btn btn-secondary text-xs" onclick="openTechniqueForm(character.inventory.techniques[${index}], ${index})">Editar</button>
                <button class="btn btn-danger text-xs" onclick="deleteItem('techniques', ${index})">Borrar</button>
            </div>
        </div>
    `;
    return card;
}


// --- Objetos ---
document.getElementById('add-item-btn').addEventListener('click', () => openItemForm());

function openItemForm(item = null, index = -1) {
    const isEditing = item !== null;
    const title = isEditing ? 'Editar Objeto' : 'Añadir Objeto';
    
    let structuredEffectsHtml = '';
    let otherEffectsText = '';
    if (item) {
        item.effects.forEach(effect => {
            const parts = effect.split(':');
            if (parts.length === 3) {
                structuredEffectsHtml += generateEffectRowHtml(parts[0], parts[1], parts[2]);
            } else {
                otherEffectsText += effect + '\n';
            }
        });
    }

    const content = `
        <h3 class="text-2xl font-bold mb-4">${title}</h3>
        <div class="modal-scrollable-content">
            <div class="space-y-4">
                <input id="item-name" class="input-field" placeholder="Nombre del Objeto" value="${item?.name || ''}">
                <select id="item-type" class="input-field">
                    <option value="arma" ${item?.type === 'arma' ? 'selected' : ''}>Arma</option>
                    <option value="armadura" ${item?.type === 'armadura' ? 'selected' : ''}>Armadura</option>
                    <option value="accesorio" ${item?.type === 'accesorio' ? 'selected' : ''}>Accesorio</option>
                    <option value="consumible" ${item?.type === 'consumible' ? 'selected' : ''}>Consumible</option>
                    <option value="otro" ${item?.type === 'otro' ? 'selected' : ''}>Otro</option>
                </select>
                <div>
                    <h4 class="font-semibold mb-2">Efectos Estructurados</h4>
                    <div id="structured-effects-container" class="space-y-2">${structuredEffectsHtml}</div>
                    <button id="add-effect-btn" class="btn btn-secondary text-sm mt-2">Añadir Efecto</button>
                </div>
                 <div>
                    <h4 class="font-semibold mb-2">Otros Efectos (Personalizados)</h4>
                    <textarea id="item-other-effects" class="input-field" rows="3" placeholder="Ej: Inmune al fuego\nEj: Brilla en la oscuridad">${otherEffectsText}</textarea>
                </div>
                <div class="border p-4 rounded-md mt-4 border-gray-200 dark:border-gray-600">
                    <label for="item-damage-formula" class="font-semibold">Fórmula de Daño</label>
                    <textarea id="item-damage-formula" class="input-field mt-1" placeholder="Ej: 1d8 + (Mod.FUE)" rows="2">${item?.damageFormula || ''}</textarea>
                    <div id="damage-formula-builder-container" class="mt-2"></div>
                </div>
            </div>
        </div>
        <div class="flex justify-end space-x-2 mt-6 pt-4 border-t dark:border-gray-600">
            <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
            <button id="save-item-btn" class="btn btn-primary">${isEditing ? 'Guardar' : 'Crear'}</button>
        </div>
    `;
    openModal(content);
    
    renderFormulaBuilder('damage-formula-builder-container', 'item-damage-formula');
    document.getElementById('save-item-btn').addEventListener('click', () => saveItem(index));
    document.getElementById('add-effect-btn').addEventListener('click', addEffectRow);
}

function generateEffectRowHtml(type = 'attr', key = 'FUE', value = '1') {
    const effectId = `effect-${Date.now()}-${Math.random()}`;
    const keyOptions = type === 'attr' ? Object.keys(character.attributes) : Object.keys(character.stats).filter(k => k !== 'level' && k !== 'xp');
    
    return `
        <div id="${effectId}" class="grid grid-cols-12 gap-2 items-center">
            <select class="input-field col-span-4 effect-type-select" onchange="updateEffectKeys(this, '${effectId}')">
                <option value="attr" ${type === 'attr' ? 'selected' : ''}>Atributo</option>
                <option value="stat" ${type === 'stat' ? 'selected' : ''}>Estadística</option>
            </select>
            <select class="input-field col-span-4 effect-key-select">
                ${keyOptions.map(k => `<option value="${k}" ${k === key ? 'selected' : ''}>${character.attributes[k]?.name || character.stats[k]?.name}</option>`).join('')}
            </select>
            <input type="number" class="input-field col-span-3 effect-value-input" value="${value}">
            <button class="btn btn-danger btn-sm !p-1.5 col-span-1" onclick="document.getElementById('${effectId}').remove()">X</button>
        </div>
    `;
}

function updateEffectKeys(selectElement, rowId) {
    const row = document.getElementById(rowId);
    const keySelect = row.querySelector('.effect-key-select');
    const selectedType = selectElement.value;
    const keySource = selectedType === 'attr' ? character.attributes : Object.fromEntries(Object.entries(character.stats).filter(([k]) => k !== 'level' && k !== 'xp'));

    keySelect.innerHTML = Object.entries(keySource).map(([key, data]) => `<option value="${key}">${data.name}</option>`).join('');
}


function addEffectRow() {
    const container = document.getElementById('structured-effects-container');
    container.insertAdjacentHTML('beforeend', generateEffectRowHtml());
}

function saveItem(index) {
    const isEditing = index !== -1;
    const effects = [];
    document.querySelectorAll('#structured-effects-container > div').forEach(row => {
        const type = row.querySelector('.effect-type-select').value;
        const key = row.querySelector('.effect-key-select').value;
        const value = row.querySelector('.effect-value-input').value;
        if (type && key && value) {
            effects.push(`${type}:${key}:${value}`);
        }
    });
    
    const otherEffects = document.getElementById('item-other-effects').value.split('\n').filter(e => e.trim() !== '');
    
    const newItem = {
        name: document.getElementById('item-name').value,
        type: document.getElementById('item-type').value,
        effects: [...effects, ...otherEffects],
        damageFormula: document.getElementById('item-damage-formula').value,
        rarity: isEditing ? character.inventory.items[index].rarity : 'Común',
    };

    if (index === -1) {
        character.inventory.items.push(newItem);
    } else {
        character.inventory.items[index] = newItem;
    }
    closeModal();
    saveAndRefresh();
}

function renderItemCard(item, index) {
    const card = document.createElement('div');
    card.className = 'p-4 rounded-lg item-card';
    card.dataset.rarity = item.rarity || 'Común';
    const rarityOptions = RARITIES.map(r => `<option value="${r}" ${item.rarity === r ? 'selected' : ''}>${r}</option>`).join('');
    const effectsList = item.effects.map(e => `<li class="text-xs font-mono">${e}</li>`).join('');
    const damageHtml = item.damageFormula ? `<p class="text-sm font-mono bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300 px-2 py-1 rounded mt-1 inline-block">Daño: ${item.damageFormula}</p>` : '';
    
    card.innerHTML = `
        <div class="flex justify-between items-start">
            <div>
                <p class="font-bold">${item.name} <span class="text-sm font-normal text-gray-500 dark:text-gray-400">(${item.type})</span></p>
                <select class="input-field item-rarity-select mt-2 text-sm" onchange="changeRarity('items', ${index}, this.value)">
                    ${rarityOptions}
                </select>
                <ul class="list-disc list-inside mt-1">${effectsList}</ul>
                ${damageHtml}
            </div>
            <div class="flex flex-col space-y-1">
                ${item.damageFormula ? `<button class="btn btn-danger text-xs" onclick="useItemDamage(${index})">Usar Daño</button>` : ''}
                ${item.type !== 'consumible' && item.type !== 'otro' ? `<button class="btn btn-primary text-xs" onclick="equipItem(${index})">Equipar</button>` : ''}
                <button class="btn btn-secondary text-xs" onclick="openItemForm(character.inventory.items[${index}], ${index})">Editar</button>
                <button class="btn btn-danger text-xs" onclick="deleteItem('items', ${index})">Borrar</button>
            </div>
        </div>
    `;
    return card;
}

// --- Mascotas ---
document.getElementById('add-pet-btn').addEventListener('click', () => openPetForm());

function calculatePetStats(pet) {
    if (!pet.attributes) return pet;

    const mods = {
        FUE: getModifier(pet.attributes.FUE), AGI: getModifier(pet.attributes.AGI),
        MET: getModifier(pet.attributes.MET), INT: getModifier(pet.attributes.INT),
        APM: getModifier(pet.attributes.APM)
    };
    const level = pet.level;

    if (!pet.stats) {
        pet.stats = {
            health: { base: 20, current: 20, max: 20 }, mana: { base: 20, current: 20, max: 20 },
            armor: { base: 10, current: 10 }, actions: { base: 2, current: 2 },
        };
    }
    
    const tempHealth = pet.stats.health.current;
    const tempMana = pet.stats.mana.current;

    const maxHealth = pet.stats.health.base + (mods.MET * level);
    const maxMana = pet.stats.mana.base + (mods.APM * 5) + (mods.INT * 5);
    const armor = pet.stats.armor.base + mods.AGI;
    const actions = pet.stats.actions.base + mods.AGI;

    pet.stats.health.max = maxHealth;
    pet.stats.mana.max = maxMana;
    pet.stats.armor.current = armor;
    pet.stats.actions.current = actions;
    pet.stats.health.current = Math.min(tempHealth, maxHealth);
    pet.stats.mana.current = Math.min(tempMana, maxMana);

    return pet;
}

function openPetForm(pet = null, index = -1) {
    const isEditing = pet !== null;
    const title = isEditing ? 'Editar Mascota' : 'Añadir Mascota';
    
    const attrInputs = Object.keys(character.attributes).map(key => `
        <div class="flex justify-between items-center">
            <label for="pet-attr-${key}" class="font-medium">${character.attributes[key].name}</label>
            <input type="number" id="pet-attr-${key}" class="input-field w-20 text-center" value="${pet?.attributes?.[key] || 10}">
        </div>
    `).join('');

    const content = `
        <h3 class="text-2xl font-bold mb-4">${title}</h3>
        <div class="modal-scrollable-content">
            <div class="space-y-4">
                <div class="flex items-center space-x-4">
                    <img id="pet-image-preview" src="${pet?.image || 'https://placehold.co/80x80/e0e0e0/2c3e50?text=Pet'}" alt="Avatar de la Mascota" class="w-20 h-20 rounded-full object-cover border-4 border-gray-200 dark:border-gray-700">
                    <div>
                        <label for="pet-image-upload" class="btn btn-primary text-sm">Cargar Imagen</label>
                        <input type="file" id="pet-image-upload" class="hidden" accept="image/*">
                    </div>
                </div>
                <input id="pet-name" class="input-field" placeholder="Nombre" value="${pet?.name || ''}">
                <input id="pet-type" class="input-field" placeholder="Tipo (Ej: Bestia, Elemental)" value="${pet?.type || ''}">
                <input id="pet-level" type="number" class="input-field" placeholder="Nivel" value="${pet?.level || 1}">
                ${createRaritySelector(pet?.rarity || 'Común')}
                <textarea id="pet-notes" class="input-field" rows="3" placeholder="Notas, personalidad, historia...">${pet?.notes || ''}</textarea>
                
                <h4 class="font-semibold pt-2 border-t mt-4 dark:border-gray-600">Atributos Base</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2">${attrInputs}</div>

                <h4 class="font-semibold pt-2 border-t mt-4 dark:border-gray-600">Estadísticas Base</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2">
                     <div class="flex justify-between items-center">
                        <label for="pet-base-health" class="font-medium">Vida Base</label>
                        <input type="number" id="pet-base-health" class="input-field w-20 text-center" value="${pet?.stats?.health?.base || 20}">
                    </div>
                     <div class="flex justify-between items-center">
                        <label for="pet-base-mana" class="font-medium">Maná Base</label>
                        <input type="number" id="pet-base-mana" class="input-field w-20 text-center" value="${pet?.stats?.mana?.base || 20}">
                    </div>
                     <div class="flex justify-between items-center">
                        <label for="pet-base-armor" class="font-medium">Armadura Base</label>
                        <input type="number" id="pet-base-armor" class="input-field w-20 text-center" value="${pet?.stats?.armor?.base || 10}">
                    </div>
                     <div class="flex justify-between items-center">
                        <label for="pet-base-actions" class="font-medium">Acciones Base</label>
                        <input type="number" id="pet-base-actions" class="input-field w-20 text-center" value="${pet?.stats?.actions?.base || 2}">
                    </div>
                </div>
            </div>
        </div>
        <div class="flex justify-end space-x-2 mt-6 pt-4 border-t dark:border-gray-600">
            <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
            <button id="save-pet-btn" class="btn btn-primary">${isEditing ? 'Guardar' : 'Crear'}</button>
        </div>
    `;
    openModal(content);

    document.getElementById('pet-image-upload').addEventListener('change', function(event) {
        if (event.target.files && event.target.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('pet-image-preview').src = e.target.result;
            }
            reader.readAsDataURL(event.target.files[0]);
        }
    });

    document.getElementById('save-pet-btn').addEventListener('click', () => savePet(index));
}

function savePet(index) {
    const isEditing = index !== -1;
    const petData = isEditing ? character.inventory.pets[index] : {};

    petData.name = document.getElementById('pet-name').value || 'Mascota sin nombre';
    petData.type = document.getElementById('pet-type').value || 'Desconocido';
    petData.level = parseInt(document.getElementById('pet-level').value) || 1;
    petData.rarity = document.querySelector('.item-rarity').value;
    petData.notes = document.getElementById('pet-notes').value;
    petData.image = document.getElementById('pet-image-preview').src;

    if (!petData.attributes) petData.attributes = {};
    if (!petData.stats) petData.stats = {};
    if (!petData.stats.health) petData.stats.health = {};
    if (!petData.stats.mana) petData.stats.mana = {};
    if (!petData.stats.armor) petData.stats.armor = {};
    if (!petData.stats.actions) petData.stats.actions = {};
    if (!petData.skills) petData.skills = [];

    Object.keys(character.attributes).forEach(key => {
        petData.attributes[key] = parseInt(document.getElementById(`pet-attr-${key}`).value) || 10;
    });

    petData.stats.health.base = parseInt(document.getElementById('pet-base-health').value) || 20;
    petData.stats.mana.base = parseInt(document.getElementById('pet-base-mana').value) || 20;
    petData.stats.armor.base = parseInt(document.getElementById('pet-base-armor').value) || 10;
    petData.stats.actions.base = parseInt(document.getElementById('pet-base-actions').value) || 2;
    
    if (!isEditing) {
        petData.stats.health.current = petData.stats.health.base;
        petData.stats.mana.current = petData.stats.mana.base;
    }

    const finalPet = calculatePetStats(petData);

    if (isEditing) {
        character.inventory.pets[index] = finalPet;
    } else {
        character.inventory.pets.push(finalPet);
    }

    closeModal();
    saveAndRefresh();
}

function renderPetCard(pet, index) {
    const card = document.createElement('div');
    card.className = 'p-4 rounded-lg item-card space-y-4';
    card.dataset.rarity = pet.rarity || 'Común';

    const hydratedPet = calculatePetStats(pet);

    const attributesHtml = Object.entries(hydratedPet.attributes).map(([key, value]) => `
        <div class="flex justify-between text-xs">
            <span class="font-semibold">${key}</span>
            <span>${value} <span class="text-gray-500 dark:text-gray-400">(${getModifier(value) >= 0 ? '+' : ''}${getModifier(value)})</span></span>
        </div>
    `).join('');

    const statsHtml = `
        <div class="flex justify-between items-center text-xs">
            <span class="font-semibold">Vida</span>
            <div class="flex items-center gap-1">
                <input type="number" value="${hydratedPet.stats.health.current}" class="input-field !p-1 !text-xs w-12 text-center" onchange="updatePetStat(${index}, 'health', this.value)">
                <span>/</span>
                <span class="font-bold">${hydratedPet.stats.health.max}</span>
            </div>
        </div>
        <div class="flex justify-between items-center text-xs">
            <span class="font-semibold">Maná</span>
             <div class="flex items-center gap-1">
                <input type="number" value="${hydratedPet.stats.mana.current}" class="input-field !p-1 !text-xs w-12 text-center" onchange="updatePetStat(${index}, 'mana', this.value)">
                <span>/</span>
                <span class="font-bold">${hydratedPet.stats.mana.max}</span>
            </div>
        </div>
        <div class="flex justify-between text-xs"><span class="font-semibold">Armadura</span> <span class="font-bold">${hydratedPet.stats.armor.current}</span></div>
        <div class="flex justify-between text-xs"><span class="font-semibold">Acciones</span> <span class="font-bold">${hydratedPet.stats.actions.current}</span></div>
    `;

    const skillsHtml = hydratedPet.skills.map((skill, skillIndex) => `
        <div class="p-2 border-t dark:border-gray-600 flex justify-between items-center">
            <div>
                <p class="font-semibold text-sm">${skill.name} <span class="text-xs font-normal text-gray-500 dark:text-gray-400">(${skill.type})</span></p>
                <p class="text-xs">Coste: ${skill.costPA || 0} PA / ${skill.costMP || 0} MP</p>
                <p class="text-xs font-mono bg-gray-200 dark:bg-gray-600 px-1 py-0.5 rounded mt-1 inline-block">${skill.formula || 'N/A'}</p>
            </div>
            <div class="flex flex-col gap-1">
                <button class="btn btn-secondary !p-1 text-xs" onclick="openPetSkillForm(${index}, character.inventory.pets[${index}].skills[${skillIndex}], ${skillIndex})">E</button>
                <button class="btn btn-danger !p-1 text-xs" onclick="deletePetSkill(${index}, ${skillIndex})">X</button>
            </div>
        </div>
    `).join('');

    card.innerHTML = `
        <div class="flex justify-between items-start">
            <div class="flex items-center gap-4">
                <img src="${hydratedPet.image}" alt="Avatar" class="w-16 h-16 rounded-full object-cover border-2 border-white shadow-md">
                <div>
                    <p class="font-bold text-lg">${hydratedPet.name}</p>
                    <p class="text-sm rarity-text -mt-1">${hydratedPet.rarity}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">${hydratedPet.type} - Nivel ${hydratedPet.level}</p>
                </div>
            </div>
            <div class="flex flex-col space-y-1">
                 <button class="btn btn-secondary btn-sm" onclick="openPetForm(character.inventory.pets[${index}], ${index})">Editar</button>
                 <button class="btn btn-danger btn-sm" onclick="deleteItem('pets', ${index})">Eliminar</button>
            </div>
        </div>
        <div class="grid grid-cols-2 gap-4 border-t dark:border-gray-600 pt-3">
            <div>
                <h4 class="font-semibold mb-1 text-sm">Atributos</h4>
                <div class="space-y-1">${attributesHtml}</div>
            </div>
             <div>
                <h4 class="font-semibold mb-1 text-sm">Estadísticas</h4>
                <div class="space-y-1">${statsHtml}</div>
            </div>
        </div>
        <div>
            <div class="border-b border-gray-200 dark:border-gray-700">
                <nav class="-mb-px flex space-x-2">
                    <button data-pet-tab="skills" class="tab-button pet-tab-${index} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-xs border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200 active">Habilidades</button>
                    <button data-pet-tab="notes" class="tab-button pet-tab-${index} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-xs border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200">Notas</button>
                </nav>
            </div>
            <div class="mt-2">
                <div id="pet-tab-content-${index}-skills" class="pet-pane-${index} active">
                    <div class="space-y-1 max-h-40 overflow-y-auto">${skillsHtml || '<p class="text-xs text-gray-500 dark:text-gray-400 p-2">Sin habilidades.</p>'}</div>
                    <button class="btn btn-primary text-xs w-full mt-2" onclick="openPetSkillForm(${index})">Añadir Habilidad</button>
                </div>
                <div id="pet-tab-content-${index}-notes" class="pet-pane-${index} hidden">
                    <p class="text-xs p-2 bg-gray-100 dark:bg-gray-800 rounded min-h-[4rem]">${hydratedPet.notes || 'Sin notas.'}</p>
                </div>
            </div>
        </div>
    `;
    
    card.querySelectorAll(`.pet-tab-${index}`).forEach(button => {
        button.addEventListener('click', (e) => {
            const tabName = e.target.dataset.petTab;
            card.querySelectorAll(`.pet-tab-${index}`).forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            card.querySelectorAll(`.pet-pane-${index}`).forEach(pane => pane.classList.add('hidden'));
            card.querySelector(`#pet-tab-content-${index}-${tabName}`).classList.remove('hidden');
        });
    });

    return card;
}

function updatePetStat(petIndex, stat, value) {
    const pet = character.inventory.pets[petIndex];
    if (!pet || !pet.stats[stat]) return;
    let numValue = parseInt(value, 10);
    if (isNaN(numValue)) numValue = 0;
    if (numValue > pet.stats[stat].max) numValue = pet.stats[stat].max;
    if (numValue < 0) numValue = 0;
    pet.stats[stat].current = numValue;
    saveCharacterToLocalStorage();
}

function openPetSkillForm(petIndex, skill = null, skillIndex = -1) {
    const isEditing = skill !== null;
    const title = isEditing ? 'Editar Habilidad de Mascota' : 'Añadir Habilidad de Mascota';
    const content = `
        <h3 class="text-2xl font-bold mb-4">${title}</h3>
        <div class="modal-scrollable-content">
            <div class="space-y-4">
                <input id="pet-skill-name" class="input-field" placeholder="Nombre" value="${skill?.name || ''}">
                <select id="pet-skill-type" class="input-field">
                    <option value="Activa" ${skill?.type === 'Activa' ? 'selected' : ''}>Activa</option>
                    <option value="Pasiva" ${skill?.type === 'Pasiva' ? 'selected' : ''}>Pasiva</option>
                </select>
                <input id="pet-skill-cost-pa" type="number" class="input-field" placeholder="Coste PA" value="${skill?.costPA || 0}">
                <input id="pet-skill-cost-mp" type="number" class="input-field" placeholder="Coste MP" value="${skill?.costMP || 0}">
                <textarea id="pet-skill-formula" class="input-field" placeholder="Fórmula" rows="2">${skill?.formula || ''}</textarea>
            </div>
        </div>
        <div class="flex justify-end space-x-2 mt-6 pt-4 border-t dark:border-gray-600">
            <button class="btn btn-secondary" onclick="closeModal(2)">Cancelar</button>
            <button id="save-pet-skill-btn" class="btn btn-primary">${isEditing ? 'Guardar' : 'Crear'}</button>
        </div>
    `;
    openModal(content, 2);
    document.getElementById('save-pet-skill-btn').addEventListener('click', () => savePetSkill(petIndex, skillIndex));
}

function savePetSkill(petIndex, skillIndex) {
    const newSkill = {
        name: document.getElementById('pet-skill-name').value,
        type: document.getElementById('pet-skill-type').value,
        costPA: parseInt(document.getElementById('pet-skill-cost-pa').value) || 0,
        costMP: parseInt(document.getElementById('pet-skill-cost-mp').value) || 0,
        formula: document.getElementById('pet-skill-formula').value,
    };
    if (skillIndex === -1) {
        character.inventory.pets[petIndex].skills.push(newSkill);
    } else {
        character.inventory.pets[petIndex].skills[skillIndex] = newSkill;
    }
    closeModal(2);
    saveAndRefresh();
}

function deletePetSkill(petIndex, skillIndex) {
    character.inventory.pets[petIndex].skills.splice(skillIndex, 1);
    saveAndRefresh();
}

// --- Borrado genérico ---
function deleteItem(type, index) {
    openModal(`
        <h3 class="text-xl font-bold mb-4">Confirmar Eliminación</h3>
        <p>¿Seguro que quieres borrar este elemento? Esta acción no se puede deshacer.</p>
        <div class="flex justify-end mt-6 space-x-2">
            <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
            <button class="btn btn-danger" id="confirm-delete-btn">Eliminar</button>
        </div>
    `);
    document.getElementById('confirm-delete-btn').onclick = () => {
        character.inventory[type].splice(index, 1);
        closeModal();
        saveAndRefresh();
    };
}


// ===================================================================================
// LÓGICA DE EQUIPAMIENTO
// ===================================================================================

document.getElementById('manage-slots-btn').addEventListener('click', openManageSlotsModal);

function openManageSlotsModal() {
    const generateModalContent = () => {
        const customSlotsHtml = character.equipment
            .map((slot, index) => {
                if (!slot.isCustom) return '';
                return `
                    <div class="flex justify-between items-center p-2 bg-gray-100 dark:bg-gray-800 rounded-md">
                        <span>${slot.slotName}</span>
                        <button class="btn btn-danger btn-sm !p-1.5" onclick="handleDeleteSlot(${index})">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg>
                        </button>
                    </div>`;
            }).join('');

        return `
            <h3 class="text-2xl font-bold mb-4">Gestionar Slots de Equipamiento</h3>
            <div class="modal-scrollable-content">
                <div class="space-y-4">
                    <div>
                        <h4 class="font-semibold mb-2">Añadir Nuevo Slot</h4>
                        <div class="flex gap-2">
                            <input id="new-slot-name-input" class="input-field" placeholder="Nombre del slot">
                            <button id="add-new-slot-btn" class="btn btn-primary">Añadir</button>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">Slots Personalizados</h4>
                        <div id="custom-slots-list" class="space-y-2">
                            ${customSlotsHtml || '<p class="text-gray-500 dark:text-gray-400 text-sm">No hay slots personalizados.</p>'}
                        </div>
                    </div>
                </div>
            </div>
             <div class="flex justify-end mt-6 pt-4 border-t dark:border-gray-600">
                <button class="btn btn-secondary" onclick="closeModal()">Cerrar</button>
            </div>`;
    };

    openModal(generateModalContent());

    document.getElementById('add-new-slot-btn').addEventListener('click', () => {
        const input = document.getElementById('new-slot-name-input');
        const slotName = input.value.trim();
        if (slotName) {
            character.equipment.push({ slotName: slotName, type: 'custom', item: null, isCustom: true, isDamageFormulaActive: false });
            input.value = '';
            openManageSlotsModal(); 
            saveAndRefresh();
        }
    });
}

function handleDeleteSlot(index) {
    removeEquipmentSlot(index);
    openManageSlotsModal();
}


function removeEquipmentSlot(index) {
    if (character.equipment[index].item) {
        unequipItem(index);
    }
    character.equipment.splice(index, 1);
    saveAndRefresh();
}

function renderEquipment() {
    const container = document.getElementById('equipment-slots');
    container.innerHTML = '';
    character.equipment.forEach((slot, index) => {
        const div = document.createElement('div');
        div.className = 'p-3 border dark:border-gray-700 rounded-lg flex justify-between items-center';
        
        let damageSwitch = '';
        if (slot.item && slot.item.damageFormula) {
            damageSwitch = `
                <div class="flex items-center space-x-2 ml-4">
                    <span class="text-xs font-medium">Daño</span>
                    <label class="switch">
                        <input type="checkbox" onchange="toggleDamageFormula(${index})" ${slot.isDamageFormulaActive ? 'checked' : ''}>
                        <span class="slider"></span>
                    </label>
                </div>`;
        }

        div.innerHTML = `
            <div class="flex-grow">
                <p class="font-semibold capitalize">${slot.slotName}</p>
                <p class="text-sm text-gray-600 dark:text-gray-400">${slot.item ? slot.item.name : 'Vacío'}</p>
                 ${slot.item?.damageFormula ? `<p class="text-xs font-mono bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300 px-2 py-1 rounded mt-1 inline-block">${slot.item.damageFormula}</p>` : ''}
            </div>
            <div class="flex items-center">
                 ${damageSwitch}
                ${slot.item ? `<button class="btn btn-secondary text-xs ml-2" onclick="unequipItem(${index})">Desequipar</button>` : ''}
            </div>`;
        container.appendChild(div);
    });
}

function toggleDamageFormula(slotIndex) {
    character.equipment[slotIndex].isDamageFormulaActive = !character.equipment[slotIndex].isDamageFormulaActive;
    saveCharacterToLocalStorage();
}

function equipItem(itemIndex) {
    const item = character.inventory.items[itemIndex];
    if (!item) return;

    const availableSlots = character.equipment.filter(slot => (slot.type === item.type || slot.type === 'custom') && !slot.item);

    if (availableSlots.length === 0) {
        showNotification('Error', `No hay slots de tipo '${item.type}' o personalizados vacíos.`);
        return;
    }

    const slotOptions = availableSlots.map(slot => 
        `<button class="btn btn-primary w-full mb-2" onclick="confirmEquip(${itemIndex}, '${slot.slotName}')">${slot.slotName}</button>`
    ).join('');

    openModal(`
        <h3 class="text-xl font-bold mb-4">Equipar ${item.name}</h3>
        <p>Selecciona un slot para equipar el objeto:</p>
        <div class="mt-4">${slotOptions}</div>
        <div class="flex justify-end mt-6">
            <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
        </div>
    `);
}

function confirmEquip(itemIndex, slotName) {
    const item = character.inventory.items[itemIndex];
    const slotIndex = character.equipment.findIndex(s => s.slotName === slotName);

    if (slotIndex !== -1) {
        character.equipment[slotIndex].item = item;
        character.inventory.items.splice(itemIndex, 1);
        closeModal();
        saveAndRefresh();
    }
}

function unequipItem(slotIndex) {
    const slot = character.equipment[slotIndex];
    if (slot && slot.item) {
        character.inventory.items.push(slot.item);
        slot.item = null;
        slot.isDamageFormulaActive = false;
        saveAndRefresh();
    }
}


// ===================================================================================
// CONSTRUCTOR Y EVALUADOR DE FÓRMULAS
// ===================================================================================

function renderFormulaBuilder(containerId, targetTextareaId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const content = `
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
            <div>
                <h4 class="font-semibold mb-2 text-sm">Atributos</h4>
                <div class="flex flex-col space-y-1">${Object.keys(character.attributes).map(k => `<button class="btn btn-secondary text-xs !p-1" onclick="addToFormula('(${k})', '${targetTextareaId}')">${k}</button>`).join('')}</div>
            </div>
            <div>
                <h4 class="font-semibold mb-2 text-sm">Modificadores</h4>
                <div class="flex flex-col space-y-1">${Object.keys(character.attributes).map(k => `<button class="btn btn-secondary text-xs !p-1" onclick="addToFormula('(Mod.${k})', '${targetTextareaId}')">Mod.${k}</button>`).join('')}</div>
            </div>
            <div>
                <h4 class="font-semibold mb-2 text-sm">Estadísticas</h4>
                 <div class="flex flex-col space-y-1">${Object.keys(character.stats).map(k => `<button class="btn btn-secondary text-xs !p-1" onclick="addToFormula('(${character.stats[k].name})', '${targetTextareaId}')">${character.stats[k].name}</button>`).join('')}</div>
            </div>
            <div>
                <h4 class="font-semibold mb-2 text-sm">Dados</h4>
                <div class="grid grid-cols-3 gap-1">
                    ${['d4','d6','d8','d10','d12','d20','d100'].map(d => `<button class="btn btn-secondary text-xs !p-1" onclick="addToFormula('1${d}', '${targetTextareaId}')">1${d}</button>`).join('')}
                    <button class="btn btn-primary col-span-3 text-xs" onclick="openDiceBuilderModal('${targetTextareaId}')">()d()</button>
                </div>
            </div>
            <div class="col-span-2">
                <h4 class="font-semibold mb-2 text-sm">Operadores</h4>
                <div class="grid grid-cols-4 gap-1">
                    ${['+','-','*','/','(',')'].map(op => `<button class="btn btn-secondary text-xs !p-1" onclick="addToFormula('${op}', '${targetTextareaId}')">${op}</button>`).join('')}
                </div>
            </div>
        </div>
    `;
    container.innerHTML = content;
}

function openDiceBuilderModal(targetTextareaId) {
    const builderButtons = (targetInputId) => {
        let html = '<div class="flex flex-wrap gap-1 mt-2">';
        html += '<p class="w-full text-xs font-semibold text-gray-500 dark:text-gray-400">Atributos:</p>';
        Object.keys(character.attributes).forEach(k => {
            html += `<button class="btn btn-secondary text-xs !p-1" onclick="document.getElementById('${targetInputId}').value = '(${k})'">${k}</button>`;
        });
        html += '<p class="w-full text-xs font-semibold text-gray-500 dark:text-gray-400 mt-1">Modificadores:</p>';
        Object.keys(character.attributes).forEach(k => {
            html += `<button class="btn btn-secondary text-xs !p-1" onclick="document.getElementById('${targetInputId}').value = '(Mod.${k})'">Mod.${k}</button>`;
        });
        html += '<p class="w-full text-xs font-semibold text-gray-500 dark:text-gray-400 mt-1">Estadísticas:</p>';
        Object.keys(character.stats).forEach(k => {
            html += `<button class="btn btn-secondary text-xs !p-1" onclick="document.getElementById('${targetInputId}').value = '(${character.stats[k].name})'">${character.stats[k].name}</button>`;
        });
        html += '</div>';
        return html;
    };
    
    const diceButtons = (targetInputId) => {
        let html = '<div class="flex flex-wrap gap-1 mt-2">';
         html += '<p class="w-full text-xs font-semibold text-gray-500 dark:text-gray-400">Dados:</p>';
        ['4','6','8','10','12','20','100'].forEach(d => {
            html += `<button class="btn btn-secondary text-xs !p-1" onclick="document.getElementById('${targetInputId}').value = '${d}'">d${d}</button>`;
        });
        html += '</div>';
        return html;
    };

    const content = `
        <h3 class="text-xl font-bold mb-4">Constructor de Dados</h3>
        <div class="modal-scrollable-content">
            <div class="space-y-4">
                <div>
                    <label for="dice-count-input" class="font-semibold">Cantidad</label>
                    <input id="dice-count-input" class="input-field mt-1" placeholder="Ej: 1, (FUE), ...">
                    ${builderButtons('dice-count-input')}
                </div>
                <div>
                    <label for="dice-sides-input" class="font-semibold">Caras</label>
                    <input id="dice-sides-input" class="input-field mt-1" placeholder="Ej: 6, 20, (INT), ...">
                    ${builderButtons('dice-sides-input')}
                    ${diceButtons('dice-sides-input')}
                </div>
            </div>
        </div>
        <div class="flex justify-end mt-6 pt-4 border-t dark:border-gray-600 space-x-2">
            <button class="btn btn-secondary" onclick="closeModal(2)">Cancelar</button>
            <button class="btn btn-primary" id="confirm-dice-btn">Añadir Dado</button>
        </div>
    `;
    openModal(content, 2);
    document.getElementById('confirm-dice-btn').addEventListener('click', () => {
        const count = document.getElementById('dice-count-input').value.trim() || '1';
        const sides = document.getElementById('dice-sides-input').value.trim();
        if (sides) {
            addToFormula(`${count}d${sides}`, targetTextareaId);
            closeModal(2);
        } else {
            showNotification("Error", "Debes especificar el número de caras del dado.");
        }
    });
}

function addToFormula(text, targetTextareaId) {
    const textarea = document.getElementById(targetTextareaId);
    if (textarea) {
        textarea.value += text;
    }
}

function safeEvaluateFormula(baseFormula) {
    let combinedFormula = baseFormula;

    character.equipment.forEach(slot => {
        if (slot.item && slot.isDamageFormulaActive && slot.item.damageFormula) {
            combinedFormula += ` + ${slot.item.damageFormula}`;
        }
    });

    if (!combinedFormula || combinedFormula.trim() === '') {
        return { total: 0, rolls: 'Sin fórmula', error: null };
    }

    try {
        let processedFormula = ` ${combinedFormula.trim()} `;

        for (const key in character.attributes) {
            const attr = character.attributes[key];
            const mod = getModifier(attr.value);
            processedFormula = processedFormula.replace(new RegExp(`\\(Mod\\.${key}\\)`, 'gi'), ` ${mod} `);
            processedFormula = processedFormula.replace(new RegExp(`\\(${key}\\)`, 'gi'), ` ${attr.value} `);
        }
        for (const key in character.stats) {
            processedFormula = processedFormula.replace(new RegExp(`\\(${character.stats[key].name}\\)`, 'gi'), ` ${character.stats[key].current} `);
        }
        
        processedFormula = processedFormula.replace(/\(\s*(-?\d+)\s*\)/g, ' $1 ');

        const diceRegex = /(\d+)\s*d\s*(\d+)/gi;
        let diceRollsText = [];
        processedFormula = processedFormula.replace(diceRegex, (match, countStr, sidesStr) => {
            const count = parseInt(countStr, 10);
            const sides = parseInt(sidesStr, 10);
            if (isNaN(count) || isNaN(sides) || count < 1 || sides < 1) {
                throw new Error(`Tirada de dado inválida: "${match.trim()}"`);
            }
            let total = 0;
            let rolls = [];
            for (let i = 0; i < count; i++) {
                const roll = Math.floor(Math.random() * sides) + 1;
                rolls.push(roll);
                total += roll;
            }
            diceRollsText.push(`${count}d${sides} (${rolls.join(', ')})`);
            return ` ${total} `;
        });
        
        processedFormula = processedFormula.replace(/\s+/g, ' ').trim();
        if (/[^0-9.+\-*/()\s]/.test(processedFormula)) {
            throw new Error('La fórmula contiene caracteres no válidos.');
        }
        if (/([+\-*/]){2,}/.test(processedFormula)) {
            throw new Error('La fórmula contiene operadores duplicados (ej: "++" o "*-").');
        }

        const finalResult = new Function(`return ${processedFormula}`)();
        
        return { total: finalResult, rolls: diceRollsText.join('; ') || 'N/A', error: null };

    } catch (e) {
        console.error("Error en fórmula:", e.message);
        return { total: 0, rolls: '', error: e.message };
    }
}


function useAbility(type, index) {
    const ability = character.inventory[type][index];

    if (!ability.formula) {
        showNotification('Error', 'Esta habilidad no tiene una fórmula para ser usada.');
        return;
    }
    if (character.combat.currentActions < ability.costPA) {
        showNotification('Error', 'No tienes suficientes Puntos de Acción.');
        return;
    }
    if (character.stats.mana.current < ability.costMP) {
        showNotification('Error', 'No tienes suficientes Místyculas.');
        return;
    }

    const result = safeEvaluateFormula(ability.formula);

    if (result.error) {
        showNotification('Error de Fórmula', `No se pudo usar la habilidad.\nError: ${result.error}`);
    } else {
        character.combat.currentActions -= ability.costPA;
        character.stats.mana.current -= ability.costMP;
        showNotification(`Resultado de ${ability.name}`, `Total: ${result.total}\nDetalle: ${result.rolls}`);
    }
    
    saveAndRefresh();
}

function useItemDamage(itemIndex) {
    const item = character.inventory.items[itemIndex];
    if (!item || !item.damageFormula) {
        showNotification('Error', 'Este objeto no tiene una fórmula de daño.');
        return;
    }

    const result = safeEvaluateFormula(item.damageFormula);

    if (result.error) {
        showNotification('Error de Fórmula', `No se pudo usar el objeto.\nError: ${result.error}`);
    } else {
        showNotification(`Daño de ${item.name}`, `Total: ${result.total}\nDetalle: ${result.rolls}`);
    }
    
    saveAndRefresh();
}

// ===================================================================================
// OTRAS FUNCIONALIDADES: COMBATE, GESTIÓN, ETC.
// ===================================================================================

// --- Combate ---
function useAction(cost, type) {
    if (cost < 0) {
        character.combat.currentActions -= cost;
        showNotification('Acción Bonus', `Has ganado ${-cost} PA. Total: ${character.combat.currentActions} PA.`);
    } else if (character.combat.currentActions >= cost) {
        character.combat.currentActions -= cost;
        showNotification('Acción Realizada', `Usaste una Acción ${type}. Te quedan ${character.combat.currentActions} PA.`);
    } else {
        showNotification('Sin PA', 'No tienes suficientes Puntos de Acción.');
    }
    saveAndRefresh();
}

document.getElementById('end-turn-btn').addEventListener('click', () => {
    character.combat.currentActions = character.stats.actions.current;
    showNotification('Turno Finalizado', 'Puntos de Acción restaurados.');
    saveAndRefresh();
});

// --- Restaurar Vida y Maná ---
function restoreHealthAndMana() {
    character.stats.health.current = character.stats.health.max;
    character.stats.mana.current = character.stats.mana.max;
    showNotification('Recursos Restaurados', 'La vida y las místyculas se han restaurado al máximo.');
    saveAndRefresh();
}

// --- Gestión ---
document.getElementById('export-json-btn').addEventListener('click', () => {
    saveCharacterToLocalStorage(); // Ensure latest data is captured
    const dataStr = JSON.stringify(character, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    const exportFileDefaultName = `${character.identity.name.replace(/\s/g, '_') || 'personaje'}.json`;
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
});

document.getElementById('import-json-btn').addEventListener('click', () => {
    document.getElementById('json-import-input').click();
});

document.getElementById('json-import-input').addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        openModal(`
            <h3 class="text-xl font-bold mb-4">Confirmar Importación</h3>
            <p>Estás a punto de sobrescribir tu personaje actual con los datos del archivo <strong>${file.name}</strong>. Esta acción no se puede deshacer.</p>
            <p class="mt-2">¿Estás seguro de que quieres continuar?</p>
            <div class="flex justify-end mt-6 space-x-2">
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" id="confirm-import-btn">Sí, importar</button>
            </div>
        `);
        document.getElementById('confirm-import-btn').onclick = () => {
            try {
                const importedData = JSON.parse(e.target.result);
                if (importedData.identity && importedData.attributes && importedData.stats) {
                    // Simple compatibility check for old equipment structure
                    if (importedData.equipment && !Array.isArray(importedData.equipment)) {
                        importedData.equipment = getDefaultCharacter().equipment;
                    }
                    character = importedData;
                    saveAndRefresh();
                    showNotification('Éxito', 'Personaje importado correctamente.');
                } else {
                    showNotification('Error', 'El archivo JSON no tiene el formato de personaje esperado.');
                }
            } catch (error) {
                showNotification('Error de Archivo', 'No se pudo leer o procesar el archivo JSON. Asegúrate de que el formato es correcto.');
            } finally {
                closeModal();
                event.target.value = ''; // Reset file input
            }
        };
    };
    reader.readAsText(file);
});

document.getElementById('clear-local-data-btn').addEventListener('click', clearLocalData);


document.getElementById('edit-base-stats-btn').addEventListener('click', () => {
    const content = `
        <h3 class="text-2xl font-bold mb-4">Editar Valores Base</h3>
        <div class="modal-scrollable-content">
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Ajusta los valores base de tu personaje. El nivel y la experiencia se gestionan por separado.</p>
            <div class="space-y-2">
            ${Object.keys(character.stats).filter(key => !['level', 'xp', 'health', 'mana'].includes(key)).map(key => `
                <div class="flex justify-between items-center">
                    <label for="base-stat-${key}">${character.stats[key].name}</label>
                    <input type="number" id="base-stat-${key}" class="input-field w-24 text-center" value="${character.stats[key].base}">
                </div>
            `).join('')}
            <div class="flex justify-between items-center pt-2 border-t dark:border-gray-600">
                <label for="base-stat-health">Vida Base</label>
                <input type="number" id="base-stat-health" class="input-field w-24 text-center" value="${character.stats.health.base}">
            </div>
            <div class="flex justify-between items-center">
                <label for="base-stat-mana">Místyculas Base</label>
                <input type="number" id="base-stat-mana" class="input-field w-24 text-center" value="${character.stats.mana.base}">
            </div>
            <div class="flex justify-between items-center pt-2 border-t dark:border-gray-600">
                <label for="base-stat-level">Nivel</label>
                <input type="number" id="base-stat-level" class="input-field w-24 text-center" value="${character.stats.level.base}">
            </div>
            </div>
        </div>
        <div class="flex justify-end mt-6 pt-4 border-t dark:border-gray-600">
            <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
            <button class="btn btn-primary" id="save-base-stats">Guardar y Recalcular</button>
        </div>
    `;
    openModal(content);

    document.getElementById('save-base-stats').addEventListener('click', () => {
        Object.keys(character.stats).filter(key => !['level', 'xp'].includes(key)).forEach(key => {
            const input = document.getElementById(`base-stat-${key}`);
            if(input) character.stats[key].base = parseInt(input.value) || 0;
        });

        const newLevel = parseInt(document.getElementById('base-stat-level').value) || 1;
        if (newLevel !== character.stats.level.base) {
            character.stats.level.base = newLevel;
            character.stats.level.current = newLevel;
            character.stats.xp.base = 0;
            character.stats.xp.current = 0;
        }

        closeModal();
        saveAndRefresh();
    });
});

// --- Pestañas de Inventario ---
document.getElementById('inventory-tabs').addEventListener('click', (e) => {
    if (e.target.tagName === 'BUTTON') {
        const tab = e.target.dataset.tab;
        
        document.querySelectorAll('#inventory-tabs .tab-button').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');

        document.querySelectorAll('#inventory-content .tab-pane').forEach(pane => pane.classList.add('hidden'));
        document.getElementById(`tab-content-${tab}`).classList.remove('hidden');
    }
});

// --- Carga de Imagen ---
document.getElementById('character-image-upload').addEventListener('change', function(event) {
    if (event.target.files && event.target.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            character.identity.image = e.target.result;
            document.getElementById('character-image-preview').src = e.target.result;
            saveCharacterToLocalStorage();
        }
        reader.readAsDataURL(event.target.files[0]);
    }
});

// --- Añadir XP ---
document.getElementById('add-xp-btn').addEventListener('click', () => {
    const xpInput = document.getElementById('xp-to-add');
    const amount = parseInt(xpInput.value, 10);
    if (!isNaN(amount) && amount > 0) {
        addXP(amount);
        xpInput.value = '';
    }
});

// --- Tema ---
function toggleTheme() {
    document.body.classList.toggle('dark');
    const currentTheme = document.body.classList.contains('dark') ? 'dark' : 'light';
    localStorage.setItem(THEME_STORAGE_KEY, currentTheme);
}

// ===================================================================================
// INICIALIZACIÓN
// ===================================================================================
window.onload = () => {
    const savedTheme = localStorage.getItem(THEME_STORAGE_KEY);
    if (savedTheme === 'dark') {
        document.body.classList.add('dark');
    }

    const loadedCharacter = loadCharacterFromLocalStorage();
    character = loadedCharacter ? loadedCharacter : getDefaultCharacter();
    
    // Ensure all properties exist to avoid errors with older save files
    const defaultChar = getDefaultCharacter();
    character = {...defaultChar, ...character};
    character.identity = {...defaultChar.identity, ...character.identity};
    character.attributes = {...defaultChar.attributes, ...character.attributes};
    character.stats = {...defaultChar.stats, ...character.stats};
    character.inventory = {...defaultChar.inventory, ...character.inventory};
    character.equipment = character.equipment && character.equipment.length > 0 ? character.equipment : defaultChar.equipment;

    // Add event listeners for new buttons
    document.getElementById('theme-toggle-btn').addEventListener('click', toggleTheme);
    document.getElementById('restore-stats-btn').addEventListener('click', restoreHealthAndMana);

    calculateDerivedStats();
    updateUI();
};

</script>
</body>
</html>
