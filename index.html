<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hoja de Personaje RPG - Login y Panel</title>
  
  <style>
    /* Reset y estilos base */
    * { 
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        background: #f0f2f5;
        font-family: 'Segoe UI', Roboto, Arial, sans-serif;
        color: #2c3e50;
        line-height: 1.6;
        padding: 20px;
    }

    /* Layout */
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    /* Cards */
    .card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0,0,0,0.1);
    }

    /* Typography */
    h1 {
        font-size: 2.5em;
        color: #2c3e50;
        text-align: center;
        margin-bottom: 30px;
        font-weight: 600;
    }

    h2 {
        font-size: 1.8em;
        color: #34495e;
        margin-bottom: 20px;
        text-align: center;
    }

    /* Forms */
    label {
        display: block;
        margin-bottom: 8px;
        color: #34495e;
        font-weight: 500;
    }

    input[type="text"],
    input[type="number"],
    textarea {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 1em;
        transition: all 0.3s;
        margin-bottom: 15px;
        background: #f8f9fa;
    }

    input:focus, textarea:focus {
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        outline: none;
        background: white;
    }

    /* Buttons */
    .btn {
        background: #3498db;
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 1em;
        font-weight: 500;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin: 5px;
    }

    .btn:hover {
        background: #2980b9;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(52,152,219,0.3);
    }

    .btn-small {
        padding: 8px 15px;
        font-size: 0.9em;
    }

    /* Tables */
    table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin: 20px 0;
    }

    th {
        background: #3498db;
        color: white;
        padding: 15px;
        text-align: center;
        font-weight: 600;
        border-radius: 10px 10px 0 0;
    }

    td {
        padding: 15px;
        text-align: center;
        background: white;
        border-bottom: 1px solid #eee;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin: 20px 0;
    }

    .stat-card {
        background: linear-gradient(145deg, #ffffff, #f0f2f5);
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        text-align: center;
        transition: all 0.3s ease;
        border: 2px solid #e0e0e0;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .stat-title {
        color: #2c3e50;
        font-size: 1.2em;
        margin-bottom: 10px;
        font-weight: 600;
    }

    .stat-value {
        font-size: 1.8em;
        color: #3498db;
        font-weight: bold;
    }

    .elements-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 4px;
        margin: 20px 0;
    }

    .elements-table td {
        position: relative;
        height: 50px;
        width: 80px;
        transition: all 0.3s;
        text-align: center;
        color: white;
        font-weight: bold;
    }

    .elements-table input {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 60px;
        text-align: center;
        padding: 4px;
        border: 2px solid transparent;
        border-radius: 4px;
        background: rgba(255, 255, 255, 0.9);
        z-index: 2;
    }

    /* Element Colors */
    td[data-element="fire"] { background: linear-gradient(145deg, #ff4d4d, #cc0000); }
    td[data-element="air"] { background: linear-gradient(145deg, #e6e6e6, #cccccc); }
    td[data-element="water"] { background: linear-gradient(145deg, #4d94ff, #0052cc); }
    td[data-element="electric"] { background: linear-gradient(145deg, #ffff4d, #cccc00); }
    td[data-element="earth"] { background: linear-gradient(145deg, #994d00, #663300); }
    td[data-element="light"] { background: linear-gradient(145deg, #ffff99, #ffcc00); }
    td[data-element="dark"] { background: linear-gradient(145deg, #4d4d4d, #1a1a1a); }

    /* Combat Panel */
    .combat-panel {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin: 20px 0;
    }

    .combat-buttons {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        margin: 20px 0;
    }

    /* Item List */
    .item-list {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
    }

    .item {
        background: white;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    /* Rarity Styles */
    .item.intrinceca {
        background: linear-gradient(145deg, #4d4d4d, #1a1a1a);
        border-left: 4px solid #666;
        color: #fff;
    }

    .item.comun {
        background: linear-gradient(145deg, #4CAF50, #707070);
        border-left: 4px solid #4CAF50;
        color: #fff;
    }

    .item.epica {
        background: linear-gradient(145deg, #9C27B0, #1a1a1a);
        border-left: 4px solid #9C27B0;
        color: #fff;
        box-shadow: 0 2px 8px rgba(156,39,176,0.3);
    }

    .item.legendaria {
        background: linear-gradient(145deg, #FFC107, #FF5722);
        border-left: 4px solid #FFC107;
        color: #fff;
        box-shadow: 0 2px 12px rgba(255,193,7,0.4);
    }

    .item.mitica {
        background: linear-gradient(145deg, #FF0000, #FFD700);
        border-left: 4px solid #FF0000;
        color: #fff;
        box-shadow: 0 2px 15px rgba(255,0,0,0.4);
        animation: mythicGlow 2s infinite;
    }

    .item.genesis {
        background: linear-gradient(145deg, #00ff88, #4169E1, #FFD700);
        border-left: 4px solid #00ff88;
        color: #fff;
        box-shadow: 0 2px 20px rgba(0,255,136,0.5);
        animation: genesisGlow 3s infinite;
    }

    .modal {
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.7);
        overflow: auto;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: white;
        margin: auto;
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 600px;
        position: relative;
        top: 50%;
        transform: translateY(-50%);
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        animation: modalFadeIn 0.3s;
        max-height: 80vh;
        overflow-y: auto;
    }

    .modal-close {
        position: absolute;
        right: 20px;
        top: 15px;
        font-size: 28px;
        font-weight: bold;
        color: #666;
        cursor: pointer;
        transition: all 0.3s;
    }

    .modal-close:hover {
        color: #000;
        transform: rotate(90deg);
    }

    @keyframes modalFadeIn {
        from {
            opacity: 0;
            transform: translateY(-60%);
        }
        to {
            opacity: 1;
            transform: translateY(-50%);
        }
    }

    /* Mejorar estilos internos del modal */
    .modal h3 {
        margin-bottom: 20px;
        color: #2c3e50;
        font-size: 1.5em;
    }

    .modal label {
        display: block;
        margin-top: 15px;
        margin-bottom: 5px;
        color: #34495e;
        font-weight: 500;
    }

    .modal input,
    .modal textarea {
        width: 100%;
        padding: 10px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 15px;
        font-size: 1em;
    }

    .modal textarea {
        min-height: 100px;
        resize: vertical;
    }

    .modal .btn {
        margin: 5px;
    }

    /* Modificar los estilos de formula-buttons y formula-btn */
    .formula-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 15px 0;
        justify-content: center;
    }

    .formula-btn {
        background: #3498db;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.3s;
        min-width: 40px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .formula-btn:hover {
        background: #2980b9;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    /* Loading Spinner */
    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    @keyframes spin {
        0% { transform: translate(-50%, -50%) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    .modal-content.loading {
        opacity: 0.7;
        pointer-events: none;
    }

    /* Agregar en la sección de estilos */
    .stats-control-buttons {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        margin: 15px 0;
    }

    .stats-control-buttons .btn {
        min-width: 150px;
        text-align: center;
        background: linear-gradient(45deg, #3498db, #2980b9);
        transition: all 0.3s ease;
    }

    .stats-control-buttons .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(52,152,219,0.3);
        background: linear-gradient(45deg, #2980b9, #2c3e50);
    }

    /* Agregar en la sección de estilos */
    .custom-popup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        z-index: 2000;
        min-width: 300px;
        text-align: center;
        animation: popupFadeIn 0.3s;
    }

    .custom-popup .popup-title {
        font-size: 1.2em;
        font-weight: bold;
        margin-bottom: 15px;
        color: #2c3e50;
    }

    .custom-popup .popup-content {
        margin-bottom: 20px;
        white-space: pre-line;
    }

    .custom-popup .popup-buttons {
        display: flex;
        justify-content: center;
        gap: 10px;
    }

    @keyframes popupFadeIn {
        from {
            opacity: 0;
            transform: translate(-50%, -60%);
        }
        to {
            opacity: 1;
            transform: translate(-50%, -50%);
        }
    }

    .popup-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1999;
    }
  </style>
</head>
<body>

  <!-- Main Content -->
  <div id="mainPage">
    <div class="container">
      <!-- Admin Panel (Visible only to admin) -->
      <div id="adminPanel" class="card" style="display:none;">
        <h2>Panel de Admin</h2>
        <p>Permiso para crear usuarios:</p>
        <button class="btn" onclick="crearUsuario()">Crear Nuevo Usuario</button>
      </div>

      <!-- Datos del Personaje -->
      <div class="card">
        <h1>Hoja de Personaje RPG</h1>
        <div class="grid">
          <div class="half">
            <label for="charName">Nombre</label>
            <input type="text" id="charName" placeholder="Nombre del personaje">
            <label for="charRace">Raza</label>
            <input type="text" id="charRace" placeholder="Raza del personaje">
            <label for="charLang">Idiomas</label>
            <input type="text" id="charLang" placeholder="Ej: Español, Inglés">
            <label for="charPerso">Personalidad</label>
            <input type="text" id="charPerso" placeholder="Personalidad">
          </div>
          <div class="half">
            <label>Imagen</label>
            <div id="imgContainer" style="width:90%; height:220px; border:2px dashed #ccc; display:flex; align-items:center; justify-content:center; cursor:pointer; margin:auto;">
              <span>Click para cargar imagen</span>
            </div>
            <input type="file" id="imgUpload" style="display:none;">
          </div>
        </div>
      </div>

      <!-- Elementos -->
      <div class="card">
        <h2>Elementos</h2>
        <table class="elements-table">
          <thead>
            <tr>
              <th>Fuego</th>
              <th>Aire</th>
              <th>Agua</th>
              <th>Electricidad</th>
              <th>Tierra</th>
              <th>Luz</th>
              <th>Oscuridad</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td data-element="fire"><input type="number" id="elemFire" value="10" min="10" max="100"></td>
              <td data-element="air"><input type="number" id="elemAir" value="10" min="10" max="100"></td>
              <td data-element="water"><input type="number" id="elemWater" value="10" min="10" max="100"></td>
              <td data-element="electric"><input type="number" id="elemElectricidad" value="10" min="10" max="100"></td>
              <td data-element="earth"><input type="number" id="elemEarth" value="10" min="10" max="100"></td>
              <td data-element="light"><input type="number" id="elemLight" value="10" min="10" max="100"></td>
              <td data-element="dark"><input type="number" id="elemDark" value="10" min="10" max="100"></td>
            </tr>
          </tbody>
        </table>
        <small style="display:block; text-align:center; margin-top:10px; color:#666;">
          1-30: Bajo | 31-70: Estándar | 71-100: Potenciado
        </small>
      </div>

      <!-- Atributos -->
      <div class="card">
        <h2>Atributos</h2>
        <table>
          <thead>
            <tr>
              <th>Fuerza</th>
              <th>Inteligencia</th>
              <th>Agilidad</th>
              <th>Metabolismo</th>
              <th>A.M</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>
                <input type="number" id="attrFuerza" value="10" min="10">
                <div id="modFuerza">0</div>
              </td>
              <td>
                <input type="number" id="attrInt" value="10" min="10">
                <div id="modInt">0</td>
              <td>
                <input type="number" id="attrAgil" value="10" min="10">
                <div id="modAgil">0</div>
              </td>
              <td>
                <input type="number" id="attrMetab" value="10" min="10">
                <div id="modMetab">0</div>
              </td>
              <td>
                <input type="number" id="attrAM" value="10" min="10">
                <div id="modAM">0</div>
              </td>
            </tr>
          </tbody>
        </table>
        <small>Modificador = (Valor - 10) / 2</small>
      </div>

      <!-- Estadísticas Principales -->
      <div class="card">
        <h2>Estadísticas Principales</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-title">Vida</div>
            <div class="stat-value" id="calcVida">0 / 0</div>
          </div>
          <div class="stat-card">
            <div class="stat-title">Armadura</div>
            <div class="stat-value" id="calcArmor">10</div>
          </div>
          <div class="stat-card">
            <div class="stat-title">Místyculas</div>
            <div class="stat-value" id="calcMistyculas">0 / 0</div>
          </div>
        </div>
      </div>

      <!-- Experiencia -->
      <div class="card">
        <h2>Experiencia</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-title">Nivel</div>
            <div class="stat-value" id="calcNivel">1 / 20</div>
          </div>
          <div class="stat-card">
            <div class="stat-title">Experiencia</div>
            <div class="stat-value" id="calcXP">0 / 0</div>
          </div>
          <div class="stat-card">
            <div class="xp-input">
              <input type="number" id="inputXP" placeholder="XP" value="0" min="0">
              <button class="btn btn-small" onclick="agregarXP()">+</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Acciones & Combate -->
      <div class="card">
        <h2>Acciones & Combate</h2>
        <div id="accionesDisplay" style="text-align:center; font-size:1.1em; margin-bottom:15px;">
          Acciones: <span id="currentAcciones">0</span> / <span id="maxAcciones">0</span>
        </div>
        <!-- Panel de Combate -->
        <div class="combat-panel">
          <div><input type="number" id="inputDamage" placeholder="Daño" value="0" min="0"></div>
          <div><input type="number" id="inputHeal" placeholder="Curar" value="0" min="0"></div>
          <div><input type="number" id="inputMistyRegen" placeholder="Recuperar Místyculas" value="0" min="0"></div>
        </div>
        <div class="combat-buttons">
          <button class="btn" onclick="aplicarDaño()">Aplicar Daño</button>
          <button class="btn" onclick="aplicarCura()">Aplicar Cura</button>
          <button class="btn" onclick="regenerarMisty()">Recuperar Místyculas</button>
        </div>
        <hr>
        <div style="text-align:center; margin-top:10px;">
          <p><strong>Aplicar Costos de Acción:</strong></p>
          <button class="btn" onclick="aplicarAccionCompleja()">Acción Compleja (-2)</button>
          <button class="btn" onclick="aplicarAccionMenor()">Acción Menor (-1)</button>
          <button class="btn" onclick="aplicarReaccion()">Reacción (-3)</button>
          <button class="btn" onclick="aplicarAccionObjeto()">Acción Objeto (-1)</button>
          <button class="btn" onclick="aplicarAccionBonus()">Acción Bonus (+1)</button>
          <button class="btn" onclick="aplicarAccionLegendaria()">Acción Legendaria (-10 a -20)</button>
          <button class="btn" onclick="alert('Hablar no cuesta acciones.')">Hablar (0)</button>
        </div>
      </div>

      <!-- Control de Estadísticas -->
      <div class="card">
        <h2>Control de Estadísticas</h2>
        <div class="stats-control-buttons">
            <button class="btn" onclick="openModal('editStatsModal')">Editar Estadísticas</button>
            <button class="btn" onclick="nuevaRonda()">Nueva Ronda</button>
            <button class="btn" onclick="resetAcciones()">Reset Acciones</button>
        </div>
      </div>

      <!-- Secciones: Habilidades, Hechizos -->
      <div class="card">
        <h2>Habilidades</h2>
        <div class="item-list" id="skillsList"></div>
        <div style="text-align:center;">
          <button class="btn" onclick="openModal('skillModal')">Agregar / Editar Habilidad</button>
        </div>
      </div>
      <div class="card">
        <h2>Hechizos</h2>
        <div class="item-list" id="spellsList"></div>
        <div style="text-align:center;">
          <button class="btn" onclick="openModal('spellModal')">Agregar / Editar Hechizo</button>
        </div>
      </div>

      <!-- Objetos -->
      <div class="card">
        <h2>Objetos</h2>
        <div class="item-list" id="itemsList"></div>
        <div style="text-align:center;">
          <button class="btn" onclick="openModal('itemModal')">Agregar / Editar Objeto</button>
        </div>
      </div>

      <!-- Mascotas -->
      <div class="card">
        <h2>Mascotas</h2>
        <div class="item-list" id="petsList"></div>
        <div style="text-align:center;">
          <button class="btn" onclick="openModal('petModal')">Agregar / Editar Mascota</button>
        </div>
      </div>

      <!-- Fórmulas Avanzadas -->
      <div class="card" style="text-align:center;">
        <h2>Fórmulas Avanzadas</h2>
        <button class="btn" onclick="openModal('formulasModal')">Mostrar Fórmulas Avanzadas</button>
      </div>

      <!-- Gestión de Datos -->
      <div class="card" style="text-align:center;">
        <h2>Gestión de Datos</h2>
        <button class="btn" onclick="exportarPersonaje()">Descargar Personaje</button>
        <button class="btn" onclick="document.getElementById('importFile').click()">Cargar Personaje</button>
        <input type="file" id="importFile" style="display:none;" accept=".txt" onchange="importarPersonaje(event)">
      </div>
    </div>
  </div>

  <!-- Modal Genérico -->
  <div id="modalOverlay" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal()">×</span>
      <div id="modalBody"></div>
      <button class="btn" id="modalSaveBtn">Guardar</button>
    </div>
  </div>

  <!-- Agregar después del modal genérico -->
  <div id="adminModal" class="admin-modal">
    <div class="admin-modal-content">
        <span class="admin-modal-close" onclick="closeAdminPanel()">&times;</span>
        <div id="adminPanelContent"></div>
    </div>
  </div>

  <!-- Agregar antes del cierre del body -->
  <div class="popup-overlay" id="popupOverlay"></div>
  <div class="custom-popup" id="customPopup">
      <div class="popup-title"></div>
      <div class="popup-content"></div>
      <div class="popup-buttons">
          <button class="btn" id="popupConfirmBtn">Aceptar</button>
          <button class="btn" id="popupCancelBtn" style="display:none;">Cancelar</button>
      </div>
  </div>

  <script>
    // Comentar o eliminar estos event listeners duplicados
    /*
    document.addEventListener('DOMContentLoaded', function() {
        // ... código existente ...
    });
    */

    // Inicialización de datos
    
    const expTable = [
    {level: 1, exp: 0},
    {level: 2, exp: 300},
    {level: 3, exp: 900},
    {level: 4, exp: 2700},
    {level: 5, exp: 6500},
    {level: 6, exp: 14000},
    {level: 7, exp: 23000},
    {level: 8, exp: 34000},
    {level: 9, exp: 48000},
    {level: 10, exp: 64000},
    {level: 11, exp: 85000},
    {level: 12, exp: 100000},
    {level: 13, exp: 120000},
    {level: 14, exp: 140000},
    {level: 15, exp: 165000},
    {level: 16, exp: 195000},
    {level: 17, exp: 225000},
    {level: 18, exp: 265000},
    {level: 19, exp: 305000},
    {level: 20, exp: 355000}
];

    const character = {
        name: '',
        race: '',
        languages: '',
        personality: '',
        image: null,
        baseHealth: 25,        // Changed from 10 to 25
        currentHealth: 25,     // Also update current health
        maxHealth: 25,         // Also update max health
        baseArmor: 10,
        armor: 10,
        baseMistyculas: 100,   // Changed from 10 to 100
        currentMistyculas: 100, // Also update current mistyculas
        maxMistyculas: 100,    // Also update max mistyculas
        experience: 0,
        level: 1,
        attributes: {
            fuerza: 10,
            inteligencia: 10,
            agilidad: 10,
            metabolismo: 10,
            am: 10
        },
        actions: {
            action: 3
        },
        skills: [],
        spells: [],
        pets: [],
        items: []
    };

    function sanitizeFormula(formula) {
        // Permitir caracteres seguros: números, operadores básicos, paréntesis, 'd' o 'D', y palabras para variables
        const safePattern = /^[\d\s+\-*/()dD\w\s]+$/;
        
        // Limpiar espacios extras y normalizar
        const cleanFormula = formula.trim().replace(/\s+/g, ' ');
        
        if (!safePattern.test(cleanFormula)) {
            throw new Error('La fórmula contiene caracteres no permitidos');
        }
        
        // Verificar paréntesis balanceados
        let parentheses = 0;
        for (let char of cleanFormula) {
            if (char === '(') parentheses++;
            if (char === ')') parentheses--;
            if (parentheses < 0) throw new Error('Paréntesis desbalanceados');
        }
        if (parentheses !== 0) throw new Error('Paréntesis desbalanceados');
        
        return cleanFormula;
    }

    function resolverFormula(formula) {
        try {
            // Validate formula complexity
            if (formula.length > 200) {
                throw new Error('Fórmula demasiado compleja');
            }

            // Check for invalid patterns
            const invalidPatterns = [
                /\{\}/g, /\[\]/g, /eval/g, /function/g, 
                /window/g, /document/g, /\$/g, /\\/g
            ];
            
            if (invalidPatterns.some(pattern => pattern.test(formula))) {
                throw new Error('Fórmula contiene patrones no permitidos');
            }

            // Add timeout for formula resolution
            const timeoutMs = 1000;
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => reject(new Error('Tiempo de cálculo excedido')), timeoutMs);
            });

            // Cache de valores y sus modificadores
            const cache = {
                attributes: {
                    fuerza: character.attributes.fuerza,
                    inteligencia: character.attributes.inteligencia,
                    agilidad: character.attributes.agilidad,
                    metabolismo: character.attributes.metabolismo,
                    am: character.attributes.am
                },
                modifiers: {},
                stats: {
                    mistyculas: character.currentMistyculas,
                    armor: character.armor,
                    vidabase: character.baseHealth,
                    vidaactual: character.currentHealth,
                    nivel: character.level
                }
            };

            // Precalcular todos los modificadores
            Object.entries(cache.attributes).forEach(([attr, value]) => {
                cache.modifiers[attr] = calcularMod(value);
            });

            // Normalizar fórmula
            let resolvedFormula = formula.toLowerCase()
                .replace(/\s+/g, ' ')
                .trim();

            // Expresiones regulares optimizadas para patrones comunes
            const patterns = {
                modAttr: /mod\s+(\w+)/g,
                attrD: /(\w+)\s*d\s*(\w+)/g,
                modD: /mod\s+(\w+)\s*d\s*(\w+)/g,
                diceRoll: /(\d+|[\w.]+)\s*d\s*(\d+|[\w.]+)/g
            };

            // Resolver expresiones mod atributo
            resolvedFormula = resolvedFormula.replace(patterns.modAttr, (match, attr) => {
                return cache.modifiers[attr] || match;
            });

            // Resolver expresiones atributo d atributo
            resolvedFormula = resolvedFormula.replace(patterns.attrD, (match, attr1, attr2) => {
                const val1 = cache.attributes[attr1] || cache.stats[attr1];
                const val2 = cache.attributes[attr2] || cache.stats[attr2];
                if (typeof val1 === 'number' && typeof val2 === 'number') {
                    let total = 0;
                    for (let i = 0; i < val1; i++) {
                        total += Math.floor(Math.random() * val2) + 1;
                    }
                    return total;
                }
                return match;
            });

            // Resolver expresiones mod atributo d valor
            resolvedFormula = resolvedFormula.replace(patterns.modD, (match, attr, sides) => {
                const numDice = cache.modifiers[attr];
                const numSides = parseInt(sides) || cache.attributes[sides] || cache.stats[sides];
                if (typeof numDice === 'number' && typeof numSides === 'number') {
                    let total = 0;
                    for (let i = 0; i < numDice; i++) {
                        total += Math.floor(Math.random() * numSides) + 1;
                    }
                    return total;
                }
                return match;
            });

            // Reemplazar valores de atributos y stats
            Object.entries(cache.attributes).forEach(([key, value]) => {
                resolvedFormula = resolvedFormula.replace(new RegExp(key, 'g'), value);
            });
            Object.entries(cache.stats).forEach(([key, value]) => {
                resolvedFormula = resolvedFormula.replace(new RegExp(key, 'g'), value);
            });

            // Resolver tiradas de dados finales
            resolvedFormula = resolvedFormula.replace(patterns.diceRoll, (match, count, sides) => {
                const numDice = parseInt(count) || 1;
                const numSides = parseInt(sides) || 6;
                let total = 0;
                for (let i = 0; i < numDice; i++) {
                    total += Math.floor(Math.random() * numSides) + 1;
                }
                return total;
            });

            // Evaluar expresión final usando Function constructor
            const resultado = Function('"use strict";return (' + resolvedFormula + ')')();
            return Math.floor(resultado);

        } catch (e) {
            console.error('Error en fórmula:', formula, e);
            throw new Error(`Error al resolver la fórmula: ${e.message}`);
        }
    }

    // Modificar la función usarItem
    async function usarItem(listId, id) {
        try {
            if(listId === "skillsList") {
                const skill = character.skills.find(s => s.id === id);
                if(!skill) throw new Error('Habilidad no encontrada');
                
                if(character.currentMistyculas < skill.mistyCost) { 
                    await PopupManager.alert("No tienes suficientes místyculas."); 
                    return; 
                }
                if(character.actions.action < skill.actionCost) { 
                    await PopupManager.alert("No tienes suficientes acciones."); 
                    return; 
                }

                const safeFormula = sanitizeFormula(skill.formula);
                const resultado = resolverFormula(safeFormula);

                character.currentMistyculas -= skill.mistyCost;
                character.actions.action -= skill.actionCost;
                
                actualizarMistyculas();
                actualizarAcciones();
                saveCharacter();

                await PopupManager.alert(
                    `Habilidad: ${skill.name}\nResultado: ${resultado}\nCosto Místyculas: ${skill.mistyCost}\nCosto Acciones: ${skill.actionCost}`,
                    "Resultado de Habilidad"
                );
                
                return resultado;
            } else if(listId === "spellsList") {
                const spell = character.spells.find(s => s.id === id);
                if(!spell) throw new Error('Hechizo no encontrado');
                
                if(character.currentMistyculas < spell.mistyCost) { 
                    await PopupManager.alert("No tienes suficientes místyculas."); 
                    return; 
                }
                if(character.actions.action < spell.actionCost) { 
                    await PopupManager.alert("No tienes suficientes acciones."); 
                    return; 
                }

                const safeFormula = sanitizeFormula(spell.formula);
                const resultado = resolverFormula(safeFormula);

                character.currentMistyculas -= spell.mistyCost;
                character.actions.action -= spell.actionCost;
                
                actualizarMistyculas();
                actualizarAcciones();
                saveCharacter();

                await PopupManager.alert(
                    `Hechizo: ${spell.name}\nResultado: ${resultado}\nCosto Místyculas: ${spell.mistyCost}\nCosto Acciones: ${spell.actionCost}`,
                    "Resultado de Hechizo"
                );
                
                return resultado;
            }
        } catch (e) {
            await PopupManager.alert(e.message, "Error");
            console.error(e);
            return null;
        }
    }

    // Función para guardar datos
    function saveCharacter() {
        try {
            localStorage.setItem('character', JSON.stringify(character));
        } catch (error) {
            console.error('Error saving character:', error);
        }
    }

    // Función para cargar datos
    function loadCharacter() {
        try {
            const savedCharacter = localStorage.getItem('character');
            if (savedCharacter) {
                Object.assign(character, JSON.parse(savedCharacter));
                actualizarTodo();
            }
        } catch (error) {
            console.error('Error loading character:', error);
        }
    }

    // Reemplazar todo el event listener de DOMContentLoaded con esto:

    document.addEventListener('DOMContentLoaded', function() {
        // Mostrar directamente la página principal
        document.getElementById("mainPage").style.display = "block";
        
        // Cargar datos del personaje
        loadCharacter();
        
        // Inicializar listas
        renderList('skillsList', character.skills);
        renderList('spellsList', character.spells);
        renderList('petsList', character.pets);
        renderList('itemsList', character.items);
        
        // Actualizar toda la interfaz
        actualizarTodo();

        // Add after element table creation
        document.querySelectorAll('.elements-table td').forEach(td => {
            td.addEventListener('click', function(e) {
                if (e.target.tagName !== 'INPUT') {
                    this.classList.toggle('affinity');
                    saveCharacter();
                }
            });
        });
    });

    // Eliminar o comentar estas funciones que ya no se usarán:
    // - login()
    // - logout()
    // - showMain()
    // - todas las funciones relacionadas con admin

    // Admin function to simulate user creation (dummy function)
    function crearUsuario() {
      let newUser = prompt("Ingrese el nombre del nuevo usuario:");
      if(newUser) { alert("Usuario '" + newUser + "' creado (simulación)."); }
    }

    // Character sheet functions
    function calcularMod(valor) { return Math.floor((valor - 10) / 2); }
    function actualizarAtributos() {
      document.getElementById("modFuerza").textContent = calcularMod(character.attributes.fuerza);
      document.getElementById("modInt").textContent = calcularMod(character.attributes.inteligencia);
      document.getElementById("modAgil").textContent = calcularMod(character.attributes.agilidad);
      document.getElementById("modMetab").textContent = calcularMod(character.attributes.metabolismo);
      document.getElementById("modAM").textContent = calcularMod(character.attributes.am);
    }
    function actualizarNivelXP() {
      let lvl = 1, baseXP = 0;
      for(let i = 0; i < expTable.length; i++){
        if(character.experience >= expTable[i].exp){
          lvl = expTable[i].level;
          baseXP = expTable[i].exp;
        } else break;
      }
      character.level = lvl;
      const next = expTable.find(e => e.level === lvl + 1);
      const xpExcess = character.experience - baseXP;
      const xpNeeded = next ? next.exp - baseXP : 0;
      document.getElementById("calcXP").textContent = xpExcess + " / " + xpNeeded;
      document.getElementById("calcNivel").textContent = character.level + " / 20";
    }
    function actualizarVida() {
      const modMet = calcularMod(character.attributes.metabolismo);
      character.maxHealth = Math.floor(character.baseHealth * character.level * (modMet > 0 ? modMet : 1));
      if(character.currentHealth > character.maxHealth) character.currentHealth = character.maxHealth;
      document.getElementById("calcVida").textContent = character.currentHealth + " / " + character.maxHealth;
    }
    function actualizarArmor() {
      const modAgil = calcularMod(character.attributes.agilidad);
      const modMet = calcularMod(character.attributes.metabolismo);
      character.armor = character.baseArmor + modAgil + modMet;
      document.getElementById("calcArmor").textContent = character.armor;
    }
    function actualizarMistyculas() {
      const modInt = calcularMod(character.attributes.inteligencia);
      const modAM = calcularMod(character.attributes.am);
      character.maxMistyculas = character.baseMistyculas * (modInt > 0 ? modInt : 1) * (modAM > 0 ? modAM : 1);
      if(character.currentMistyculas > character.maxMistyculas) character.currentMistyculas = character.maxMistyculas;
      document.getElementById("calcMistyculas").textContent = character.currentMistyculas + " / " + character.maxMistyculas;
    }
    function actualizarAcciones() {
        const modAgil = calcularMod(character.attributes.agilidad);
        const maxAcciones = character.level + modAgil + 1;
        document.getElementById("currentAcciones").textContent = character.actions.action;
        document.getElementById("maxAcciones").textContent = maxAcciones;
        document.getElementById("accionesDisplay").style.color = 
            character.actions.action <= 0 ? "red" : "inherit";
    }
    function resetAcciones() {
        const modAgil = calcularMod(character.attributes.agilidad);
        character.actions.action = character.level + modAgil + 1;
        actualizarAcciones();
        saveCharacter();
    }
    function actualizarTodo() {
      actualizarAtributos();
      actualizarNivelXP();
      actualizarVida();
      actualizarArmor();
      actualizarMistyculas();
      actualizarAcciones();
    }
    function agregarXP() {
    const input = document.getElementById("inputXP");
    const xp = parseInt(input.value);
    
    if(isNaN(xp) || xp < 0) {
        alert("Por favor ingrese una cantidad válida de XP");
        return;
    }
    
    character.experience += xp;
    input.value = "0"; // Resetear el input después de agregar
    actualizarTodo();
    saveCharacter(); // Guardar los cambios
    
    // Mostrar un mensaje con el nuevo nivel si hubo cambio
    const nuevoNivel = Math.min(20, character.level);
    if(nuevoNivel > character.level) {
        alert(`¡Has subido al nivel ${nuevoNivel}!`);
    }
}
    function aplicarDaño() {
      const dmg = parseInt(document.getElementById("inputDamage").value);
      if(isNaN(dmg) || dmg < 0) return;
      character.currentHealth -= dmg;
      if(character.currentHealth < 0) character.currentHealth = 0;
      actualizarVida();
    }
    function aplicarCura() {
      const cura = parseInt(document.getElementById("inputHeal").value);
      if(isNaN(cura) || cura < 0) return;
      character.currentHealth += cura;
      if(character.currentHealth > character.maxHealth) character.currentHealth = character.maxHealth;
      actualizarVida();
    }
    function regenerarMisty() {
      const regen = parseInt(document.getElementById("inputMistyRegen").value);
      if(isNaN(regen) || regen < 0) return;
      character.currentMistyculas += regen;
      if(character.currentMistyculas > character.maxMistyculas) character.currentMistyculas = character.maxMistyculas;
      actualizarMistyculas();
    }
    // Eventos para atributos
    document.getElementById("attrFuerza").addEventListener("change", () => {
      character.attributes.fuerza = parseInt(document.getElementById("attrFuerza").value);
      actualizarTodo();
    });
    document.getElementById("attrInt").addEventListener("change", () => {
      character.attributes.inteligencia = parseInt(document.getElementById("attrInt").value);
      actualizarTodo();
    });
    document.getElementById("attrAgil").addEventListener("change", () => {
      character.attributes.agilidad = parseInt(document.getElementById("attrAgil").value);
      actualizarTodo();
    });
    document.getElementById("attrMetab").addEventListener("change", () => {
      character.attributes.metabolismo = parseInt(document.getElementById("attrMetab").value);
      actualizarTodo();
    });
    document.getElementById("attrAM").addEventListener("change", () => {
      character.attributes.am = parseInt(document.getElementById("attrAM").value);
      actualizarTodo();
    });
    // Datos del personaje
    document.getElementById("charName").addEventListener("change", function() { character.name = this.value; });
    document.getElementById("charRace").addEventListener("change", function() { character.race = this.value; });
    document.getElementById("charLang").addEventListener("change", function() { character.languages = this.value; });
    document.getElementById("charPerso").addEventListener("change", function() { character.personality = this.value; });
    // Imagen
    document.getElementById("imgContainer").addEventListener("click", function() {
      document.getElementById("imgUpload").click();
    });
    document.getElementById("imgUpload").addEventListener("change", function(e) {
      try {
          const file = e.target.files[0];
          if(!file) return;
          
          validateImage(file);
          
          const reader = new FileReader();
          reader.onload = function(ev) {
              character.image = ev.target.result;
              document.getElementById("imgContainer").innerHTML = 
                  `<img src="${character.image}" style="width:100%; height:100%; object-fit:cover;">`;
              saveCharacter();
          }
          reader.readAsDataURL(file);
      } catch (e) {
          alert('Error al cargar imagen: ' + e.message);
      }
    });

    /* Funciones para aplicar costos de acción */
    function aplicarAccionCompleja() {
        if(character.actions.action < 2){ 
            alert("No tienes suficientes acciones."); 
            return; 
        }
        character.actions.action -= 2;
        actualizarAcciones();
        saveCharacter();
    }
    function aplicarAccionMenor() {
        if(character.actions.action < 1){ 
            alert("No tienes suficientes acciones."); 
            return; 
        }
        character.actions.action -= 1;
        actualizarAcciones();
        saveCharacter();
    }
    function aplicarReaccion() {
        if(character.actions.action < 3){ 
            alert("No tienes suficientes acciones."); 
            return; 
        }
        character.actions.action -= 3;
        actualizarAcciones();
        saveCharacter();
    }
    function aplicarAccionObjeto() {
        if(character.actions.action < 1){ 
            alert("No tienes suficientes acciones."); 
            return; 
        }
        character.actions.action -= 1;
        actualizarAcciones();
        saveCharacter();
    }
    function aplicarAccionBonus() {
        character.actions.action += 1;
        actualizarAcciones();
        saveCharacter();
    }
    function aplicarAccionLegendaria() {
        let cost = parseInt(prompt("Ingrese el costo para la acción legendaria (entre 10 y 20):"));
        if(isNaN(cost) || cost < 10 || cost > 20){ 
            alert("Costo inválido."); 
            return; 
        }
        if(character.actions.action < cost){ 
            alert("No tienes suficientes acciones."); 
            return; 
        }
        character.actions.action -= cost;
        actualizarAcciones();
        saveCharacter();
    }

    /* Modal Genérico */
    const modalOverlay = document.getElementById("modalOverlay");
    const modalBody = document.getElementById("modalBody");
    const modalSaveBtn = document.getElementById("modalSaveBtn");
    let modalCallback = null;
    function openModal(modalId, itemId = null) {
        const modalOverlay = document.getElementById("modalOverlay");
        modalOverlay.style.display = "flex";
        modalOverlay.style.alignItems = "center";
        modalOverlay.style.justifyContent = "center";
        
        if(modalId === 'skillModal'){
        let skill = itemId ? character.skills.find(s => s.id === itemId) : null;
        modalBody.innerHTML = `
          <h3>${ skill ? "Editar" : "Crear" } Habilidad</h3>
          <label>Nombre:</label>
          <input type="text" id="modalSkillName" placeholder="Nombre" value="${ skill ? skill.name : "" }">
          <label>Descripción:</label>
          <textarea id="modalSkillDesc" placeholder="Descripción">${ skill ? skill.desc : "" }</textarea>
          <label>Fórmula:</label>
          <input type="text" id="modalSkillFormula" placeholder="Ej: Fuerza d InteligenciaMod+2" value="${ skill ? skill.formula : "" }">
          <div class="formula-buttons">
            <div class="formula-btn" onclick="insertFormula('Fuerza', 'modalSkillFormula')">Fuerza</div>
            <div class="formula-btn" onclick="insertFormula('Inteligencia', 'modalSkillFormula')">Inteligencia</div>
            <div class="formula-btn" onclick="insertFormula('Agilidad', 'modalSkillFormula')">Agilidad</div>
            <div class="formula-btn" onclick="insertFormula('Metabolismo', 'modalSkillFormula')">Metabolismo</div>
            <div class="formula-btn" onclick="insertFormula('A.M', 'modalSkillFormula')">A.M</div>
            <div class="formula-btn" onclick="insertFormula('FuerzaMod', 'modalSkillFormula')">FuerzaMod</div>
            <div class="formula-btn" onclick="insertFormula('InteligenciaMod', 'modalSkillFormula')">InteligenciaMod</div>
            <div class="formula-btn" onclick="insertFormula('AgilidadMod', 'modalSkillFormula')">AgilidadMod</div>
            <div class="formula-btn" onclick="insertFormula('MetabolismoMod', 'modalSkillFormula')">MetabolismoMod</div>
            <div class="formula-btn" onclick="insertFormula('AMMod', 'modalSkillFormula')">AMMod</div>
            <div class="formula-btn" onclick="insertFormula('Mistyculas', 'modalSkillFormula')">Mistyculas</div>
            <div class="formula-btn" onclick="insertFormula('Armadura', 'modalSkillFormula')">Armadura</div>
            <div class="formula-btn" onclick="insertFormula('VidaBase', 'modalSkillFormula')">VidaBase</div>
            <div class="formula-btn" onclick="insertFormula('VidaActual', 'modalSkillFormula')">VidaActual</div>
            <div class="formula-btn" onclick="insertFormula(' d ', 'modalSkillFormula')">d</div>
            <div class="formula-btn" onclick="insertFormula('+', 'modalSkillFormula')">+</div>
            <div class="formula-btn" onclick="insertFormula('-', 'modalSkillFormula')">-</div>
            <div class="formula-btn" onclick="insertFormula('*', 'modalSkillFormula')">*</div>
            <div class="formula-btn" onclick="insertFormula('/', 'modalSkillFormula')">/</div>
            <div class="formula-btn" onclick="insertFormula('(', 'modalSkillFormula')">(</div>
            <div class="formula-btn" onclick="insertFormula(')', 'modalSkillFormula')">)</div>
          </div>
          <label>Costo de Acción:</label>
          <input type="number" id="modalSkillActionCost" value="${ skill ? skill.actionCost : 1 }" min="0">
          <label>Costo de Místyculas:</label>
          <input type="number" id="modalSkillMistyCost" value="${ skill ? skill.mistyCost : 0 }" min="0">
        `;
        const raritySelect = `
          <label>Rareza:</label>
          <select id="modalSkillRarity" class="rarity-select">
            <option value="intrinceca">Intrínseca</option>
            <option value="comun">Común</option>
            <option value="epica">Épica</option>
            <option value="legendaria">Legendaria</option>
            <option value="mitica">Mítica</option>
            <option value="genesis">Génesis</option>
          </select>
        `;
        modalBody.innerHTML += raritySelect;
        modalCallback = function() {
          const newSkill = {
            id: skill ? skill.id : Date.now().toString(),
            name: document.getElementById("modalSkillName").value,
            desc: document.getElementById("modalSkillDesc").value,
            formula: document.getElementById("modalSkillFormula").value,
            actionCost: parseInt(document.getElementById("modalSkillActionCost").value),
            mistyCost: parseInt(document.getElementById("modalSkillMistyCost").value),
            rarity: document.getElementById("modalSkillRarity").value
          };
          if(skill){
            const index = character.skills.findIndex(s => s.id === skill.id);
            character.skills[index] = newSkill;
          } else {
            character.skills.push(newSkill);
          }
          renderList('skillsList', character.skills);
        };
      }
      else if(modalId === 'spellModal'){
        let spell = itemId ? character.spells.find(s => s.id === itemId) : null;
        modalBody.innerHTML = `
          <h3>${ spell ? "Editar" : "Crear" } Hechizo</h3>
          <label>Nombre:</label>
          <input type="text" id="modalSpellName" placeholder="Nombre" value="${ spell ? spell.name : "" }">
          <label>Descripción:</label>
          <textarea id="modalSpellDesc" placeholder="Descripción">${ spell ? spell.desc : "" }</textarea>
          <label>Fórmula:</label>
          <input type="text" id="modalSpellFormula" placeholder="Ej: 1d10+Inteligencia" value="${ spell ? spell.formula : "" }">
          <div class="formula-buttons">
            <div class="formula-btn" onclick="insertFormula('Fuerza', 'modalSpellFormula')">Fuerza</div>
            <div class="formula-btn" onclick="insertFormula('Inteligencia', 'modalSpellFormula')">Inteligencia</div>
            <div class="formula-btn" onclick="insertFormula('Agilidad', 'modalSpellFormula')">Agilidad</div>
            <div class="formula-btn" onclick="insertFormula('Metabolismo', 'modalSpellFormula')">Metabolismo</div>
            <div class="formula-btn" onclick="insertFormula('A.M', 'modalSpellFormula')">A.M</div>
            <div class="formula-btn" onclick="insertFormula('FuerzaMod', 'modalSpellFormula')">FuerzaMod</div>
            <div class="formula-btn" onclick="insertFormula('InteligenciaMod', 'modalSpellFormula')">InteligenciaMod</div>
            <div class="formula-btn" onclick="insertFormula('AgilidadMod', 'modalSpellFormula')">AgilidadMod</div>
            <div class="formula-btn" onclick="insertFormula('MetabolismoMod', 'modalSpellFormula')">MetabolismoMod</div>
            <div class="formula-btn" onclick="insertFormula('AMMod', 'modalSpellFormula')">AMMod</div>
            <div class="formula-btn" onclick="insertFormula('Mistyculas', 'modalSpellFormula')">Mistyculas</div>
            <div class="formula-btn" onclick="insertFormula('Armadura', 'modalSpellFormula')">Armadura</div>
            <div class="formula-btn" onclick="insertFormula('VidaBase', 'modalSpellFormula')">VidaBase</div>
            <div class="formula-btn" onclick="insertFormula('VidaActual', 'modalSpellFormula')">VidaActual</div>
            <div class="formula-btn" onclick="insertFormula(' d ', 'modalSpellFormula')">d</div>
            <div class="formula-btn" onclick="insertFormula('+', 'modalSpellFormula')">+</div>
            <div class="formula-btn" onclick="insertFormula('-', 'modalSpellFormula')">-</div>
            <div class="formula-btn" onclick="insertFormula('*', 'modalSpellFormula')">*</div>
            <div class="formula-btn" onclick="insertFormula('/', 'modalSpellFormula')">/</div>
            <div class="formula-btn" onclick="insertFormula('(', 'modalSpellFormula')">(</div>
            <div class="formula-btn" onclick="insertFormula(')', 'modalSpellFormula')">)</div>
          </div>
          <label>Costo de Acción:</label>
          <input type="number" id="modalSpellActionCost" value="${ spell ? spell.actionCost : 1 }" min="0">
          <label>Costo de Místyculas:</label>
          <input type="number" id="modalSpellMistyCost" value="${ spell ? spell.mistyCost : 0 }" min="0">
        `;
        const raritySelect = `
          <label>Rareza:</label>
          <select id="modalSpellRarity" class="rarity-select">
            <option value="intrinceca">Intrínseca</option>
            <option value="comun">Común</option>
            <option value="epica">Épica</option>
            <option value="legendaria">Legendaria</option>
            <option value="mitica">Mítica</option>
            <option value="genesis">Génesis</option>
          </select>
        `;
        modalBody.innerHTML += raritySelect;
        modalCallback = function() {
          const newSpell = {
            id: spell ? spell.id : Date.now().toString(),
            name: document.getElementById("modalSpellName").value,
            desc: document.getElementById("modalSpellDesc").value,
            formula: document.getElementById("modalSpellFormula").value,
            actionCost: parseInt(document.getElementById("modalSpellActionCost").value),
            mistyCost: parseInt(document.getElementById("modalSpellMistyCost").value),
            rarity: document.getElementById("modalSpellRarity").value
          };
          if(spell){
            const index = character.spells.findIndex(s => s.id === spell.id);
            character.spells[index] = newSpell;
          } else {
            character.spells.push(newSpell);
          }
          renderList('spellsList', character.spells);
        };
      }
      else if(modalId === 'petModal'){
        let pet = itemId ? character.pets.find(p => p.id === itemId) : null;
        modalBody.innerHTML = `
          <h3>${ pet ? "Editar" : "Crear" } Mascota</h3>
          <label>Nombre:</label>
          <input type="text" id="modalPetName" placeholder="Nombre" value="${ pet ? pet.name : "" }">
          <label>Tipo:</label>
          <input type="text" id="modalPetType" placeholder="Tipo" value="${ pet ? pet.type : "" }">
          <label>Imagen:</label>
          <input type="file" id="modalPetImage">
        `;
        modalCallback = function() {
          let newPet = {
            id: pet ? pet.id : Date.now().toString(),
            name: document.getElementById("modalPetName").value,
            type: document.getElementById("modalPetType").value,
            image: pet ? pet.image : null
          };
          const file = document.getElementById("modalPetImage").files[0];
          if(file){
            const reader = new FileReader();
            reader.onload = function(ev){
              newPet.image = ev.target.result;
              if(pet){
                const index = character.pets.findIndex(p => p.id === pet.id);
                character.pets[index] = newPet;
              } else {
                character.pets.push(newPet);
              }
              renderList('petsList', character.pets);
            }
            reader.readAsDataURL(file);
          } else {
            if(pet){
              const index = character.pets.findIndex(p => p.id === pet.id);
              character.pets[index] = newPet;
            } else {
              character.pets.push(newPet);
            }
            renderList('petsList', character.pets);
          }
        };
      }
      else if(modalId === 'itemModal'){
        let itemObj = itemId ? character.items.find(i => i.id === itemId) : null;
        modalBody.innerHTML = `
          <h3>${ itemObj ? "Editar" : "Crear" } Objeto</h3>
          <label>Nombre:</label>
          <input type="text" id="modalItemName" placeholder="Nombre" value="${ itemObj ? itemObj.name : "" }">
          <label>Tipo:</label>
          <input type="text" id="modalItemType" placeholder="Tipo" value="${ itemObj ? itemObj.type : "" }">
          <label>Efectos:</label>
          <textarea id="modalItemEffects" placeholder="Efectos">${ itemObj ? itemObj.effects : "" }</textarea>
        `;
        modalCallback = function() {
          const newItem = {
            id: itemObj ? itemObj.id : Date.now().toString(),
            name: document.getElementById("modalItemName").value,
            type: document.getElementById("modalItemType").value,
            effects: document.getElementById("modalItemEffects").value
          };
          if(itemObj){
            const index = character.items.findIndex(i => i.id === itemObj.id);
            character.items[index] = newItem;
          } else {
            character.items.push(newItem);
          }
          renderList('itemsList', character.items);
        };
      }
      else if(modalId === 'formulasModal'){
        const modFuerza = calcularMod(character.attributes.fuerza);
        const modInt = calcularMod(character.attributes.inteligencia);
        const modAgil = calcularMod(character.attributes.agilidad);
        const modMetab = calcularMod(character.attributes.metabolismo);
        const modAM = calcularMod(character.attributes.am);
        const movimiento = (modFuerza + modAgil) * 10;
        const carga = (modMetab + modFuerza) * 10;
        const acciones = character.level + modAgil + 1;
        const resistencia = character.level + modMetab;
        const tamano = modMetab * 10;
        const altura = tamano * 10;
        const peso = tamano * 5;
        const vida = character.baseHealth * character.level * (modMetab > 0 ? modMetab : 1);
        const sabiduria = modInt + character.level;
        const misty = character.baseMistyculas * (modInt > 0 ? modInt : 1) * (modAM > 0 ? modAM : 1);
        const regenMisty = character.level + character.attributes.inteligencia + character.attributes.am;
        const regenVida = character.level + character.attributes.metabolismo + character.attributes.am;
        modalBody.innerHTML = `
          <h3>Fórmulas Avanzadas</h3>
          <p><strong>Daño Cuerpo a Cuerpo:</strong> Arma + Fuerza</p>
          <p><strong>Movimiento:</strong> (Fuerza mod + Agilidad mod) × 10 = ${movimiento} pies</p>
          <p><strong>Carga:</strong> (Metabolismo mod + Fuerza mod) × 10 = ${carga} libras</p>
          <p><strong>Armadura:</strong> 10 + (Agilidad mod + Metabolismo mod) = ${character.baseArmor + modAgil + modMetab}</p>
          <p><strong>Acciones:</strong> Nivel + Agilidad mod + 1 = ${acciones}</p>
          <p><strong>Resistencia a Efectos:</strong> Nivel + Metabolismo mod = ${resistencia}</p>
          <p><strong>Tamaño:</strong> Metabolismo mod × 10 = ${tamano} | Altura = ${altura} cm | Peso = ${peso} kg</p>
          <p><strong>Vida:</strong> Vida Base × (Metabolismo mod > 0 ? Metabolismo mod : 1) × Nivel = ${vida}</p>
          <p><strong>Sabiduría:</strong> Inteligencia mod + Nivel = ${sabiduria}</p>
          <p><strong>Mistyculas:</strong> Mistyculas Base × (Inteligencia mod > 0 ? Inteligencia mod : 1) × (A.M mod > 0 ? A.M mod : 1) = ${misty}</p>
          <p><strong>Regeneración de Místyculas:</strong> Nivel + Inteligencia + A.M = ${regenMisty}</p>
          <p><strong>Regeneración de Vida:</strong> Nivel + Metabolismo + A.M = ${regenVida}</p>
        `;
        modalCallback = null;
      }
      else if(modalId === 'editStatsModal'){
        modalBody.innerHTML = `
          <h3>Editar Estadísticas</h3>
          <label>Vida Base:</label>
          <input type="number" id="modalBaseHealth" value="${character.baseHealth}">
          <label>Vida Actual:</label>
          <input type="number" id="modalCurrentHealth" value="${character.currentHealth}">
          <label>XP Actual:</label>
          <input type="number" id="modalXP" value="${character.experience}">
          <label>Mistyculas Base:</label>
          <input type="number" id="modalBaseMisty" value="${character.baseMistyculas}">
          <label>Mistyculas Actuales:</label>
          <input type="number" id="modalCurrentMisty" value="${character.currentMistyculas}">
          <label>Armadura Base:</label>
          <input type="number" id="modalArmorBase" value="${character.baseArmor}">
        `;
        modalCallback = function() {
          character.baseHealth = parseInt(document.getElementById("modalBaseHealth").value);
          character.currentHealth = parseInt(document.getElementById("modalCurrentHealth").value);
          character.experience = parseInt(document.getElementById("modalXP").value);
          character.baseMistyculas = parseInt(document.getElementById("modalBaseMisty").value);
          character.currentMistyculas = parseInt(document.getElementById("modalCurrentMisty").value);
          character.baseArmor = parseInt(document.getElementById("modalArmorBase").value);
          actualizarTodo();
        };
      }
    }
    function closeModal() {
      modalOverlay.style.display = "none";
      modalBody.innerHTML = "";
      modalCallback = null;
    }
    modalSaveBtn.addEventListener("click", function() {
      if(modalCallback) modalCallback();
      closeModal();
    });
    function insertFormula(text, inputId) {
      const input = document.getElementById(inputId);
      input.value += text;
    }
    function renderList(elementId, list) {
        const container = document.getElementById(elementId);
        container.innerHTML = "";
        if(list.length === 0){ 
            container.innerHTML = "<p>No hay elementos.</p>"; 
            return; 
        }
        list.forEach(item => {
            const div = document.createElement("div");
            div.className = `item ${item.rarity || 'intrinceca'}`;
            let extra = "";
            if(item.formula) {
                extra = ` | Fórmula: ${item.formula}`;
                if(item.mistyCost) extra += ` | Costo Místyculas: ${item.mistyCost}`;
                if(item.actionCost) extra += ` | Costo Acciones: ${item.actionCost}`;
            }
            else if(item.type && !item.formula) {
                extra = ` (${item.type})`;
            }
            if(item.image) {
                extra += `<br><img src="${item.image}" alt="Mascota" style="max-width:100px; margin-top:5px;">`;
            }
            
            div.innerHTML = `
                <span>
                    <strong>${item.name}</strong>
                    ${item.desc ? ` - ${item.desc}` : ""}
                    ${extra}
                </span>
                <div class="item-buttons">
                    <button class="btn" onclick="editarItem('${elementId}', '${item.id}')">Editar</button>
                    <button class="btn" onclick="eliminarItem('${elementId}', '${item.id}')">Eliminar</button>
                    ${(elementId==='skillsList' || elementId==='spellsList')
                        ? `<button class="btn" onclick="usarItem('${elementId}', '${item.id}')">Usar</button>`
                        : ""
                    }
                </div>`;
            container.appendChild(div);
        });
    }
    async function eliminarItem(listId, id) {
        const itemTypes = {
            skillsList: "habilidad",
            spellsList: "hechizo",
            petsList: "mascota",
            itemsList: "objeto"
        };

        const itemType = itemTypes[listId];
        
        const confirmed = await PopupManager.confirm(
            `¿Estás seguro de que deseas eliminar este ${itemType}?\nEsta acción no se puede deshacer.`,
            "Confirmar Eliminación"
        );
        
        if (!confirmed) return;

        if(listId === "skillsList") {
            character.skills = character.skills.filter(s => s.id !== id);
            renderList(listId, character.skills);
        } else if(listId === "spellsList") {
            character.spells = character.spells.filter(s => s.id !== id);
            renderList(listId, character.spells);
        } else if(listId === "petsList") {
            character.pets = character.pets.filter(p => p.id !== id);
            renderList(listId, character.pets);
        } else if(listId === "itemsList") {
            character.items = character.items.filter(i => i.id !== id);
            renderList(listId, character.items);
        }
        saveCharacter();
    }
    function editarItem(listId, id) {
      if(listId === "skillsList"){ openModal('skillModal', id); }
      else if(listId === "spellsList"){ openModal('spellModal', id); }
      else if(listId === "petsList"){ openModal('petModal', id); }
      else if(listId === "itemsList"){ openModal('itemModal'); }
    }
    document.addEventListener('DOMContentLoaded', loadCharacter);
    actualizarTodo();

    function validateImage(file) {
        const maxSize = 5 * 1024 * 1024; // 5MB
        const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
        
        if (!validTypes.includes(file.type)) {
            throw new Error('Tipo de archivo no válido');
        }
        if (file.size > maxSize) {
            throw new Error('Imagen demasiado grande');
        }
        return true;
    }

    // Modificar el evento de carga de imagen
    document.getElementById("imgUpload").addEventListener("change", function(e) {
        try {
            const file = e.target.files[0];
            if(!file) return;
            
            validateImage(file);
            
            const reader = new FileReader();
            reader.onload = function(ev) {
                character.image = ev.target.result;
                document.getElementById("imgContainer").innerHTML = 
                    `<img src="${character.image}" style="width:100%; height:100%; object-fit:cover;">`;
                saveCharacter();
            }
            reader.readAsDataURL(file);
        } catch (e) {
            alert('Error al cargar imagen: ' + e.message);
        }
    });

    // Agregar estas funciones en la sección de script
    function exportarPersonaje() {
        try {
            // Crear objeto con los datos a exportar
            const datos = {
                character: character,
                version: "1.0", // Para futuras compatibilidades
                exportDate: new Date().toISOString()
            };

            // Convertir a string
            const contenido = JSON.stringify(datos, null, 2);

            // Crear blob y link de descarga
            const blob = new Blob([contenido], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            // Configurar nombre del archivo con fecha
            const fecha = new Date().toISOString().split('T')[0];
            a.download = `personaje_${character.name || 'sin_nombre'}_${fecha}.txt`;
            
            a.href = url;
            a.click();
            window.URL.revokeObjectURL(url);

            alert("Personaje exportado exitosamente");
        } catch (error) {
            alert("Error al exportar personaje: " + error.message);
            console.error(error);
        }
    }

    async function importarPersonaje(event) {
        try {
            const file = event.target.files[0];
            FileHandler.validateFile(file, 'import');
            ModalManager.showLoading();

            const content = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });

            const data = JSON.parse(content);
            if (!data.character) {
                throw new Error("Archivo de personaje inválido");
            }

            if (confirm("¿Estás seguro de que deseas cargar este personaje? Se sobreescribirán los datos actuales.")) {
                Object.assign(character, data.character);
                actualizarTodo();
                renderList('skillsList', character.skills);
                renderList('spellsList', character.spells);
                renderList('petsList', character.pets);
                renderList('itemsList', character.items);
                if (character.image) {
                    document.getElementById("imgContainer").innerHTML = 
                        `<img src="${character.image}" style="width:100%; height:100%; object-fit:cover;">`;
                }
                saveCharacter();
                alert("Personaje importado exitosamente");
            }
        } catch (error) {
            alert('Error importing character: ' + error.message);
        } finally {
            ModalManager.hideLoading();
            event.target.value = '';
        }
    }

    const FileHandler = {
        maxFileSize: 5 * 1024 * 1024, // 5MB
        allowedImageTypes: ['image/jpeg', 'image/png', 'image/gif'],
        allowedImportTypes: ['text/plain', 'application/json'],

        validateFile(file, type = 'image') {
            if (!file) throw new Error('No file selected');
            
            if (file.size > this.maxFileSize) {
                throw new Error(`File size exceeds ${this.maxFileSize / 1024 / 1024}MB limit`);
            }

            const allowedTypes = type === 'image' ? 
                this.allowedImageTypes : this.allowedImportTypes;

            if (!allowedTypes.includes(file.type)) {
                throw new Error('Invalid file type');
            }

            return true;
        }
    };

    // Add to your existing code
    const ModalManager = {
        activeModal: null,
        isLoading: false,

        showLoading() {
            this.isLoading = true;
            const modalContent = document.querySelector('.modal-content');
            if (modalContent) {
                modalContent.classList.add('loading');
                modalContent.innerHTML += '<div class="loading-spinner"></div>';
            }
        },

        hideLoading() {
            this.isLoading = false;
            const modalContent = document.querySelector('.modal-content');
            if (modalContent) {
                modalContent.classList.remove('loading');
                const spinner = modalContent.querySelector('.loading-spinner');
                if (spinner) spinner.remove();
            }
        },

        async open(modalId, itemId = null) {
            if (this.isLoading) return;
            
            this.activeModal = modalId;
            this.showLoading();
            
            try {
                await openModal(modalId, itemId);
            } catch (error) {
                console.error('Error opening modal:', error);
                alert('Error al abrir el modal: ' + error.message);
            } finally {
                this.hideLoading();
            }
        },

        close() {
            if (this.isLoading) return;
            this.activeModal = null;
            closeModal();
        }
    };

    const ImageOptimizer = {
        maxWidth: 800,
        maxHeight: 600,
        quality: 0.8,

        async optimize(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const reader = new FileReader();

                reader.onload = (e) => {
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > this.maxWidth) {
                            height *= this.maxWidth / width;
                            width = this.maxWidth;
                        }
                        if (height > this.maxHeight) {
                            width *= this.maxHeight / height;
                            height = this.maxHeight;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob(
                            (blob) => resolve(blob),
                            'image/jpeg',
                            this.quality
                        );
                    };
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
    };

    function nuevaRonda() {
        // Reset acciones
        resetAcciones();
        
        // Actualizar interfaz
        actualizarTodo();
        saveCharacter();
        
        alert('Nueva Ronda! Acciones reseteadas.');
    }

    function regenAutomatica() {
        const regenMisty = character.level + character.attributes.inteligencia + character.attributes.am;
        const regenVida = character.level + character.attributes.metabolismo + character.attributes.am;
        
        character.currentMistyculas = Math.min(character.maxMistyculas, character.currentMistyculas + regenMisty);
        character.currentHealth = Math.min(character.maxHealth, character.currentHealth + regenVida);
        
        actualizarTodo();
        saveCharacter();
        
        alert(`Regeneración aplicada:\nVida: +${regenVida}\nMístyculas: +${regenMisty}`);
    }

    // Agregar en la sección de script
    const PopupManager = {
        show(options = {}) {
            const {
                title = '',
                content = '',
                showCancel = false,
                confirmText = 'Aceptar',
                cancelText = 'Cancelar'
            } = options;

            return new Promise((resolve) => {
                const popup = document.getElementById('customPopup');
                const overlay = document.getElementById('popupOverlay');
                const confirmBtn = document.getElementById('popupConfirmBtn');
                const cancelBtn = document.getElementById('popupCancelBtn');

                popup.querySelector('.popup-title').textContent = title;
                popup.querySelector('.popup-content').textContent = content;
                confirmBtn.textContent = confirmText;
                cancelBtn.textContent = cancelText;

                cancelBtn.style.display = showCancel ? 'block' : 'none';

                const closePopup = (result) => {
                    popup.style.display = 'none';
                    overlay.style.display = 'none';
                    resolve(result);
                };

                confirmBtn.onclick = () => closePopup(true);
                cancelBtn.onclick = () => closePopup(false);
                
                popup.style.display = 'block';
                overlay.style.display = 'block';
            });
        },

        alert(content, title = 'Aviso') {
            return this.show({ title, content });
        },

        confirm(content, title = 'Confirmar') {
            return this.show({ title, content, showCancel: true });
        }
    };
  </script>
</body>
</html>