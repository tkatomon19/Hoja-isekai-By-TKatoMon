<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hoja de Personaje RPG - Login y Panel</title>
  <style>
    /* Global Styles */
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 20px;
      font-family: 'Segoe UI', sans-serif;
      background: #eef2f7;
      color: #333;
      line-height: 1.5;
    }
    .container { max-width: 1000px; margin: auto; padding-bottom: 40px; }
    h1, h2, h3 { text-align: center; margin-bottom: 15px; }
    /* Card Component */
    .card {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    /* Form Elements */
    label {
      font-weight: bold;
      margin-bottom: 5px;
      display: block;
      text-align: center;
    }
    input[type="text"],
    input[type="password"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      max-width: 300px;
      padding: 10px;
      margin: 0 auto 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      display: block;
    }
    /* Grid Layout */
    .grid { display: flex; flex-wrap: wrap; gap: 20px; justify-content: space-between; }
    .half { flex: 1 1 45%; min-width: 280px; }
    .full { width: 100%; }
    .stats-grid {
      display: flex; flex-wrap: wrap; justify-content: space-around; gap: 20px; margin-top: 15px;
    }
    .stat {
      background: #f7f9fc;
      border-radius: 8px;
      padding: 15px 20px;
      min-width: 180px;
      text-align: center;
      font-size: 1.1em;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    small { display: block; text-align: center; color: #777; }
    /* Buttons */
    .btn {
      background: #2196F3;
      color: #fff;
      border: none;
      padding: 10px 18px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
      font-size: 0.95em;
      transition: background 0.3s;
    }
    .btn:hover { background: #1976D2; }
    /* Item List */
    .item-list {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 15px;
      background: #f9f9f9;
      min-height: 80px;
    }
    .item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #eee;
      padding: 8px 0;
    }
    .item:last-child { border-bottom: none; }
    /* Combat Panel */
    .combat-panel {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 15px;
    }
    .combat-panel > div { flex: 1; min-width: 100px; }
    .combat-buttons { text-align: center; margin-top: 10px; }
    /* Login Form */
    .login-container {
      max-width: 400px;
      margin: 100px auto;
      background: #fff;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      text-align: center;
    }

    .login-container h2 {
      margin-bottom: 30px;
      color: #2196F3;
    }

    .login-container input {
      margin-bottom: 20px;
    }

    .login-container .btn {
      width: 200px;
      margin-top: 20px;
    }
    /* Admin Panel */
    .admin-panel { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 15px; text-align: center; }
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      align-items: center;
      justify-content: center;
      padding: 10px;
    }
    .modal-content {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      width: 100%;
      max-width: 400px;
      position: relative;
      max-height: 80vh;
      overflow-y: auto;
      text-align: center;
    }
    .modal-close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      cursor: pointer;
    }
    /* Fórmula Buttons */
    .formula-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 10px;
      justify-content: center;
    }
    .formula-btn {
      background: #ddd;
      padding: 4px 6px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8em;
    }
    /* Responsive */
    @media (max-width: 600px) {
      .grid { flex-direction: column; align-items: center; }
      .half { width: 100%; }
      .stats-grid { flex-direction: column; align-items: center; }
      .stat { width: 90%; margin-bottom: 10px; }
      .combat-panel { flex-direction: column; align-items: center; }
    }
    /* Admin Panel Styles */
    .admin-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      padding: 15px;
    }

    .admin-section {
      background: #f5f7fa;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .admin-section h3 {
      color: #2196F3;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 10px;
    }

    .admin-section .btn {
      width: 100%;
      margin: 5px 0;
      text-align: left;
      padding: 12px 15px;
    }

    .admin-stats {
      display: grid;
      gap: 10px;
      font-size: 1.1em;
    }

    .admin-stats div {
      padding: 12px;
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .admin-stats span {
      font-weight: bold;
      color: #2196F3;
    }

    /* Agregar en la sección de estilos */
    .xp-stat {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .xp-display {
      font-size: 0.9em;
      color: #666;
    }

    .xp-input {
      display: flex;
      align-items: center;
      gap: 5px;
      justify-content: center;
    }

    .xp-input input {
      width: 80px;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      text-align: center;
    }

    .btn-small {
      padding: 5px 10px;
      font-size: 0.9em;
      min-width: 30px;
    }

    /* Admin Panel Modal */
    .admin-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      align-items: center;
      justify-content: center;
    }

    .admin-modal-content {
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 1200px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }

    .admin-modal-close {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }

    .admin-modal-close:hover {
      color: #000;
    }
  </style>
</head>
<body>
  <!-- Login Section -->
  <div id="loginPage" class="login-container">
    <h2>Iniciar Sesión</h2>
    <input type="text" id="username" placeholder="Usuario">
    <input type="password" id="password" placeholder="Contraseña">
    <button class="btn" onclick="login()">Entrar</button>
    <p>¿No tienes cuenta? <a href="#" onclick="mostrarRegistro()">Regístrate</a></p>
  </div>

  <div id="registerPage" class="login-container" style="display:none;">
    <h2>Registro</h2>
    <input type="text" id="newUsername" placeholder="Usuario">
    <input type="password" id="newPassword" placeholder="Contraseña">
    <button class="btn" onclick="registrarUsuario()">Registrar</button>
    <p>¿Ya tienes cuenta? <a href="#" onclick="mostrarLogin()">Inicia sesión</a></p>
  </div>

  <!-- Main Content (Hidden by default) -->
  <div id="mainPage" style="display:none;">
    <div class="container">
      <!-- Admin Panel (Visible only to admin) -->
      <div id="adminPanel" class="card" style="display:none;">
        <h2>Panel de Admin</h2>
        <p>Permiso para crear usuarios:</p>
        <button class="btn" onclick="crearUsuario()">Crear Nuevo Usuario</button>
      </div>

      <!-- Datos del Personaje -->
      <div class="card">
        <h1>Hoja de Personaje RPG</h1>
        <div class="grid">
          <div class="half">
            <label for="charName">Nombre</label>
            <input type="text" id="charName" placeholder="Nombre del personaje">
            <label for="charRace">Raza</label>
            <input type="text" id="charRace" placeholder="Raza del personaje">
            <label for="charLang">Idiomas</label>
            <input type="text" id="charLang" placeholder="Ej: Español, Inglés">
            <label for="charPerso">Personalidad</label>
            <input type="text" id="charPerso" placeholder="Personalidad">
          </div>
          <div class="half">
            <label>Imagen</label>
            <div id="imgContainer" style="width:90%; height:220px; border:2px dashed #ccc; display:flex; align-items:center; justify-content:center; cursor:pointer; margin:auto;">
              <span>Click para cargar imagen</span>
            </div>
            <input type="file" id="imgUpload" style="display:none;">
          </div>
        </div>
      </div>

      <!-- Elementos -->
      <div class="card">
        <h2>Elementos</h2>
        <table>
          <thead>
            <tr>
              <th>Fuego</th>
              <th>Aire</th>
              <th>Agua</th>
              <th>Electricidad</th>
              <th>Tierra</th>
              <th>Luz</th>
              <th>Oscuridad</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><input type="number" id="elemFire" value="10" min="10" max="100"></td>
              <td><input type="number" id="elemAir" value="10" min="10" max="100"></td>
              <td><input type="number" id="elemWater" value="10" min="10" max="100"></td>
              <td><input type="number" id="elemElectricidad" value="10" min="10" max="100"></td>
              <td><input type="number" id="elemEarth" value="10" min="10" max="100"></td>
              <td><input type="number" id="elemLight" value="10" min="10" max="100"></td>
              <td><input type="number" id="elemDark" value="10" min="10" max="100"></td>
            </tr>
          </tbody>
        </table>
        <small>*1-30: Bajo | 31-70: Estándar | 71-100: Potenciado</small>
      </div>

      <!-- Atributos -->
      <div class="card">
        <h2>Atributos</h2>
        <table>
          <thead>
            <tr>
              <th>Fuerza</th>
              <th>Inteligencia</th>
              <th>Agilidad</th>
              <th>Metabolismo</th>
              <th>A.M</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>
                <input type="number" id="attrFuerza" value="10" min="10">
                <div id="modFuerza">0</div>
              </td>
              <td>
                <input type="number" id="attrInt" value="10" min="10">
                <div id="modInt">0</td>
              <td>
                <input type="number" id="attrAgil" value="10" min="10">
                <div id="modAgil">0</div>
              </td>
              <td>
                <input type="number" id="attrMetab" value="10" min="10">
                <div id="modMetab">0</div>
              </td>
              <td>
                <input type="number" id="attrAM" value="10" min="10">
                <div id="modAM">0</div>
              </td>
            </tr>
          </tbody>
        </table>
        <small>Modificador = (Valor - 10) / 2</small>
      </div>

      <!-- Estadísticas -->
      <div class="card">
        <h2>Estadísticas</h2>
        <div class="stats-grid">
          <div class="stat">Vida: <span id="calcVida">0 / 0</span></div>
          <div class="stat">Armadura: <span id="calcArmor">10</span></div>
          <div class="stat">Místyculas: <span id="calcMistyculas">0 / 0</span></div>
          <div class="stat xp-stat">
            <div>Nivel: <span id="calcNivel">1 / 20</span></div>
            <div class="xp-display">XP: <span id="calcXP">0 / 0</span></div>
            <div class="xp-input">
              <input type="number" id="inputXP" placeholder="Añadir XP" min="0">
              <button class="btn btn-small" onclick="agregarXP()">+</button>
            </div>
          </div>
        </div>
        <div style="text-align:center; margin-top:15px;">
          <button class="btn" onclick="resetAcciones()">Nueva Ronda</button>
          <button class="btn" onclick="openModal('editStatsModal')">Editar Estadísticas</button>
        </div>
      </div>

      <!-- Fórmulas Avanzadas -->
      <div class="card" style="text-align:center;">
        <button class="btn" onclick="openModal('formulasModal')">Mostrar Fórmulas Avanzadas</button>
      </div>

      <!-- Acciones & Combate -->
      <div class="card">
        <h2>Acciones & Combate</h2>
        <div id="accionesDisplay" style="text-align:center; font-size:1.1em; margin-bottom:15px;">
          Acciones: <span id="currentAcciones">0</span> / <span id="maxAcciones">0</span>
        </div>
        <!-- Panel de Combate -->
        <div class="combat-panel">
          <div><input type="number" id="inputDamage" placeholder="Daño" value="0" min="0"></div>
          <div><input type="number" id="inputHeal" placeholder="Curar" value="0" min="0"></div>
          <div><input type="number" id="inputMistyRegen" placeholder="Recuperar Místyculas" value="0" min="0"></div>
        </div>
        <div class="combat-buttons">
          <button class="btn" onclick="aplicarDaño()">Aplicar Daño</button>
          <button class="btn" onclick="aplicarCura()">Aplicar Cura</button>
          <button class="btn" onclick="regenerarMisty()">Recuperar Místyculas</button>
        </div>
        <hr>
        <div style="text-align:center; margin-top:10px;">
          <p><strong>Aplicar Costos de Acción:</strong></p>
          <button class="btn" onclick="aplicarAccionCompleja()">Acción Compleja (-2)</button>
          <button class="btn" onclick="aplicarAccionMenor()">Acción Menor (-1)</button>
          <button class="btn" onclick="aplicarReaccion()">Reacción (-3)</button>
          <button class="btn" onclick="aplicarAccionObjeto()">Acción Objeto (-1)</button>
          <button class="btn" onclick="aplicarAccionBonus()">Acción Bonus (+1)</button>
          <button class="btn" onclick="aplicarAccionLegendaria()">Acción Legendaria (-10 a -20)</button>
          <button class="btn" onclick="alert('Hablar no cuesta acciones.')">Hablar (0)</button>
        </div>
      </div>

      <!-- Secciones: Habilidades, Hechizos, Mascotas, Objetos -->
      <div class="card">
        <h2>Habilidades</h2>
        <div class="item-list" id="skillsList"></div>
        <div style="text-align:center;">
          <button class="btn" onclick="openModal('skillModal')">Agregar / Editar Habilidad</button>
        </div>
      </div>
      <div class="card">
        <h2>Hechizos</h2>
        <div class="item-list" id="spellsList"></div>
        <div style="text-align:center;">
          <button class="btn" onclick="openModal('spellModal')">Agregar / Editar Hechizo</button>
        </div>
      </div>
      <div class="card">
        <h2>Mascotas</h2>
        <div class="item-list" id="petsList"></div>
        <div style="text-align:center;">
          <button class="btn" onclick="openModal('petModal')">Agregar / Editar Mascota</button>
        </div>
      </div>
      <div class="card">
        <h2>Objetos</h2>
        <div class="item-list" id="itemsList"></div>
        <div style="text-align:center;">
          <button class="btn" onclick="openModal('itemModal')">Agregar / Editar Objeto</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Genérico -->
  <div id="modalOverlay" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal()">×</span>
      <div id="modalBody"></div>
      <button class="btn" id="modalSaveBtn">Guardar</button>
    </div>
  </div>

  <!-- Agregar después del modal genérico -->
  <div id="adminModal" class="admin-modal">
    <div class="admin-modal-content">
        <span class="admin-modal-close" onclick="closeAdminPanel()">&times;</span>
        <div id="adminPanelContent"></div>
    </div>
  </div>

  <script>
    // Agregar antes del script existente

    // Inicialización de datos
    
    const expTable = [
    {level: 1, exp: 0},
    {level: 2, exp: 300},
    {level: 3, exp: 900},
    {level: 4, exp: 2700},
    {level: 5, exp: 6500},
    {level: 6, exp: 14000},
    {level: 7, exp: 23000},
    {level: 8, exp: 34000},
    {level: 9, exp: 48000},
    {level: 10, exp: 64000},
    {level: 11, exp: 85000},
    {level: 12, exp: 100000},
    {level: 13, exp: 120000},
    {level: 14, exp: 140000},
    {level: 15, exp: 165000},
    {level: 16, exp: 195000},
    {level: 17, exp: 225000},
    {level: 18, exp: 265000},
    {level: 19, exp: 305000},
    {level: 20, exp: 355000}
];

    const character = {
        name: '',
        race: '',
        languages: '',
        personality: '',
        image: null,
        baseHealth: 10,
        currentHealth: 10,
        maxHealth: 10,
        baseArmor: 10,
        armor: 10,
        baseMistyculas: 10,
        currentMistyculas: 10,
        maxMistyculas: 10,
        experience: 0,
        level: 1,
        attributes: {
            fuerza: 10,
            inteligencia: 10,
            agilidad: 10,
            metabolismo: 10,
            am: 10
        },
        actions: {
            action: 3
        },
        skills: [],
        spells: [],
        pets: [],
        items: []
    };

    // Función para sanitizar fórmulas
    function sanitizeFormula(formula) {
        // Solo permitir operadores matemáticos y referencias a stats
        const safePattern = /^[\d\s\+\-\*\/\(\)dD\s]+$/;
        if (!safePattern.test(formula)) {
            throw new Error('Fórmula inválida');
        }
        return formula.replace(/[dD]/g, 'Math.floor(Math.random() *');
    }

    // Función para guardar datos
    function saveCharacter() {
        if (!auth.currentUser) return;
        
        db.collection('characters').doc(auth.currentUser.uid).set({
            character: character,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        })
        .catch((error) => {
            console.error('Error al guardar:', error);
        });
    }

    // Función para cargar datos
    function loadCharacter() {
        if (!auth.currentUser) return;
        
        db.collection('characters').doc(auth.currentUser.uid).get()
            .then((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    Object.assign(character, data.character);
                    actualizarTodo();
                }
            })
            .catch((error) => {
                console.error('Error al cargar:', error);
            });
    }

    // Modificar la función usarItem para usar sanitizeFormula
    function usarItem(listId, id) {
        try {
            if(listId === "skillsList"){
                const skill = character.skills.find(s => s.id === id);
                if(!skill) throw new Error('Habilidad no encontrada');
                
                if(character.currentMistyculas < skill.mistyCost){ 
                    alert("No tienes suficientes místyculas."); 
                    return; 
                }
                if(character.actions.action < skill.actionCost){ 
                    alert("No tienes suficientes acciones."); 
                    return; 
                }

                const safeFormula = sanitizeFormula(skill.formula);
                const resultado = eval(safeFormula);

                character.currentMistyculas -= skill.mistyCost;
                character.actions.action -= skill.actionCost;
                actualizarMistyculas();
                actualizarAcciones();
                saveCharacter();

                alert(`Habilidad usada: ${skill.name}\nResultado: ${resultado}`);
            }
            // Similar para spellsList...
        } catch (e) {
            alert('Error al usar el item: ' + e.message);
            console.error(e);
        }
    }

    // Agregar listener para cargar datos al inicio
    document.addEventListener('DOMContentLoaded', loadCharacter);

    // Simple login simulation
    function login() {
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value.trim();
    
    if (!username || !password) {
        alert("Por favor ingrese usuario y contraseña");
        return;
    }

    // Usar email para Firebase (agregar @tudominio.com)
    const email = `${username}@tudominio.com`;
    
    auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
            const user = userCredential.user;
            // Verificar si es admin consultando Firestore
            db.collection('users').doc(user.uid).get()
                .then((doc) => {
                    const userData = doc.data();
                    const isAdmin = userData.role === 'admin';
                    localStorage.setItem("username", username);
                    showMain(isAdmin);
                });
        })
        .catch((error) => {
            alert("Error en la autenticación: " + error.message);
        });
}

// Función para registrar nuevos usuarios
function registrarUsuario() {
    const username = document.getElementById("newUsername").value.trim();
    const password = document.getElementById("newPassword").value.trim();
    const email = `${username}@tudominio.com`;

    auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
            const user = userCredential.user;
            // Guardar datos adicionales en Firestore
            return db.collection('users').doc(user.uid).set({
                username: username,
                role: 'user',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        })
        .then(() => {
            alert("Usuario creado exitosamente");
            // Crear documento para los datos del personaje
            return db.collection('characters').doc(user.uid).set({
                character: character
            });
        })
        .catch((error) => {
            alert("Error al crear usuario: " + error.message);
        });
}

function showMain(isAdmin) {
    document.getElementById("loginPage").style.display = "none";
    document.getElementById("mainPage").style.display = "block";
    
    // Remover botón de logout existente si hay alguno
    const existingBtn = document.querySelector('.logout-btn');
    if (existingBtn) {
        existingBtn.remove();
    }
    
    // Agregar botones de admin y logout
    const header = document.querySelector('.container');
    
    if (isAdmin) {
        const adminBtn = document.createElement('button');
        adminBtn.className = 'btn admin-btn';
        adminBtn.style.float = 'right';
        adminBtn.style.marginLeft = '10px';
        adminBtn.onclick = showAdminPanel;
        adminBtn.textContent = 'Panel Admin';
        header.insertBefore(adminBtn, header.firstChild);
    }
    
    const logoutBtn = document.createElement('button');
    logoutBtn.className = 'btn logout-btn';
    logoutBtn.style.float = 'right';
    logoutBtn.onclick = logout;
    logoutBtn.textContent = 'Cerrar Sesión';
    header.insertBefore(logoutBtn, header.firstChild);
    
    resetAcciones();
    actualizarTodo();
}

function showAdminPanel() {
    const adminModal = document.getElementById('adminModal');
    const adminPanelContent = document.getElementById('adminPanelContent');
    
    adminPanelContent.innerHTML = `
        <h2>Panel de Administración</h2>
        <div class="admin-controls">
            <div class="admin-section">
                <h3>Gestión de Usuarios</h3>
                <button class="btn" onclick="crearUsuario()">Crear Usuario</button>
                <button class="btn" onclick="listarUsuarios()">Listar Usuarios</button>
                <button class="btn" onclick="gestionarPermisos()">Gestionar Permisos</button>
                <button class="btn" onclick="bloquearUsuario()">Bloquear Usuario</button>
                <button class="btn" onclick="resetearPassword()">Resetear Contraseña</button>
            </div>
            <div class="admin-section">
                <h3>Estadísticas del Sistema</h3>
                <div class="admin-stats">
                    <div>Usuarios activos: <span id="activeUsers">0</span></div>
                    <div>Personajes creados: <span id="totalChars">0</span></div>
                    <div>Último backup: <span id="lastBackup">Nunca</span></div>
                    <div>Sesiones activas: <span id="activeSessions">0</span></div>
                    <div>Espacio usado: <span id="usedSpace">0 MB</span></div>
                </div>
            </div>
            <div class="admin-section">
                <h3>Herramientas de Sistema</h3>
                <button class="btn" onclick="backupSystem()">Realizar Backup</button>
                <button class="btn" onclick="checkSystem()">Verificar Sistema</button>
                <button class="btn" onclick="systemLogs()">Ver Logs</button>
                <button class="btn" onclick="limpiarCache()">Limpiar Cache</button>
                <button class="btn" onclick="optimizarDB()">Optimizar DB</button>
            </div>
            <div class="admin-section">
                <h3>Configuración</h3>
                <button class="btn" onclick="configurarSistema()">Configuración General</button>
                <button class="btn" onclick="gestionarRoles()">Gestionar Roles</button>
                <button class="btn" onclick="configurarBackups()">Config. Backups</button>
                <button class="btn" onclick="gestionarLimites()">Límites del Sistema</button>
            </div>
        </div>
    `;
    
    adminModal.style.display = 'flex';
    actualizarEstadisticas();
}

function closeAdminPanel() {
    document.getElementById('adminModal').style.display = 'none';
}

// Agregar evento para cerrar el panel al hacer click fuera
document.addEventListener('click', function(event) {
    const adminModal = document.getElementById('adminModal');
    const adminModalContent = document.querySelector('.admin-modal-content');
    
    if (event.target === adminModal) {
        closeAdminPanel();
    }
});

    // Admin function to simulate user creation (dummy function)
    function crearUsuario() {
      let newUser = prompt("Ingrese el nombre del nuevo usuario:");
      if(newUser) { alert("Usuario '" + newUser + "' creado (simulación)."); }
    }

    // Character sheet functions
    function calcularMod(valor) { return Math.floor((valor - 10) / 2); }
    function actualizarAtributos() {
      document.getElementById("modFuerza").textContent = calcularMod(character.attributes.fuerza);
      document.getElementById("modInt").textContent = calcularMod(character.attributes.inteligencia);
      document.getElementById("modAgil").textContent = calcularMod(character.attributes.agilidad);
      document.getElementById("modMetab").textContent = calcularMod(character.attributes.metabolismo);
      document.getElementById("modAM").textContent = calcularMod(character.attributes.am);
    }
    function actualizarNivelXP() {
      let lvl = 1, baseXP = 0;
      for(let i = 0; i < expTable.length; i++){
        if(character.experience >= expTable[i].exp){
          lvl = expTable[i].level;
          baseXP = expTable[i].exp;
        } else break;
      }
      character.level = lvl;
      const next = expTable.find(e => e.level === lvl + 1);
      const xpExcess = character.experience - baseXP;
      const xpNeeded = next ? next.exp - baseXP : 0;
      document.getElementById("calcXP").textContent = xpExcess + " / " + xpNeeded;
      document.getElementById("calcNivel").textContent = character.level + " / 20";
    }
    function actualizarVida() {
      const modMet = calcularMod(character.attributes.metabolismo);
      character.maxHealth = Math.floor(character.baseHealth * character.level * (modMet > 0 ? modMet : 1));
      if(character.currentHealth > character.maxHealth) character.currentHealth = character.maxHealth;
      document.getElementById("calcVida").textContent = character.currentHealth + " / " + character.maxHealth;
    }
    function actualizarArmor() {
      const modAgil = calcularMod(character.attributes.agilidad);
      const modMet = calcularMod(character.attributes.metabolismo);
      character.armor = character.baseArmor + modAgil + modMet;
      document.getElementById("calcArmor").textContent = character.armor;
    }
    function actualizarMistyculas() {
      const modInt = calcularMod(character.attributes.inteligencia);
      const modAM = calcularMod(character.attributes.am);
      character.maxMistyculas = character.baseMistyculas * (modInt > 0 ? modInt : 1) * (modAM > 0 ? modAM : 1);
      if(character.currentMistyculas > character.maxMistyculas) character.currentMistyculas = character.maxMistyculas;
      document.getElementById("calcMistyculas").textContent = character.currentMistyculas + " / " + character.maxMistyculas;
    }
    function actualizarAcciones() {
        const modAgil = calcularMod(character.attributes.agilidad);
        const maxAcciones = character.level + modAgil + 1;
        document.getElementById("currentAcciones").textContent = character.actions.action;
        document.getElementById("maxAcciones").textContent = maxAcciones;
        document.getElementById("accionesDisplay").style.color = 
            character.actions.action <= 0 ? "red" : "inherit";
    }
    function resetAcciones() {
        const modAgil = calcularMod(character.attributes.agilidad);
        character.actions.action = character.level + modAgil + 1;
        actualizarAcciones();
        saveCharacter();
    }
    function actualizarTodo() {
      actualizarAtributos();
      actualizarNivelXP();
      actualizarVida();
      actualizarArmor();
      actualizarMistyculas();
      actualizarAcciones();
    }
    function agregarXP() {
    const input = document.getElementById("inputXP");
    const xp = parseInt(input.value);
    
    if(isNaN(xp) || xp < 0) {
        alert("Por favor ingrese una cantidad válida de XP");
        return;
    }
    
    character.experience += xp;
    input.value = "0"; // Resetear el input después de agregar
    actualizarTodo();
    saveCharacter(); // Guardar los cambios
    
    // Mostrar un mensaje con el nuevo nivel si hubo cambio
    const nuevoNivel = Math.min(20, character.level);
    if(nuevoNivel > character.level) {
        alert(`¡Has subido al nivel ${nuevoNivel}!`);
    }
}
    function aplicarDaño() {
      const dmg = parseInt(document.getElementById("inputDamage").value);
      if(isNaN(dmg) || dmg < 0) return;
      character.currentHealth -= dmg;
      if(character.currentHealth < 0) character.currentHealth = 0;
      actualizarVida();
    }
    function aplicarCura() {
      const cura = parseInt(document.getElementById("inputHeal").value);
      if(isNaN(cura) || cura < 0) return;
      character.currentHealth += cura;
      if(character.currentHealth > character.maxHealth) character.currentHealth = character.maxHealth;
      actualizarVida();
    }
    function regenerarMisty() {
      const regen = parseInt(document.getElementById("inputMistyRegen").value);
      if(isNaN(regen) || regen < 0) return;
      character.currentMistyculas += regen;
      if(character.currentMistyculas > character.maxMistyculas) character.currentMistyculas = character.maxMistyculas;
      actualizarMistyculas();
    }
    // Eventos para atributos
    document.getElementById("attrFuerza").addEventListener("change", () => {
      character.attributes.fuerza = parseInt(document.getElementById("attrFuerza").value);
      actualizarTodo();
    });
    document.getElementById("attrInt").addEventListener("change", () => {
      character.attributes.inteligencia = parseInt(document.getElementById("attrInt").value);
      actualizarTodo();
    });
    document.getElementById("attrAgil").addEventListener("change", () => {
      character.attributes.agilidad = parseInt(document.getElementById("attrAgil").value);
      actualizarTodo();
    });
    document.getElementById("attrMetab").addEventListener("change", () => {
      character.attributes.metabolismo = parseInt(document.getElementById("attrMetab").value);
      actualizarTodo();
    });
    document.getElementById("attrAM").addEventListener("change", () => {
      character.attributes.am = parseInt(document.getElementById("attrAM").value);
      actualizarTodo();
    });
    // Datos del personaje
    document.getElementById("charName").addEventListener("change", function() { character.name = this.value; });
    document.getElementById("charRace").addEventListener("change", function() { character.race = this.value; });
    document.getElementById("charLang").addEventListener("change", function() { character.languages = this.value; });
    document.getElementById("charPerso").addEventListener("change", function() { character.personality = this.value; });
    // Imagen
    document.getElementById("imgContainer").addEventListener("click", function() {
      document.getElementById("imgUpload").click();
    });
    document.getElementById("imgUpload").addEventListener("change", function(e) {
      try {
          const file = e.target.files[0];
          if(!file) return;
          
          validateImage(file);
          
          const reader = new FileReader();
          reader.onload = function(ev) {
              character.image = ev.target.result;
              document.getElementById("imgContainer").innerHTML = 
                  `<img src="${character.image}" style="width:100%; height:100%; object-fit:cover;">`;
              saveCharacter();
          }
          reader.readAsDataURL(file);
      } catch (e) {
          alert('Error al cargar imagen: ' + e.message);
      }
    });

    /* Funciones para aplicar costos de acción */
    function aplicarAccionCompleja() {
        if(character.actions.action < 2){ 
            alert("No tienes suficientes acciones."); 
            return; 
        }
        character.actions.action -= 2;
        actualizarAcciones();
        saveCharacter();
    }
    function aplicarAccionMenor() {
        if(character.actions.action < 1){ 
            alert("No tienes suficientes acciones."); 
            return; 
        }
        character.actions.action -= 1;
        actualizarAcciones();
        saveCharacter();
    }
    function aplicarReaccion() {
        if(character.actions.action < 3){ 
            alert("No tienes suficientes acciones."); 
            return; 
        }
        character.actions.action -= 3;
        actualizarAcciones();
        saveCharacter();
    }
    function aplicarAccionObjeto() {
        if(character.actions.action < 1){ 
            alert("No tienes suficientes acciones."); 
            return; 
        }
        character.actions.action -= 1;
        actualizarAcciones();
        saveCharacter();
    }
    function aplicarAccionBonus() {
        character.actions.action += 1;
        actualizarAcciones();
        saveCharacter();
    }
    function aplicarAccionLegendaria() {
        let cost = parseInt(prompt("Ingrese el costo para la acción legendaria (entre 10 y 20):"));
        if(isNaN(cost) || cost < 10 || cost > 20){ 
            alert("Costo inválido."); 
            return; 
        }
        if(character.actions.action < cost){ 
            alert("No tienes suficientes acciones."); 
            return; 
        }
        character.actions.action -= cost;
        actualizarAcciones();
        saveCharacter();
    }

    /* Modal Genérico */
    const modalOverlay = document.getElementById("modalOverlay");
    const modalBody = document.getElementById("modalBody");
    const modalSaveBtn = document.getElementById("modalSaveBtn");
    let modalCallback = null;
    function openModal(modalId, itemId = null) {
      modalOverlay.style.display = "flex";
      if(modalId === 'skillModal'){
        let skill = itemId ? character.skills.find(s => s.id === itemId) : null;
        modalBody.innerHTML = `
          <h3>${ skill ? "Editar" : "Crear" } Habilidad</h3>
          <label>Nombre:</label>
          <input type="text" id="modalSkillName" placeholder="Nombre" value="${ skill ? skill.name : "" }">
          <label>Descripción:</label>
          <textarea id="modalSkillDesc" placeholder="Descripción">${ skill ? skill.desc : "" }</textarea>
          <label>Fórmula:</label>
          <input type="text" id="modalSkillFormula" placeholder="Ej: Fuerza d InteligenciaMod+2" value="${ skill ? skill.formula : "" }">
          <div class="formula-buttons">
            <div class="formula-btn" onclick="insertFormula('Fuerza', 'modalSkillFormula')">Fuerza</div>
            <div class="formula-btn" onclick="insertFormula('Inteligencia', 'modalSkillFormula')">Inteligencia</div>
            <div class="formula-btn" onclick="insertFormula('Agilidad', 'modalSkillFormula')">Agilidad</div>
            <div class="formula-btn" onclick="insertFormula('Metabolismo', 'modalSkillFormula')">Metabolismo</div>
            <div class="formula-btn" onclick="insertFormula('A.M', 'modalSkillFormula')">A.M</div>
            <div class="formula-btn" onclick="insertFormula('FuerzaMod', 'modalSkillFormula')">FuerzaMod</div>
            <div class="formula-btn" onclick="insertFormula('InteligenciaMod', 'modalSkillFormula')">InteligenciaMod</div>
            <div class="formula-btn" onclick="insertFormula('AgilidadMod', 'modalSkillFormula')">AgilidadMod</div>
            <div class="formula-btn" onclick="insertFormula('MetabolismoMod', 'modalSkillFormula')">MetabolismoMod</div>
            <div class="formula-btn" onclick="insertFormula('AMMod', 'modalSkillFormula')">AMMod</div>
            <div class="formula-btn" onclick="insertFormula('Mistyculas', 'modalSkillFormula')">Mistyculas</div>
            <div class="formula-btn" onclick="insertFormula('Armadura', 'modalSkillFormula')">Armadura</div>
            <div class="formula-btn" onclick="insertFormula('VidaBase', 'modalSkillFormula')">VidaBase</div>
            <div class="formula-btn" onclick="insertFormula('VidaActual', 'modalSkillFormula')">VidaActual</div>
            <div class="formula-btn" onclick="insertFormula(' d ', 'modalSkillFormula')">d</div>
            <div class="formula-btn" onclick="insertFormula('+', 'modalSkillFormula')">+</div>
            <div class="formula-btn" onclick="insertFormula('-', 'modalSkillFormula')">-</div>
            <div class="formula-btn" onclick="insertFormula('*', 'modalSkillFormula')">*</div>
            <div class="formula-btn" onclick="insertFormula('/', 'modalSkillFormula')">/</div>
            <div class="formula-btn" onclick="insertFormula('(', 'modalSkillFormula')">(</div>
            <div class="formula-btn" onclick="insertFormula(')', 'modalSkillFormula')">)</div>
          </div>
          <label>Costo de Acción:</label>
          <input type="number" id="modalSkillActionCost" value="${ skill ? skill.actionCost : 1 }" min="0">
          <label>Costo de Místyculas:</label>
          <input type="number" id="modalSkillMistyCost" value="${ skill ? skill.mistyCost : 0 }" min="0">
        `;
        modalCallback = function() {
          const newSkill = {
            id: skill ? skill.id : Date.now().toString(),
            name: document.getElementById("modalSkillName").value,
            desc: document.getElementById("modalSkillDesc").value,
            formula: document.getElementById("modalSkillFormula").value,
            actionCost: parseInt(document.getElementById("modalSkillActionCost").value),
            mistyCost: parseInt(document.getElementById("modalSkillMistyCost").value)
          };
          if(skill){
            const index = character.skills.findIndex(s => s.id === skill.id);
            character.skills[index] = newSkill;
          } else {
            character.skills.push(newSkill);
          }
          renderList('skillsList', character.skills);
        };
      }
      else if(modalId === 'spellModal'){
        let spell = itemId ? character.spells.find(s => s.id === itemId) : null;
        modalBody.innerHTML = `
          <h3>${ spell ? "Editar" : "Crear" } Hechizo</h3>
          <label>Nombre:</label>
          <input type="text" id="modalSpellName" placeholder="Nombre" value="${ spell ? spell.name : "" }">
          <label>Descripción:</label>
          <textarea id="modalSpellDesc" placeholder="Descripción">${ spell ? spell.desc : "" }</textarea>
          <label>Fórmula:</label>
          <input type="text" id="modalSpellFormula" placeholder="Ej: 1d10+Inteligencia" value="${ spell ? spell.formula : "" }">
          <div class="formula-buttons">
            <div class="formula-btn" onclick="insertFormula('Fuerza', 'modalSpellFormula')">Fuerza</div>
            <div class="formula-btn" onclick="insertFormula('Inteligencia', 'modalSpellFormula')">Inteligencia</div>
            <div class="formula-btn" onclick="insertFormula('Agilidad', 'modalSpellFormula')">Agilidad</div>
            <div class="formula-btn" onclick="insertFormula('Metabolismo', 'modalSpellFormula')">Metabolismo</div>
            <div class="formula-btn" onclick="insertFormula('A.M', 'modalSpellFormula')">A.M</div>
            <div class="formula-btn" onclick="insertFormula('FuerzaMod', 'modalSpellFormula')">FuerzaMod</div>
            <div class="formula-btn" onclick="insertFormula('InteligenciaMod', 'modalSpellFormula')">InteligenciaMod</div>
            <div class="formula-btn" onclick="insertFormula('AgilidadMod', 'modalSpellFormula')">AgilidadMod</div>
            <div class="formula-btn" onclick="insertFormula('MetabolismoMod', 'modalSpellFormula')">MetabolismoMod</div>
            <div class="formula-btn" onclick="insertFormula('AMMod', 'modalSpellFormula')">AMMod</div>
            <div class="formula-btn" onclick="insertFormula('Mistyculas', 'modalSpellFormula')">Mistyculas</div>
            <div class="formula-btn" onclick="insertFormula('Armadura', 'modalSpellFormula')">Armadura</div>
            <div class="formula-btn" onclick="insertFormula('VidaBase', 'modalSpellFormula')">VidaBase</div>
            <div class="formula-btn" onclick="insertFormula('VidaActual', 'modalSpellFormula')">VidaActual</div>
            <div class="formula-btn" onclick="insertFormula(' d ', 'modalSpellFormula')">d</div>
            <div class="formula-btn" onclick="insertFormula('+', 'modalSpellFormula')">+</div>
            <div class="formula-btn" onclick="insertFormula('-', 'modalSpellFormula')">-</div>
            <div class="formula-btn" onclick="insertFormula('*', 'modalSpellFormula')">*</div>
            <div class="formula-btn" onclick="insertFormula('/', 'modalSpellFormula')">/</div>
            <div class="formula-btn" onclick="insertFormula('(', 'modalSpellFormula')">(</div>
            <div class="formula-btn" onclick="insertFormula(')', 'modalSpellFormula')">)</div>
          </div>
          <label>Costo de Acción:</label>
          <input type="number" id="modalSpellActionCost" value="${ spell ? spell.actionCost : 1 }" min="0">
          <label>Costo de Místyculas:</label>
          <input type="number" id="modalSpellMistyCost" value="${ spell ? spell.mistyCost : 0 }" min="0">
        `;
        modalCallback = function() {
          const newSpell = {
            id: spell ? spell.id : Date.now().toString(),
            name: document.getElementById("modalSpellName").value,
            desc: document.getElementById("modalSpellDesc").value,
            formula: document.getElementById("modalSpellFormula").value,
            actionCost: parseInt(document.getElementById("modalSpellActionCost").value),
            mistyCost: parseInt(document.getElementById("modalSpellMistyCost").value)
          };
          if(spell){
            const index = character.spells.findIndex(s => s.id === spell.id);
            character.spells[index] = newSpell;
          } else {
            character.spells.push(newSpell);
          }
          renderList('spellsList', character.spells);
        };
      }
      else if(modalId === 'petModal'){
        let pet = itemId ? character.pets.find(p => p.id === itemId) : null;
        modalBody.innerHTML = `
          <h3>${ pet ? "Editar" : "Crear" } Mascota</h3>
          <label>Nombre:</label>
          <input type="text" id="modalPetName" placeholder="Nombre" value="${ pet ? pet.name : "" }">
          <label>Tipo:</label>
          <input type="text" id="modalPetType" placeholder="Tipo" value="${ pet ? pet.type : "" }">
          <label>Imagen:</label>
          <input type="file" id="modalPetImage">
        `;
        modalCallback = function() {
          let newPet = {
            id: pet ? pet.id : Date.now().toString(),
            name: document.getElementById("modalPetName").value,
            type: document.getElementById("modalPetType").value,
            image: pet ? pet.image : null
          };
          const file = document.getElementById("modalPetImage").files[0];
          if(file){
            const reader = new FileReader();
            reader.onload = function(ev){
              newPet.image = ev.target.result;
              if(pet){
                const index = character.pets.findIndex(p => p.id === pet.id);
                character.pets[index] = newPet;
              } else {
                character.pets.push(newPet);
              }
              renderList('petsList', character.pets);
            }
            reader.readAsDataURL(file);
          } else {
            if(pet){
              const index = character.pets.findIndex(p => p.id === pet.id);
              character.pets[index] = newPet;
            } else {
              character.pets.push(newPet);
            }
            renderList('petsList', character.pets);
          }
        };
      }
      else if(modalId === 'itemModal'){
        let itemObj = itemId ? character.items.find(i => i.id === itemId) : null;
        modalBody.innerHTML = `
          <h3>${ itemObj ? "Editar" : "Crear" } Objeto</h3>
          <label>Nombre:</label>
          <input type="text" id="modalItemName" placeholder="Nombre" value="${ itemObj ? itemObj.name : "" }">
          <label>Tipo:</label>
          <input type="text" id="modalItemType" placeholder="Tipo" value="${ itemObj ? itemObj.type : "" }">
          <label>Efectos:</label>
          <textarea id="modalItemEffects" placeholder="Efectos">${ itemObj ? itemObj.effects : "" }</textarea>
        `;
        modalCallback = function() {
          const newItem = {
            id: itemObj ? itemObj.id : Date.now().toString(),
            name: document.getElementById("modalItemName").value,
            type: document.getElementById("modalItemType").value,
            effects: document.getElementById("modalItemEffects").value
          };
          if(itemObj){
            const index = character.items.findIndex(i => i.id === itemObj.id);
            character.items[index] = newItem;
          } else {
            character.items.push(newItem);
          }
          renderList('itemsList', character.items);
        };
      }
      else if(modalId === 'formulasModal'){
        const modFuerza = calcularMod(character.attributes.fuerza);
        const modInt = calcularMod(character.attributes.inteligencia);
        const modAgil = calcularMod(character.attributes.agilidad);
        const modMetab = calcularMod(character.attributes.metabolismo);
        const modAM = calcularMod(character.attributes.am);
        const movimiento = (modFuerza + modAgil) * 10;
        const carga = (modMetab + modFuerza) * 10;
        const acciones = character.level + modAgil + 1;
        const resistencia = character.level + modMetab;
        const tamano = modMetab * 10;
        const altura = tamano * 10;
        const peso = tamano * 5;
        const vida = character.baseHealth * character.level * (modMetab > 0 ? modMetab : 1);
        const sabiduria = modInt + character.level;
        const misty = character.baseMistyculas * (modInt > 0 ? modInt : 1) * (modAM > 0 ? modAM : 1);
        const regenMisty = character.level + character.attributes.inteligencia + character.attributes.am;
        const regenVida = character.level + character.attributes.metabolismo + character.attributes.am;
        modalBody.innerHTML = `
          <h3>Fórmulas Avanzadas</h3>
          <p><strong>Daño Cuerpo a Cuerpo:</strong> Arma + Fuerza</p>
          <p><strong>Movimiento:</strong> (Fuerza mod + Agilidad mod) × 10 = ${movimiento} pies</p>
          <p><strong>Carga:</strong> (Metabolismo mod + Fuerza mod) × 10 = ${carga} libras</p>
          <p><strong>Armadura:</strong> 10 + (Agilidad mod + Metabolismo mod) = ${character.baseArmor + modAgil + modMetab}</p>
          <p><strong>Acciones:</strong> Nivel + Agilidad mod + 1 = ${acciones}</p>
          <p><strong>Resistencia a Efectos:</strong> Nivel + Metabolismo mod = ${resistencia}</p>
          <p><strong>Tamaño:</strong> Metabolismo mod × 10 = ${tamano} | Altura = ${altura} cm | Peso = ${peso} kg</p>
          <p><strong>Vida:</strong> Vida Base × (Metabolismo mod > 0 ? Metabolismo mod : 1) × Nivel = ${vida}</p>
          <p><strong>Sabiduría:</strong> Inteligencia mod + Nivel = ${sabiduria}</p>
          <p><strong>Mistyculas:</strong> Mistyculas Base × (Inteligencia mod > 0 ? Inteligencia mod : 1) × (A.M mod > 0 ? A.M mod : 1) = ${misty}</p>
          <p><strong>Regeneración de Místyculas:</strong> Nivel + Inteligencia + A.M = ${regenMisty}</p>
          <p><strong>Regeneración de Vida:</strong> Nivel + Metabolismo + A.M = ${regenVida}</p>
        `;
        modalCallback = null;
      }
      else if(modalId === 'editStatsModal'){
        modalBody.innerHTML = `
          <h3>Editar Estadísticas</h3>
          <label>Vida Base:</label>
          <input type="number" id="modalBaseHealth" value="${character.baseHealth}">
          <label>Vida Actual:</label>
          <input type="number" id="modalCurrentHealth" value="${character.currentHealth}">
          <label>XP Actual:</label>
          <input type="number" id="modalXP" value="${character.experience}">
          <label>Mistyculas Base:</label>
          <input type="number" id="modalBaseMisty" value="${character.baseMistyculas}">
          <label>Mistyculas Actuales:</label>
          <input type="number" id="modalCurrentMisty" value="${character.currentMistyculas}">
          <label>Armadura Base:</label>
          <input type="number" id="modalArmorBase" value="${character.baseArmor}">
        `;
        modalCallback = function() {
          character.baseHealth = parseInt(document.getElementById("modalBaseHealth").value);
          character.currentHealth = parseInt(document.getElementById("modalCurrentHealth").value);
          character.experience = parseInt(document.getElementById("modalXP").value);
          character.baseMistyculas = parseInt(document.getElementById("modalBaseMisty").value);
          character.currentMistyculas = parseInt(document.getElementById("modalCurrentMisty").value);
          character.baseArmor = parseInt(document.getElementById("modalArmorBase").value);
          actualizarTodo();
        };
      }
    }
    function closeModal() {
      modalOverlay.style.display = "none";
      modalBody.innerHTML = "";
      modalCallback = null;
    }
    modalSaveBtn.addEventListener("click", function() {
      if(modalCallback) modalCallback();
      closeModal();
    });
    function insertFormula(text, inputId) {
      const input = document.getElementById(inputId);
      input.value += text;
    }
    function renderList(elementId, list) {
      const container = document.getElementById(elementId);
      container.innerHTML = "";
      if(list.length === 0){ container.innerHTML = "<p>No hay elementos.</p>"; return; }
      list.forEach(item => {
        const div = document.createElement("div");
        div.className = "item";
        let extra = "";
        if(item.formula)
          extra = " | Fórmula: " + item.formula;
        else if(item.type && !item.formula)
          extra = " (" + item.type + ")";
        if(item.image)
          extra += `<br><img src="${item.image}" alt="Mascota" style="max-width:100px; margin-top:5px;">`;
        div.innerHTML = `<span><strong>${item.name}</strong>${item.desc ? " - " + item.desc : ""}${extra}</span>
          <div>
            <button class="btn" onclick="editarItem('${elementId}', '${item.id}')">Editar</button>
            <button class="btn" onclick="eliminarItem('${elementId}', '${item.id}')">Eliminar</button>
            ${(elementId==='skillsList' || elementId==='spellsList')
              ? `<button class="btn" onclick="usarItem('${elementId}', '${item.id}')">Usar</button>`
              : ""
            }
          </div>`;
        container.appendChild(div);
      });
    }
    function eliminarItem(listId, id) {
      if(listId === "skillsList"){
        character.skills = character.skills.filter(s => s.id !== id);
        renderList(listId, character.skills);
      } else if(listId === "spellsList"){
        character.spells = character.spells.filter(s => s.id !== id);
        renderList(listId, character.spells);
      } else if(listId === "petsList"){
        character.pets = character.pets.filter(p => p.id !== id);
        renderList(listId, character.pets);
      } else if(listId === "itemsList"){
        character.items = character.items.filter(i => i.id !== id);
        renderList(listId, character.items);
      }
    }
    function editarItem(listId, id) {
      if(listId === "skillsList"){ openModal('skillModal', id); }
      else if(listId === "spellsList"){ openModal('spellModal', id); }
      else if(listId === "petsList"){ openModal('petModal', id); }
      else if(listId === "itemsList"){ openModal('itemModal', id); }
    }
    function usarItem(listId, id) {
      try {
        if(listId === "skillsList"){
            const skill = character.skills.find(s => s.id === id);
            if(!skill) throw new Error('Habilidad no encontrada');
            
            if(character.currentMistyculas < skill.mistyCost){ 
                alert("No tienes suficientes místyculas."); 
                return; 
            }
            if(character.actions.action < skill.actionCost){ 
                alert("No tienes suficientes acciones."); 
                return; 
            }

            const safeFormula = sanitizeFormula(skill.formula);
            const resultado = eval(safeFormula);

            character.currentMistyculas -= skill.mistyCost;
            character.actions.action -= skill.actionCost;
            actualizarMistyculas();
            actualizarAcciones();
            saveCharacter();

            alert(`Habilidad usada: ${skill.name}\nResultado: ${resultado}`);
        }
        // Similar para spellsList...
    } catch (e) {
        alert('Error al usar el item: ' + e.message);
        console.error(e);
    }
    }
    document.addEventListener('DOMContentLoaded', loadCharacter);
    actualizarTodo();

    function validateImage(file) {
        const maxSize = 5 * 1024 * 1024; // 5MB
        const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
        
        if (!validTypes.includes(file.type)) {
            throw new Error('Tipo de archivo no válido');
        }
        if (file.size > maxSize) {
            throw new Error('Imagen demasiado grande');
        }
        return true;
    }

    // Modificar el evento de carga de imagen
    document.getElementById("imgUpload").addEventListener("change", function(e) {
        try {
            const file = e.target.files[0];
            if(!file) return;
            
            validateImage(file);
            
            const reader = new FileReader();
            reader.onload = function(ev) {
                character.image = ev.target.result;
                document.getElementById("imgContainer").innerHTML = 
                    `<img src="${character.image}" style="width:100%; height:100%; object-fit:cover;">`;
                saveCharacter();
            }
            reader.readAsDataURL(file);
        } catch (e) {
            alert('Error al cargar imagen: ' + e.message);
        }
    });

    // Funciones de administración
    function crearUsuario() {
        const username = prompt("Nombre de usuario:");
        const password = prompt("Contraseña:");
        if(username && password) {
            // Aquí iría la lógica para crear usuario en una base de datos real
            alert(`Usuario "${username}" creado exitosamente`);
            actualizarEstadisticas();
        }
    }

    function listarUsuarios() {
        // Simulación de lista de usuarios
        const usuarios = [
            {username: "usuario1", lastLogin: "2025-04-09"},
            {username: "usuario2", lastLogin: "2025-04-08"},
            // En una implementación real, estos datos vendrían de una base de datos
        ];
        
        let lista = usuarios.map(u => 
            `${u.username} - Último acceso: ${u.lastLogin}`
        ).join('\n');
        
        alert("Usuarios del sistema:\n\n" + lista);
    }

    function gestionarPermisos() {
        alert("Función de gestión de permisos - En desarrollo");
    }

    function backupSystem() {
        const date = new Date().toLocaleString();
        document.getElementById("lastBackup").textContent = date;
        alert("Backup del sistema realizado");
    }

    function checkSystem() {
        alert("Verificación del sistema completada. Todo funciona correctamente.");
    }

    function systemLogs() {
        alert("Sistema de logs - En desarrollo");
    }

    function actualizarEstadisticas() {
        document.getElementById("activeUsers").textContent = "5"; // Simulado
        document.getElementById("totalChars").textContent = "12"; // Simulado
    }

    // Agregar al inicio de sesión
    document.addEventListener('DOMContentLoaded', function() {
        if(localStorage.getItem("role") === "admin") {
            showMain(true);
        } else if(localStorage.getItem("role") === "user") {
            showMain(false);
        }
    });

    // Modificar el event listener de DOMContentLoaded
    document.addEventListener('DOMContentLoaded', function() {
        // Limpiar cualquier sesión anterior
        localStorage.removeItem("role");
        localStorage.removeItem("username");
        
        // Ocultar main y mostrar login
        document.getElementById("mainPage").style.display = "none";
        document.getElementById("loginPage").style.display = "block";
        
        // Limpiar campos de login
        document.getElementById("username").value = "";
        document.getElementById("password").value = "";
        
        // Cargar datos del personaje
        loadCharacter();
    });

    // Modificar la función de login
    function login() {
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();
        
        if (!username || !password) {
            alert("Por favor ingrese usuario y contraseña");
            return;
        }

        // Admin credentials
        if (username === "admin" && password === "admin123") {
            localStorage.setItem("role", "admin");
            localStorage.setItem("username", username);
            showMain(true);
            return;
        }
        
        // Regular users - aquí puedes agregar tu lógica de validación
        if (username && password) {
            localStorage.setItem("role", "user");
            localStorage.setItem("username", username);
            showMain(false);
            return;
        }
        
        alert("Usuario o contraseña incorrectos");
    }

    // Agregar función de logout
    function logout() {
        localStorage.removeItem("role");
        localStorage.removeItem("username");
        document.getElementById("mainPage").style.display = "none";
        document.getElementById("loginPage").style.display = "block";
        document.getElementById("username").value = "";
        document.getElementById("password").value = "";
    }

    // Modificar showMain para agregar botón de logout
    function showMain(isAdmin) {
        document.getElementById("loginPage").style.display = "none";
        document.getElementById("mainPage").style.display = "block";
        
        // Remover botón de logout existente si hay alguno
        const existingBtn = document.querySelector('.logout-btn');
        if (existingBtn) {
            existingBtn.remove();
        }
        
        // Agregar nuevo botón de logout
        const header = document.querySelector('.container');
        const logoutBtn = document.createElement('button');
        logoutBtn.className = 'btn logout-btn'; // Agregamos clase para identificarlo
        logoutBtn.style.float = 'right';
        logoutBtn.onclick = logout;
        logoutBtn.textContent = 'Cerrar Sesión';
        header.insertBefore(logoutBtn, header.firstChild);
        
        if (isAdmin) {
            document.getElementById("adminPanel").style.display = "block";
            mostrarPanelAdmin();
        }
        
        resetAcciones();
        actualizarTodo();
    }

    function mostrarPanelAdmin() {
        document.getElementById("adminPanel").innerHTML = `
            <h2>Panel de Administración</h2>
            <div class="admin-controls">
                <div class="admin-section">
                    <h3>Gestión de Usuarios</h3>
                    <button class="btn" onclick="crearUsuario()">Crear Usuario</button>
                    <button class="btn" onclick="listarUsuarios()">Listar Usuarios</button>
                    <button class="btn" onclick="gestionarPermisos()">Gestionar Permisos</button>
                    <button class="btn" onclick="bloquearUsuario()">Bloquear Usuario</button>
                    <button class="btn" onclick="resetearPassword()">Resetear Contraseña</button>
                </div>
                <div class="admin-section">
                    <h3>Estadísticas del Sistema</h3>
                    <div class="admin-stats">
                        <div>Usuarios activos: <span id="activeUsers">0</span></div>
                        <div>Personajes creados: <span id="totalChars">0</span></div>
                        <div>Último backup: <span id="lastBackup">Nunca</span></div>
                        <div>Sesiones activas: <span id="activeSessions">0</span></div>
                        <div>Espacio usado: <span id="usedSpace">0 MB</span></div>
                    </div>
                </div>
                <div class="admin-section">
                    <h3>Herramientas de Sistema</h3>
                    <button class="btn" onclick="backupSystem()">Realizar Backup</button>
                    <button class="btn" onclick="checkSystem()">Verificar Sistema</button>
                    <button class="btn" onclick="systemLogs()">Ver Logs</button>
                    <button class="btn" onclick="limpiarCache()">Limpiar Cache</button>
                    <button class="btn" onclick="optimizarDB()">Optimizar DB</button>
                </div>
                <div class="admin-section">
                    <h3>Configuración</h3>
                    <button class="btn" onclick="configurarSistema()">Configuración General</button>
                    <button class="btn" onclick="gestionarRoles()">Gestionar Roles</button>
                    <button class="btn" onclick="configurarBackups()">Config. Backups</button>
                    <button class="btn" onclick="gestionarLimites()">Límites del Sistema</button>
                </div>
            </div>
        `;
    }

    // Nuevas funciones de administración
    function bloquearUsuario() {
        const usuario = prompt("Ingrese el nombre del usuario a bloquear:");
        if (usuario) {
            alert(`Usuario "${usuario}" bloqueado temporalmente.`);
        }
    }

    function resetearPassword() {
        const usuario = prompt("Ingrese el nombre del usuario:");
        if (usuario) {
            alert(`Contraseña reseteada para "${usuario}". Nueva contraseña enviada por email.`);
        }
    }

    function limpiarCache() {
        if (confirm("¿Está seguro de limpiar la cache del sistema?")) {
            alert("Cache del sistema limpiada correctamente.");
        }
    }

    function optimizarDB() {
        alert("Iniciando optimización de la base de datos...\nEsto puede tomar unos minutos.");
        setTimeout(() => alert("Base de datos optimizada correctamente."), 2000);
    }

    function configurarSistema() {
        openModal('configModal');
    }

    function gestionarRoles() {
        openModal('rolesModal');
    }

    function configurarBackups() {
        openModal('backupConfigModal');
    }

    function gestionarLimites() {
        openModal('limitsModal');
    }

    // Reemplazar todos los event listeners de DOMContentLoaded con uno solo:

document.addEventListener('DOMContentLoaded', function() {
    // 1. Primero limpiar la sesión anterior
    localStorage.removeItem("role");
    localStorage.removeItem("username");
    
    // 2. Ocultar/mostrar las páginas correctas
    document.getElementById("mainPage").style.display = "none";
    document.getElementById("loginPage").style.display = "block";
    
    // 3. Limpiar los campos de login
    document.getElementById("username").value = "";
    document.getElementById("password").value = "";
    
    // 4. Remover cualquier botón existente
    const existingLogoutBtn = document.querySelector('.logout-btn');
    const existingAdminBtn = document.querySelector('.admin-btn');
    if (existingLogoutBtn) existingLogoutBtn.remove();
    if (existingAdminBtn) existingAdminBtn.remove();
    
    // 5. Cargar datos del personaje
    loadCharacter();
});

// Modificar la función login para asegurar el comportamiento correcto
function login() {
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value.trim();
    
    if (!username || !password) {
        alert("Por favor ingrese usuario y contraseña");
        return;
    }

    // Limpiar cualquier sesión existente
    localStorage.removeItem("role");
    localStorage.removeItem("username");

    // Usar email para Firebase (agregar @tudominio.com)
    const email = `${username}@tudominio.com`;
    
    auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
            const user = userCredential.user;
            // Verificar si es admin consultando Firestore
            db.collection('users').doc(user.uid).get()
                .then((doc) => {
                    const userData = doc.data();
                    const isAdmin = userData.role === 'admin';
                    localStorage.setItem("username", username);
                    showMain(isAdmin);
                });
        })
        .catch((error) => {
            alert("Error en la autenticación: " + error.message);
        });
}

// Función para registrar nuevos usuarios
function registrarUsuario() {
    const username = document.getElementById("newUsername").value.trim();
    const password = document.getElementById("newPassword").value.trim();
    const email = `${username}@tudominio.com`;

    auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
            const user = userCredential.user;
            // Guardar datos adicionales en Firestore
            return db.collection('users').doc(user.uid).set({
                username: username,
                role: 'user',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        })
        .then(() => {
            alert("Usuario creado exitosamente");
            // Crear documento para los datos del personaje
            return db.collection('characters').doc(user.uid).set({
                character: character
            });
        })
        .catch((error) => {
            alert("Error al crear usuario: " + error.message);
        });
}

// Modificar showMain para asegurar consistencia
function showMain(isAdmin) {
    // 1. Cambiar visibilidad de las páginas
    document.getElementById("loginPage").style.display = "none";
    document.getElementById("mainPage").style.display = "block";
    
    // 2. Limpiar botones existentes
    const existingLogoutBtn = document.querySelector('.logout-btn');
    const existingAdminBtn = document.querySelector('.admin-btn');
    if (existingLogoutBtn) existingLogoutBtn.remove();
    if (existingAdminBtn) existingAdminBtn.remove();
    
    // 3. Configurar el panel de admin
    document.getElementById("adminPanel").style.display = isAdmin ? "block" : "none";
    
    // 4. Agregar botones necesarios
    const header = document.querySelector('.container');
    
    if (isAdmin) {
        const adminBtn = document.createElement('button');
        adminBtn.className = 'btn admin-btn';
        adminBtn.style.float = 'right';
        adminBtn.style.marginLeft = '10px';
        adminBtn.onclick = showAdminPanel;
        adminBtn.textContent = 'Panel Admin';
        header.insertBefore(adminBtn, header.firstChild);
    }
    
    const logoutBtn = document.createElement('button');
    logoutBtn.className = 'btn logout-btn';
    logoutBtn.style.float = 'right';
    logoutBtn.onclick = logout;
    logoutBtn.textContent = 'Cerrar Sesión';
    header.insertBefore(logoutBtn, header.firstChild);
    
    // 5. Actualizar el estado del juego
    resetAcciones();
    actualizarTodo();
    saveCharacter();
}
  </script>
</body>
</html>
