<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hoja de Personaje RPG - Login y Panel</title>
  <style>
    /* Global Styles */
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 20px;
      font-family: 'Segoe UI', sans-serif;
      background: #eef2f7;
      color: #333;
      line-height: 1.5;
    }
    .container { max-width: 1000px; margin: auto; padding-bottom: 40px; }
    h1, h2, h3 { text-align: center; margin-bottom: 15px; }
    /* Card Component */
    .card {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    /* Form Elements */
    label {
      font-weight: bold;
      margin-bottom: 5px;
      display: block;
      text-align: center;
    }
    input[type="text"],
    input[type="password"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      max-width: 300px;
      padding: 10px;
      margin: 0 auto 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      display: block;
    }
    /* Grid Layout */
    .grid { display: flex; flex-wrap: wrap; gap: 20px; justify-content: space-between; }
    .half { flex: 1 1 45%; min-width: 280px; }
    .full { width: 100%; }
    .stats-grid {
      display: flex; flex-wrap: wrap; justify-content: space-around; gap: 20px; margin-top: 15px;
    }
    .stat {
      background: #f7f9fc;
      border-radius: 8px;
      padding: 15px 20px;
      min-width: 150px;
      text-align: center;
      font-size: 1.1em;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    small { display: block; text-align: center; color: #777; }
    /* Buttons */
    .btn {
      background: #2196F3;
      color: #fff;
      border: none;
      padding: 10px 18px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
      font-size: 0.95em;
      transition: background 0.3s;
    }
    .btn:hover { background: #1976D2; }
    /* Item List */
    .item-list {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 15px;
      background: #f9f9f9;
      min-height: 80px;
    }
    .item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #eee;
      padding: 8px 0;
    }
    .item:last-child { border-bottom: none; }
    /* Combat Panel */
    .combat-panel {
      display: flex; flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 15px;
    }
    .combat-panel > div { flex: 1; min-width: 100px; }
    .combat-buttons { text-align: center; margin-top: 10px; }
    /* Login Form */
    .login-container {
      max-width: 400px;
      margin: 100px auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      text-align: center;
    }
    /* Admin Panel */
    .admin-panel { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 15px; text-align: center; }
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      align-items: center;
      justify-content: center;
      padding: 10px;
    }
    .modal-content {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      width: 100%;
      max-width: 400px;
      position: relative;
      max-height: 80vh;
      overflow-y: auto;
      text-align: center;
    }
    .modal-close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      cursor: pointer;
    }
    /* Fórmula Buttons */
    .formula-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 10px;
      justify-content: center;
    }
    .formula-btn {
      background: #ddd;
      padding: 4px 6px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8em;
    }
    /* Responsive */
    @media (max-width: 600px) {
      .grid { flex-direction: column; align-items: center; }
      .half { width: 100%; }
      .stats-grid { flex-direction: column; align-items: center; }
      .stat { width: 90%; margin-bottom: 10px; }
      .combat-panel { flex-direction: column; align-items: center; }
    }
  </style>
</head>
<body>
  <!-- Login Section -->
  <div id="loginPage" class="login-container">
    <h2>Iniciar Sesión</h2>
    <input type="text" id="username" placeholder="Usuario">
    <input type="password" id="password" placeholder="Contraseña">
    <button class="btn" onclick="login()">Entrar</button>
  </div>

  <!-- Main Content (Hidden by default) -->
  <div id="mainPage" style="display:none;">
    <div class="container">
      <!-- Admin Panel (Visible only to admin) -->
      <div id="adminPanel" class="card" style="display:none;">
        <h2>Panel de Admin</h2>
        <p>Permiso para crear usuarios:</p>
        <button class="btn" onclick="crearUsuario()">Crear Nuevo Usuario</button>
      </div>

      <!-- Datos del Personaje -->
      <div class="card">
        <h1>Hoja de Personaje RPG</h1>
        <div class="grid">
          <div class="half">
            <label for="charName">Nombre</label>
            <input type="text" id="charName" placeholder="Nombre del personaje">
            <label for="charRace">Raza</label>
            <input type="text" id="charRace" placeholder="Raza del personaje">
            <label for="charLang">Idiomas</label>
            <input type="text" id="charLang" placeholder="Ej: Español, Inglés">
            <label for="charPerso">Personalidad</label>
            <input type="text" id="charPerso" placeholder="Personalidad">
          </div>
          <div class="half">
            <label>Imagen</label>
            <div id="imgContainer" style="width:90%; height:220px; border:2px dashed #ccc; display:flex; align-items:center; justify-content:center; cursor:pointer; margin:auto;">
              <span>Click para cargar imagen</span>
            </div>
            <input type="file" id="imgUpload" style="display:none;">
          </div>
        </div>
      </div>

      <!-- Elementos -->
      <div class="card">
        <h2>Elementos</h2>
        <table>
          <thead>
            <tr>
              <th>Fuego</th>
              <th>Aire</th>
              <th>Agua</th>
              <th>Electro</th>
              <th>Tierra</th>
              <th>Luz</th>
              <th>Oscuridad</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><input type="number" id="elemFire" value="10" min="10" max="100"></td>
              <td><input type="number" id="elemAir" value="10" min="10" max="100"></td>
              <td><input type="number" id="elemWater" value="10" min="10" max="100"></td>
              <td><input type="number" id="elemElectro" value="10" min="10" max="100"></td>
              <td><input type="number" id="elemEarth" value="10" min="10" max="100"></td>
              <td><input type="number" id="elemLight" value="10" min="10" max="100"></td>
              <td><input type="number" id="elemDark" value="10" min="10" max="100"></td>
            </tr>
          </tbody>
        </table>
        <small>*1-30: Bajo | 31-70: Estándar | 71-100: Potenciado</small>
      </div>

      <!-- Atributos -->
      <div class="card">
        <h2>Atributos</h2>
        <table>
          <thead>
            <tr>
              <th>Fuerza</th>
              <th>Inteligencia</th>
              <th>Agilidad</th>
              <th>Metabolismo</th>
              <th>A.M</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>
                <input type="number" id="attrFuerza" value="10" min="10">
                <div id="modFuerza">0</div>
              </td>
              <td>
                <input type="number" id="attrInt" value="10" min="10">
                <div id="modInt">0</div>
              </td>
              <td>
                <input type="number" id="attrAgil" value="10" min="10">
                <div id="modAgil">0</div>
              </td>
              <td>
                <input type="number" id="attrMetab" value="10" min="10">
                <div id="modMetab">0</div>
              </td>
              <td>
                <input type="number" id="attrAM" value="10" min="10">
                <div id="modAM">0</div>
              </td>
            </tr>
          </tbody>
        </table>
        <small>Modificador = (Valor - 10) / 2</small>
      </div>

      <!-- Estadísticas -->
      <div class="card">
        <h2>Estadísticas</h2>
        <div class="stats-grid">
          <div class="stat">Vida: <span id="calcVida">0 / 0</span></div>
          <div class="stat">Armadura: <span id="calcArmor">10</span></div>
          <div class="stat">Místyculas: <span id="calcMistyculas">0 / 0</span></div>
          <div class="stat">XP: <span id="calcXP">0 / 0</span></div>
          <div class="stat">Nivel: <span id="calcNivel">1 / 20</span></div>
        </div>
        <div class="stats-input">
          <input type="number" id="inputXP" placeholder="Añadir XP" value="0" min="0" style="width:80px;">
          <button class="btn" onclick="agregarXP()">Añadir XP</button>
        </div>
        <div style="text-align:center;">
          <button class="btn" onclick="resetAcciones()">Nueva Ronda</button>
          <button class="btn" onclick="openModal('editStatsModal')">Editar Estadísticas</button>
        </div>
      </div>

      <!-- Fórmulas Avanzadas -->
      <div class="card" style="text-align:center;">
        <button class="btn" onclick="openModal('formulasModal')">Mostrar Fórmulas Avanzadas</button>
      </div>

      <!-- Acciones & Combate -->
      <div class="card">
        <h2>Acciones & Combate</h2>
        <div id="accionesDisplay" style="text-align:center; font-size:1.1em; margin-bottom:15px;"></div>
        <!-- Panel de Combate -->
        <div class="combat-panel">
          <div><input type="number" id="inputDamage" placeholder="Daño" value="0" min="0"></div>
          <div><input type="number" id="inputHeal" placeholder="Curar" value="0" min="0"></div>
          <div><input type="number" id="inputMistyRegen" placeholder="Recuperar Místyculas" value="0" min="0"></div>
        </div>
        <div class="combat-buttons">
          <button 
            class="btn" 
            onclick="aplicarDaño()" 
            aria-label="Aplicar daño al personaje"
          >
            Aplicar Daño
          </button>
          <button class="btn" onclick="aplicarCura()">Aplicar Cura</button>
          <button class="btn" onclick="regenerarMisty()">Recuperar Místyculas</button>
        </div>
        <hr>
        <div style="text-align:center; margin-top:10px;">
          <p><strong>Aplicar Costos de Acción:</strong></p>
          <button class="btn" onclick="aplicarAccionCompleja()">Acción Compleja (-2)</button>
          <button class="btn" onclick="aplicarAccionMenor()">Acción Menor (-1)</button>
          <button class="btn" onclick="aplicarReaccion()">Reacción (-3)</button>
          <button class="btn" onclick="aplicarAccionObjeto()">Acción Objeto (-1)</button>
          <button class="btn" onclick="aplicarAccionBonus()">Acción Bonus (+1)</button>
          <button class="btn" onclick="aplicarAccionLegendaria()">Acción Legendaria (-10 a -20)</button>
          <button class="btn" onclick="alert('Hablar no cuesta acciones.')">Hablar (0)</button>
        </div>
      </div>

      <!-- Secciones: Habilidades, Hechizos, Mascotas, Objetos -->
      <div class="card">
        <h2>Habilidades</h2>
        <div class="item-list" id="skillsList"></div>
        <div style="text-align:center;">
          <button class="btn" onclick="openModal('skillModal')">Agregar / Editar Habilidad</button>
        </div>
      </div>
      <div class="card">
        <h2>Hechizos</h2>
        <div class="item-list" id="spellsList"></div>
        <div style="text-align:center;">
          <button class="btn" onclick="openModal('spellModal')">Agregar / Editar Hechizo</button>
        </div>
      </div>
      <div class="card">
        <h2>Mascotas</h2>
        <div class="item-list" id="petsList"></div>
        <div style="text-align:center;">
          <button class="btn" onclick="openModal('petModal')">Agregar / Editar Mascota</button>
        </div>
      </div>
      <div class="card">
        <h2>Objetos</h2>
        <div class="item-list" id="itemsList"></div>
        <div style="text-align:center;">
          <button class="btn" onclick="openModal('itemModal')">Agregar / Editar Objeto</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Genérico -->
  <div id="modalOverlay" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal()">×</span>
      <div id="modalBody"></div>
      <button class="btn" id="modalSaveBtn">Guardar</button>
    </div>
  </div>

  <script>
    const DOM = {
      loginPage: document.getElementById('loginPage'),
      mainPage: document.getElementById('mainPage'),
      adminPanel: document.getElementById('adminPanel'),
      // ... otros elementos frecuentemente usados
    };

    const character = {
      attributes: {
        fuerza: 10,
        inteligencia: 10,
        agilidad: 10,
        metabolismo: 10,
        am: 10
      },
      baseHealth: 10,
      currentHealth: 10,
      experience: 0,
      level: 1,
      baseArmor: 10,
      armor: 10,
      baseMistyculas: 10,
      currentMistyculas: 10,
      maxMistyculas: 10,
      actions: { action: 1 },
      skills: [],
      spells: [],
      pets: [],
      items: []
    };

    const expTable = [
      { level: 1, exp: 0 },
      { level: 2, exp: 300 },
      //... hasta nivel 20
    ];

    const EventSystem = {
      events: {},
      on(eventName, callback) {
        if (!this.events[eventName]) {
          this.events[eventName] = [];
        }
        this.events[eventName].push(callback);
      },
      emit(eventName, data) {
        if (this.events[eventName]) {
          this.events[eventName].forEach(callback => callback(data));
        }
      }
    };

    function sanitizeInput(input) {
      return input.replace(/[<>]/g, '').trim();
    }

    // Simple login simulation
    function login() {
      const username = sanitizeInput(document.getElementById("username").value.trim());
      const password = sanitizeInput(document.getElementById("password").value.trim());
      // Hardcoded credentials: admin/admin for admin role
      if(username === "admin" && password === "admin") {
        localStorage.setItem("role", "admin");
        showMain();
      } else if(username && password) {
        localStorage.setItem("role", "user");
        showMain();
      } else {
        alert("Ingrese credenciales válidas.");
      }
    }
    function showMain() {
      document.getElementById("loginPage").style.display = "none";
      document.getElementById("mainPage").style.display = "block";
      resetAcciones();
      actualizarTodo();
      if(localStorage.getItem("role") === "admin"){
        document.getElementById("adminPanel").style.display = "block";
      }
    }
    // Admin function to simulate user creation (dummy function)
    function crearUsuario() {
      let newUser = prompt("Ingrese el nombre del nuevo usuario:");
      if(newUser) { alert("Usuario '" + newUser + "' creado (simulación)."); }
    }

    // Character sheet functions
    function calcularMod(valor) {
      if (typeof valor !== 'number' || isNaN(valor)) {
        console.error('Valor inválido para calcular modificador');
        return 0;
      }
      return Math.floor((valor - 10) / 2);
    }
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    const actualizarAtributosDebounced = debounce(actualizarAtributos, 250);
    function actualizarAtributos() {
      document.getElementById("modFuerza").textContent = calcularMod(character.attributes.fuerza);
      document.getElementById("modInt").textContent = calcularMod(character.attributes.inteligencia);
      document.getElementById("modAgil").textContent = calcularMod(character.attributes.agilidad);
      document.getElementById("modMetab").textContent = calcularMod(character.attributes.metabolismo);
      document.getElementById("modAM").textContent = calcularMod(character.attributes.am);
    }
    function actualizarNivelXP() {
      let lvl = 1, baseXP = 0;
      for(let i = 0; i < expTable.length; i++){
        if(character.experience >= expTable[i].exp){
          lvl = expTable[i].level;
          baseXP = expTable[i].exp;
        } else break;
      }
      character.level = lvl;
      const next = expTable.find(e => e.level === lvl + 1);
      const xpExcess = character.experience - baseXP;
      const xpNeeded = next ? next.exp - baseXP : 0;
      document.getElementById("calcXP").textContent = xpExcess + " / " + xpNeeded;
      document.getElementById("calcNivel").textContent = character.level + " / 20";
    }
    function actualizarVida() {
      const modMet = calcularMod(character.attributes.metabolismo);
      character.maxHealth = Math.floor(character.baseHealth * character.level * (modMet > 0 ? modMet : 1));
      if(character.currentHealth > character.maxHealth) character.currentHealth = character.maxHealth;
      document.getElementById("calcVida").textContent = character.currentHealth + " / " + character.maxHealth;
    }
    function actualizarArmor() {
      const modAgil = calcularMod(character.attributes.agilidad);
      const modMet = calcularMod(character.attributes.metabolismo);
      character.armor = character.baseArmor + modAgil + modMet;
      document.getElementById("calcArmor").textContent = character.armor;
    }
    function actualizarMistyculas() {
      const modInt = calcularMod(character.attributes.inteligencia);
      const modAM = calcularMod(character.attributes.am);
      character.maxMistyculas = character.baseMistyculas * (modInt > 0 ? modInt : 1) * (modAM > 0 ? modAM : 1);
      if(character.currentMistyculas > character.maxMistyculas) character.currentMistyculas = character.maxMistyculas;
      document.getElementById("calcMistyculas").textContent = character.currentMistyculas + " / " + character.maxMistyculas;
    }
    function actualizarAcciones() {
      document.getElementById("accionesDisplay").textContent = "Acciones restantes: " + character.actions.action;
    }
    function resetAcciones() {
      const modAgil = calcularMod(character.attributes.agilidad);
      character.actions.action = character.level + modAgil + 1;
      actualizarAcciones();
    }
    function actualizarTodo() {
      actualizarAtributosDebounced();
      actualizarNivelXP();
      actualizarVida();
      actualizarArmor();
      actualizarMistyculas();
      actualizarAcciones();
    }
    function agregarXP() {
      const xp = parseInt(document.getElementById("inputXP").value);
      if(isNaN(xp) || xp < 0) return;
      character.experience += xp;
      actualizarTodo();
    }
    function aplicarDaño() {
      const dmg = parseInt(document.getElementById("inputDamage").value);
      if(isNaN(dmg) || dmg < 0) return;
      character.currentHealth -= dmg;
      if(character.currentHealth < 0) character.currentHealth = 0;
      actualizarVida();
    }
    function aplicarCura() {
      const cura = parseInt(document.getElementById("inputHeal").value);
      if(isNaN(cura) || cura < 0) return;
      character.currentHealth += cura;
      if(character.currentHealth > character.maxHealth) character.currentHealth = character.maxHealth;
      actualizarVida();
    }
    function regenerarMisty() {
      const regen = parseInt(document.getElementById("inputMistyRegen").value);
      if(isNaN(regen) || regen < 0) return;
      character.currentMistyculas += regen;
      if(character.currentMistyculas > character.maxMistyculas) character.currentMistyculas = character.maxMistyculas;
      actualizarMistyculas();
    }
    // Eventos para atributos
    document.getElementById("attrFuerza").addEventListener("change", () => {
      character.attributes.fuerza = parseInt(document.getElementById("attrFuerza").value);
      actualizarTodo();
    });
    document.getElementById("attrInt").addEventListener("change", () => {
      character.attributes.inteligencia = parseInt(document.getElementById("attrInt").value);
      actualizarTodo();
    });
    document.getElementById("attrAgil").addEventListener("change", () => {
      character.attributes.agilidad = parseInt(document.getElementById("attrAgil").value);
      actualizarTodo();
    });
    document.getElementById("attrMetab").addEventListener("change", () => {
      character.attributes.metabolismo = parseInt(document.getElementById("attrMetab").value);
      actualizarTodo();
    });
    document.getElementById("attrAM").addEventListener("change", () => {
      character.attributes.am = parseInt(document.getElementById("attrAM").value);
      actualizarTodo();
    });
    // Datos del personaje
    document.getElementById("charName").addEventListener("change", function() { character.name = this.value; });
    document.getElementById("charRace").addEventListener("change", function() { character.race = this.value; });
    document.getElementById("charLang").addEventListener("change", function() { character.languages = this.value; });
    document.getElementById("charPerso").addEventListener("change", function() { character.personality = this.value; });
    document.getElementById("imgContainer").addEventListener("click", function() {
      document.getElementById("imgUpload").click();
    });
    document.getElementById("imgUpload").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        character.image = ev.target.result;
        document.getElementById("imgContainer").innerHTML = `<img src="${character.image}" style="width:100%; height:100%; object-fit:cover;">`;
      };
      reader.readAsDataURL(file);
    });
    /* Funciones para aplicar costos de acción */
    function aplicarAccionMenor() {
      if(character.actions.action < 1){ alert("No tienes suficientes acciones."); return; }
      character.actions.action -= 1;
      actualizarAcciones();
    }
    function aplicarReaccion() {
      if(character.actions.action < 3){ alert("No tienes suficientes acciones."); return; }
      character.actions.action -= 3;
      actualizarAcciones();
    }
    function aplicarAccionObjeto() {
      if(character.actions.action < 1){ alert("No tienes suficientes acciones."); return; }
      character.actions.action -= 1;
      actualizarAcciones();
    }
    function aplicarAccionBonus() {
      character.actions.action += 1;
      actualizarAcciones();
    }
    function aplicarAccionLegendaria() {
      let cost = parseInt(prompt("Ingrese el costo para la acción legendaria (entre 10 y 20):"));
      if(isNaN(cost) || cost < 10 || cost > 20){ alert("Costo inválido."); return; }
      if(character.actions.action < cost){ alert("No tienes suficientes acciones."); return; }
      character.actions.action -= cost;
      actualizarAcciones();
    }
    /* Modal Genérico */
    const modalOverlay = document.getElementById("modalOverlay");
    const modalBody = document.getElementById("modalBody");
    const modalSaveBtn = document.getElementById("modalSaveBtn");
    let modalCallback = null;
    function openModal(modalId, itemId = null) {
      modalOverlay.style.display = "flex";
      if(modalId === 'skillModal'){
        let skill = itemId ? character.skills.find(s => s.id === itemId) : null;
        modalBody.innerHTML = `
          <h3>${ skill ? "Editar" : "Crear" } Habilidad</h3>
          <label>Nombre:</label>
          <input type="text" id="modalSkillName" placeholder="Nombre" value="${ skill ? skill.name : "" }">
          <label>Descripción:</label>
          <textarea id="modalSkillDesc" placeholder="Descripción">${ skill ? skill.desc : "" }</textarea>
          <label>Fórmula:</label>
          <input type="text" id="modalSkillFormula" placeholder="Ej: Fuerza d InteligenciaMod+2" value="${ skill ? skill.formula : "" }">
          <div class="formula-buttons">
            <div class="formula-btn" onclick="insertFormula('Fuerza', 'modalSkillFormula')">Fuerza</div>
            <div class="formula-btn" onclick="insertFormula('Inteligencia', 'modalSkillFormula')">Inteligencia</div>
            <div class="formula-btn" onclick="insertFormula('Agilidad', 'modalSkillFormula')">Agilidad</div>
            <div class="formula-btn" onclick="insertFormula('Metabolismo', 'modalSkillFormula')">Metabolismo</div>
            <div class="formula-btn" onclick="insertFormula('A.M', 'modalSkillFormula')">A.M</div>
            <div class="formula-btn" onclick="insertFormula('FuerzaMod', 'modalSkillFormula')">FuerzaMod</div>
            <div class="formula-btn" onclick="insertFormula('InteligenciaMod', 'modalSkillFormula')">InteligenciaMod</div>
            <div class="formula-btn" onclick="insertFormula('AgilidadMod', 'modalSkillFormula')">AgilidadMod</div>
            <div class="formula-btn" onclick="insertFormula('MetabolismoMod', 'modalSkillFormula')">MetabolismoMod</div>
            <div class="formula-btn" onclick="insertFormula('AMMod', 'modalSkillFormula')">AMMod</div>
            <div class="formula-btn" onclick="insertFormula('Mistyculas', 'modalSkillFormula')">Mistyculas</div>
            <div class="formula-btn" onclick="insertFormula('Armadura', 'modalSkillFormula')">Armadura</div>
            <div class="formula-btn" onclick="insertFormula('VidaBase', 'modalSkillFormula')">VidaBase</div>
            <div class="formula-btn" onclick="insertFormula('VidaActual', 'modalSkillFormula')">VidaActual</div>
            <div class="formula-btn" onclick="insertFormula(' d ', 'modalSkillFormula')">d</div>
            <div class="formula-btn" onclick="insertFormula('+', 'modalSkillFormula')">+</div>
            <div class="formula-btn" onclick="insertFormula('-', 'modalSkillFormula')">-</div>
            <div class="formula-btn" onclick="insertFormula('*', 'modalSkillFormula')">*</div>
            <div class="formula-btn" onclick="insertFormula('/', 'modalSkillFormula')">/</div>
            <div class="formula-btn" onclick="insertFormula('(', 'modalSkillFormula')">(</div>
            <div class="formula-btn" onclick="insertFormula(')', 'modalSkillFormula')">)</div>
          </div>
          <label>Costo de Acción:</label>
          <input type="number" id="modalSkillActionCost" value="${ skill ? skill.actionCost : 1 }" min="0">
          <label>Costo de Místyculas:</label>
          <input type="number" id="modalSkillMistyCost" value="${ skill ? skill.mistyCost : 0 }" min="0">
        `;
        modalCallback = function() {
          const newSkill = {
            id: skill ? skill.id : Date.now().toString(),
            name: document.getElementById("modalSkillName").value,
            desc: document.getElementById("modalSkillDesc").value,
            formula: document.getElementById("modalSkillFormula").value,
            actionCost: parseInt(document.getElementById("modalSkillActionCost").value),
            mistyCost: parseInt(document.getElementById("modalSkillMistyCost").value),
          };
          if(skill){
            const index = character.skills.findIndex(s => s.id === skill.id);
            character.skills[index] = newSkill;
          } else {
            character.skills.push(newSkill);
          }
          renderList('skillsList', character.skills);
        };
      }
      else if(modalId === 'spellModal'){
        let spell = itemId ? character.spells.find(s => s.id === itemId) : null;
        modalBody.innerHTML = `
          <h3>${ spell ? "Editar" : "Crear" } Hechizo</h3>
          <label>Nombre:</label>
          <input type="text" id="modalSpellName" placeholder="Nombre" value="${ spell ? spell.name : "" }">
          <label>Descripción:</label>
          <textarea id="modalSpellDesc" placeholder="Descripción">${ spell ? spell.desc : "" }</textarea>
          <label>Fórmula:</label>
          <input type="text" id="modalSpellFormula" placeholder="Ej: 1d10+Inteligencia" value="${ spell ? spell.formula : "" }">
          <div class="formula-buttons">
            <div class="formula-btn" onclick="insertFormula('Fuerza', 'modalSpellFormula')">Fuerza</div>
            <div class="formula-btn" onclick="insertFormula('Inteligencia', 'modalSpellFormula')">Inteligencia</div>
            <div class="formula-btn" onclick="insertFormula('Agilidad', 'modalSpellFormula')">Agilidad</div>
            <div class="formula-btn" onclick="insertFormula('Metabolismo', 'modalSpellFormula')">Metabolismo</div>
            <div class="formula-btn" onclick="insertFormula('A.M', 'modalSpellFormula')">A.M</div>
            <div class="formula-btn" onclick="insertFormula('FuerzaMod', 'modalSpellFormula')">FuerzaMod</div>
            <div class="formula-btn" onclick="insertFormula('InteligenciaMod', 'modalSpellFormula')">InteligenciaMod</div>
            <div class="formula-btn" onclick="insertFormula('AgilidadMod', 'modalSpellFormula')">AgilidadMod</div>
            <div class="formula-btn" onclick="insertFormula('MetabolismoMod', 'modalSpellFormula')">MetabolismoMod</div>
            <div class="formula-btn" onclick="insertFormula('AMMod', 'modalSpellFormula')">AMMod</div>
            <div class="formula-btn" onclick="insertFormula('Mistyculas', 'modalSpellFormula')">Mistyculas</div>
            <div class="formula-btn" onclick="insertFormula('Armadura', 'modalSpellFormula')">Armadura</div>
            <div class="formula-btn" onclick="insertFormula('VidaBase', 'modalSpellFormula')">VidaBase</div>
            <div class="formula-btn" onclick="insertFormula('VidaActual', 'modalSpellFormula')">VidaActual</div>
            <div class="formula-btn" onclick="insertFormula(' d ', 'modalSpellFormula')">d</div>
            <div class="formula-btn" onclick="insertFormula('+', 'modalSpellFormula')">+</div>
            <div class="formula-btn" onclick="insertFormula('-', 'modalSpellFormula')">-</div>
            <div class="formula-btn" onclick="insertFormula('*', 'modalSpellFormula')">*</div>
            <div class="formula-btn" onclick="insertFormula('/', 'modalSpellFormula')">/</div>
            <div class="formula-btn" onclick="insertFormula('(', 'modalSpellFormula')">(</div>
            <div class="formula-btn" onclick="insertFormula(')', 'modalSpellFormula')">)</div>
          </div>
          <label>Costo de Acción:</label>
          <input type="number" id="modalSpellActionCost" value="${ spell ? spell.actionCost : 1 }" min="0">
          <label>Costo de Místyculas:</label>
          <input type="number" id="modalSpellMistyCost" value="${ spell ? spell.mistyCost : 0 }" min="0">
        `;
        modalCallback = function() {
          const newSpell = {
            id: spell ? spell.id : Date.now().toString(),
            name: document.getElementById("modalSpellName").value,
            desc: document.getElementById("modalSpellDesc").value,
            formula: document.getElementById("modalSpellFormula").value,
            actionCost: parseInt(document.getElementById("modalSpellActionCost").value),
            mistyCost: parseInt(document.getElementById("modalSpellMistyCost").value),
          };
          if(spell){
            const index = character.spells.findIndex(s => s.id === spell.id);
            character.spells[index] = newSpell;
          } else {
            character.spells.push(newSpell);
          }
          renderList('spellsList', character.spells);
        };
      }
      else if(modalId === 'petModal'){
        let pet = itemId ? character.pets.find(p => p.id === itemId) : null;
        modalBody.innerHTML = `
          <h3>${ pet ? "Editar" : "Crear" } Mascota</h3>
          <label>Nombre:</label>
          <input type="text" id="modalPetName" placeholder="Nombre" value="${ pet ? pet.name : "" }">
          <label>Tipo:</label>
          <input type="text" id="modalPetType" placeholder="Tipo" value="${ pet ? pet.type : "" }">
          <label>Imagen:</label>
          <input type="file" id="modalPetImage">
        `;
        modalCallback = function() {
          let newPet = {
            id: pet ? pet.id : Date.now().toString(),
            name: document.getElementById("modalPetName").value,
            type: document.getElementById("modalPetType").value,
            image: pet ? pet.image : null,
          };
          const file = document.getElementById("modalPetImage").files[0];
          if(file){
            const reader = new FileReader();
            reader.onload = function(ev){
              newPet.image = ev.target.result;
              if(pet){
                const index = character.pets.findIndex(p => p.id === pet.id);
                character.pets[index] = newPet;
              } else {
                character.pets.push(newPet);
              }
              renderList('petsList', character.pets);
            }
            reader.readAsDataURL(file);
          } else {
            if(pet){
              const index = character.pets.findIndex(p => p.id === pet.id);
              character.pets[index] = newPet;
            } else {
              character.pets.push(newPet);
            }
            renderList('petsList', character.pets);
          }
        };
      }
      else if(modalId === 'itemModal'){
        let itemObj = itemId ? character.items.find(i => i.id === itemId) : null;
        modalBody.innerHTML = `
          <h3>${ itemObj ? "Editar" : "Crear" } Objeto</h3>
          <label>Nombre:</label>
          <input type="text" id="modalItemName" placeholder="Nombre" value="${ itemObj ? itemObj.name : "" }">
          <label>Tipo:</label>
          <input type="text" id="modalItemType" placeholder="Tipo" value="${ itemObj ? itemObj.type : "" }">
          <label>Efectos:</label>
          <textarea id="modalItemEffects" placeholder="Efectos">${ itemObj ? itemObj.effects : "" }</textarea>
        `;
        modalCallback = function() {
          const newItem = {
            id: itemObj ? itemObj.id : Date.now().toString(),
            name: document.getElementById("modalItemName").value,
            type: document.getElementById("modalItemType").value,
            effects: document.getElementById("modalItemEffects").value,
          };
          if(itemObj){
            const index = character.items.findIndex(i => i.id === itemObj.id);
            character.items[index] = newItem;
          } else {
            character.items.push(newItem);
          }
          renderList('itemsList', character.items);
        };
      }
      else if(modalId === 'formulasModal'){
        const modFuerza = calcularMod(character.attributes.fuerza);
        const modInt = calcularMod(character.attributes.inteligencia);
        const modAgil = calcularMod(character.attributes.agilidad);
        const modMetab = calcularMod(character.attributes.metabolismo);
        const modAM = calcularMod(character.attributes.am);
        const movimiento = (modFuerza + modAgil) * 10;
        const carga = (modMetab + modFuerza) * 10;
        const acciones = character.level + modAgil + 1;
        const resistencia = character.level + modMetab;
        const tamano = modMetab * 10;
        const altura = tamano * 10;
        const peso = tamano * 5;
        const vida = character.baseHealth * character.level * (modMetab > 0 ? modMetab : 1);
        const sabiduria = modInt + character.level;
        const misty = character.baseMistyculas * (modInt > 0 ? modInt : 1) * (modAM > 0 ? modAM : 1);
        const regenMisty = character.level + character.attributes.inteligencia + character.attributes.am;
        const regenVida = character.level + character.attributes.metabolismo + character.attributes.am;
        modalBody.innerHTML = `
          <h3>Fórmulas Avanzadas</h3>
          <p><strong>Daño Cuerpo a Cuerpo:</strong> Arma + Fuerza</p>
          <p><strong>Movimiento:</strong> (Fuerza mod + Agilidad mod) × 10 = ${movimiento} pies</p>
          <p><strong>Carga:</strong> (Metabolismo mod + Fuerza mod) × 10 = ${carga} libras</p>
          <p><strong>Armadura:</strong> 10 + (Agilidad mod + Metabolismo mod) = ${character.baseArmor + modAgil + modMetab}</p>
          <p><strong>Acciones:</strong> Nivel + Agilidad mod + 1 = ${acciones}</p>
          <p><strong>Resistencia a Efectos:</strong> Nivel + Metabolismo mod = ${resistencia}</p>
          <p><strong>Tamaño:</strong> Metabolismo mod × 10 = ${tamano} | Altura = ${altura} cm | Peso = ${peso} kg</p>
          <p><strong>Vida:</strong> Vida Base × (Metabolismo mod > 0 ? Metabolismo mod : 1) × Nivel = ${vida}</p>
          <p><strong>Sabiduría:</strong> Inteligencia mod + Nivel = ${sabiduria}</p>
          <p><strong>Mistyculas:</strong> Mistyculas Base × (Inteligencia mod > 0 ? Inteligencia mod : 1) × (A.M mod > 0 ? A.M mod : 1) = ${misty}</p>
          <p><strong>Regeneración de Místyculas:</strong> Nivel + Inteligencia + A.M = ${regenMisty}</p>
          <p><strong>Regeneración de Vida:</strong> Nivel + Metabolismo + A.M = ${regenVida}</p>
        `;
        modalCallback = null;
      }
      else if(modalId === 'editStatsModal'){
        modalBody.innerHTML = `
          <h3>Editar Estadísticas</h3>
          <label>Vida Base:</label>
          <input type="number" id="modalBaseHealth" value="${character.baseHealth}">
          <label>Vida Actual:</label>
          <input type="number" id="modalCurrentHealth" value="${character.currentHealth}">
          <label>XP Actual:</label>
          <input type="number" id="modalXP" value="${character.experience}">
          <label>Mistyculas Base:</label>
          <input type="number" id="modalBaseMisty" value="${character.baseMistyculas}">
          <label>Mistyculas Actuales:</label>
          <input type="number" id="modalCurrentMisty" value="${character.currentMistyculas}">
          <label>Armadura Base:</label>
          <input type="number" id="modalArmorBase" value="${character.baseArmor}">
        `;
        modalCallback = function() {
          character.baseHealth = parseInt(document.getElementById("modalBaseHealth").value);
          character.currentHealth = parseInt(document.getElementById("modalCurrentHealth").value);
          character.experience = parseInt(document.getElementById("modalXP").value);
          character.baseMistyculas = parseInt(document.getElementById("modalBaseMisty").value);
          character.currentMistyculas = parseInt(document.getElementById("modalCurrentMisty").value);
          character.baseArmor = parseInt(document.getElementById("modalArmorBase").value);
          actualizarTodo();
        };
      }
    }
    function closeModal() {
      modalOverlay.style.display = "none";
      modalBody.innerHTML = "";
      modalCallback = null;
    }
    modalSaveBtn.addEventListener("click", function() {
      if(modalCallback) modalCallback();
      closeModal();
    });
    function insertFormula(text, inputId) {
      const input = document.getElementById(inputId);
      input.value += text;
    }
    function renderList(elementId, list) {
      const container = document.getElementById(elementId);
      container.innerHTML = "";
      if(list.length === 0){ container.innerHTML = "<p>No hay elementos.</p>"; return; }
      list.forEach(item => {
        const div = document.createElement("div");
        div.className = "item";
        let extra = "";
        if(item.formula)
          extra = " | Fórmula: " + item.formula;
        else if(item.type && !item.formula)
          extra = " (" + item.type + ")";
        if(item.image)
          extra += `<br><img src="${item.image}" alt="Mascota" style="max-width:100px; margin-top:5px;">`;
        div.innerHTML = `<span><strong>${item.name}</strong>${item.desc ? " - " + item.desc : ""}${extra}</span>
          <div>
            <button class="btn" onclick="editarItem('${elementId}', '${item.id}')">Editar</button>
            <button class="btn" onclick="eliminarItem('${elementId}', '${item.id}')">Eliminar</button>
            ${(elementId==='skillsList' || elementId==='spellsList')
              ? `<button class="btn" onclick="usarItem('${elementId}', '${item.id}')">Usar</button>`
              : ""}
          </div>`;
        container.appendChild(div);
      });
    }
    function eliminarItem(listId, id) {
      if(listId === "skillsList"){
        character.skills = character.skills.filter(s => s.id !== id);
        renderList(listId, character.skills);
      } else if(listId === "spellsList"){
        character.spells = character.spells.filter(s => s.id !== id);
        renderList(listId, character.spells);
      } else if(listId === "petsList"){
        character.pets = character.pets.filter(p => p.id !== id);
        renderList(listId, character.pets);
      } else if(listId === "itemsList"){
        character.items = character.items.filter(i => i.id !== id);
        renderList(listId, character.items);
      }
    }
    function editarItem(listId, id) {
      if(listId === "skillsList"){ openModal('skillModal', id); }
      else if(listId === "spellsList"){ openModal('spellModal', id); }
      else if(listId === "petsList"){ openModal('petModal', id); }
      else if(listId === "itemsList"){ openModal('itemModal', id); }
    }
    function usarItem(listId, id) {
      if(listId === "skillsList"){
        const skill = character.skills.find(s => s.id === id);
        if(character.currentMistyculas < skill.mistyCost){ alert("No tienes suficientes místyculas."); return; }
        if(character.actions.action < skill.actionCost){ alert("No tienes suficientes acciones."); return; }
        character.currentMistyculas -= skill.mistyCost;
        character.actions.action -= skill.actionCost;
        actualizarMistyculas();
        actualizarAcciones();
        const resultado = eval(skill.formula);
        alert("Habilidad usada: " + skill.name + "\nResultado: " + resultado);
      } else if(listId === "spellsList"){
        const spell = character.spells.find(s => s.id === id);
        if(character.currentMistyculas < spell.mistyCost){ alert("No tienes suficientes místyculas."); return; }
        if(character.actions.action < spell.actionCost){ alert("No tienes suficientes acciones."); return; }
        character.currentMistyculas -= spell.mistyCost;
        character.actions.action -= spell.actionCost;
        actualizarMistyculas();
        actualizarAcciones();
        const resultado = eval(spell.formula);
        alert("Hechizo lanzado: " + spell.name + "\nResultado: " + resultado);
      }
    }

    function guardarEstadoPersonaje() {
      localStorage.setItem('characterState', JSON.stringify(character));
    }

    function cargarEstadoPersonaje() {
      const savedState = localStorage.getItem('characterState');
      if (savedState) {
        Object.assign(character, JSON.parse(savedState));
        actualizarTodo();
      }
    }

    function showLoadingState(element) {
      element.classList.add('loading');
      element.disabled = true;
    }

    function hideLoadingState(element) {
      element.classList.remove('loading');
      element.disabled = false;
    }

    function mostrarError(mensaje, tipo = 'error') {
      const errorDiv = document.createElement('div');
      errorDiv.className = `alert alert-${tipo}`;
      errorDiv.setAttribute('role', 'alert');
      errorDiv.textContent = mensaje;
      document.querySelector('.container').prepend(errorDiv);
      setTimeout(() => errorDiv.remove(), 5000);
    }
  </script>
</body>
</html>